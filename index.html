<!DOCTYPE html>
<html lang="tr">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FişMatik - Akıllı Müşteri Paneli</title>

    <!-- GEREKLİ KÜTÜPHANELER (CDN) -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <!-- PDF Oluşturucu -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: { sans: ['Inter', 'sans-serif'] },
                    colors: {
                        primary: '#2563eb',
                        secondary: '#1e293b',
                        ai: '#8b5cf6',
                    }
                }
            }
        }
    </script>
    <style>
        body {
            background-color: #f8fafc;
        }

        .glass-panel {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border: 1px solid #e2e8f0;
        }

        .loading-spin {
            animation: spin 1s linear infinite;
        }

        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        ::-webkit-scrollbar-track {
            background: #f1f1f1;
        }

        ::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #94a3b8;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        .ai-glow {
            box-shadow: 0 0 15px rgba(139, 92, 246, 0.3);
        }

        .markdown-body ul {
            list-style-type: disc;
            margin-left: 1.5rem;
            margin-top: 0.5rem;
        }

        .markdown-body strong {
            color: #4b5563;
            font-weight: 700;
        }

        .markdown-body p {
            margin-bottom: 0.75rem;
        }

        .image-container {
            transition: transform 0.2s ease-out;
        }

        /* Rapor Yazdırma Stilleri */
        .report-page {
            background: white;
            padding: 40px;
            margin-bottom: 20px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            max-width: 210mm;
            /* A4 Genişliği */
            margin-left: auto;
            margin-right: auto;
        }
    </style>
</head>

<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo, useCallback, useRef } = React;
        const { createClient } = supabase;

        // --- AYARLAR ---
        const DEFAULT_SB_URL = "https://hequoxateionmtfjzkxl.supabase.co";
        const DEFAULT_SB_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImhlcXVveGF0ZWlvbm10Zmp6a3hsIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjUyNTg5MDAsImV4cCI6MjA4MDgzNDkwMH0.aIiIdWw2l7Kcqa4BavNJQ8ARZrdPnmxD8qSMpTlXYhA";

        const WEBHOOKS = {
            REPORT: { TEST: "https://n8n.ittyazilim.com/webhook-test/fismatik", PROD: "https://n8n.ittyazilim.com/webhook/fismatik" },
            RESET_PW: { TEST: "https://n8n.ittyazilim.com/webhook-test/3eafd39c-fdee-406f-88ef-1b9ab4bd555e", PROD: "https://n8n.ittyazilim.com/webhook/3eafd39c-fdee-406f-88ef-1b9ab4bd555e" },
            REGISTER: { TEST: "https://n8n.ittyazilim.com/webhook-test/030dfb1b-49f9-4dc8-82e3-98b884f3065c", PROD: "https://n8n.ittyazilim.com/webhook/030dfb1b-49f9-4dc8-82e3-98b884f3065c" },
            ADD_USER: { TEST: "https://n8n.ittyazilim.com/webhook-test/alt-kullanici-ekle", PROD: "https://n8n.ittyazilim.com/webhook/alt-kullanici-ekle" },
            DELETE_USER: { TEST: "https://n8n.ittyazilim.com/webhook-test/kullanici-sil", PROD: "https://n8n.ittyazilim.com/webhook/kullanici-sil" }
        };

        const sb = createClient(DEFAULT_SB_URL, DEFAULT_SB_KEY);

        const Icon = ({ name, size = 20, className }) => {
            const icon = lucide.icons[name] || lucide.icons['help-circle'];
            const svg = icon.toSvg({
                width: size,
                height: size,
                class: className,
                'stroke-width': 2
            });
            return <span className="inline-flex items-center justify-center lucide-icon-wrapper" dangerouslySetInnerHTML={{ __html: svg }} />;
        };

        // --- YARDIMCI FONKSİYONLAR ---
        const normalizePhone = (phone) => {
            if (!phone) return "";
            let clean = phone.replace(/\D/g, '');
            if (clean.startsWith('0')) clean = clean.substring(1);
            if (clean.startsWith('90') && clean.length > 10) clean = clean.substring(2);
            if (clean.length === 10) return "+90" + clean;
            return "+" + clean;
        };

        const callGemini = async (apiKey, prompt) => {
            const url = `https://generativelanguage.googleapis.com/v1/models/gemini-1.5-flash:generateContent?key=${apiKey}`;
            const response = await fetch(url, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
            });
            const data = await response.json();
            if (data.error) throw new Error(data.error.message);
            return data.candidates?.[0]?.content?.parts?.[0]?.text || "Yanıt alınamadı.";
        };

        // --- BİLEŞENLER ---
        // --- LOGIN BİLEŞENİ ---
        const Login = ({ onLogin }) => {
            const [email, setEmail] = useState('');
            const [password, setPassword] = useState('');
            const [loading, setLoading] = useState(false);
            const [error, setError] = useState(null);

            const handleLogin = async (e) => {
                e.preventDefault();
                setLoading(true);
                setError(null);
                try {
                    const { data, error: authError } = await sb.auth.signInWithPassword({ email, password });
                    if (authError) throw authError;
                    onLogin(data.user);
                } catch (err) {
                    setError(err.message === "Invalid login credentials" ? "E-posta veya şifre hatalı." : err.message);
                } finally {
                    setLoading(false);
                }
            };

            return (
                <div className="min-h-screen flex items-center justify-center bg-slate-50 p-4">
                    <div className="max-w-md w-full bg-white rounded-2xl shadow-xl overflow-hidden border border-slate-200 animate-in fade-in zoom-in duration-300">
                        <div className="bg-primary p-8 text-center text-white">
                            <div className="flex justify-center mb-4">
                                <div className="p-3 bg-white/20 rounded-full backdrop-blur-sm">
                                    <Icon name="receipt" size={40} />
                                </div>
                            </div>
                            <h1 className="text-2xl font-bold">FişMatik</h1>
                            <p className="text-blue-100 mt-2">Akıllı Müşteri Paneli Girişi</p>
                        </div>
                        <form onSubmit={handleLogin} className="p-8 space-y-5">
                            {error && (
                                <div className="bg-red-50 text-red-600 p-3 rounded-lg text-sm border border-red-100 flex items-center gap-2">
                                    <Icon name="alert-circle" size={16} /> {error}
                                </div>
                            )}
                            <div className="space-y-1">
                                <label className="text-sm font-medium text-slate-700">E-Posta</label>
                                <div className="relative">
                                    <Icon name="mail" size={18} className="absolute left-3 top-3 text-slate-400" />
                                    <input
                                        type="email"
                                        required
                                        className="w-full pl-10 pr-4 py-2 border rounded-lg focus:ring-2 focus:ring-primary/20 focus:border-primary outline-none transition"
                                        placeholder="admin@sirket.com"
                                        value={email}
                                        onChange={e => setEmail(e.target.value)}
                                    />
                                </div>
                            </div>
                            <div className="space-y-1">
                                <label className="text-sm font-medium text-slate-700">Şifre</label>
                                <div className="relative">
                                    <Icon name="lock" size={18} className="absolute left-3 top-3 text-slate-400" />
                                    <input
                                        type="password"
                                        required
                                        className="w-full pl-10 pr-4 py-2 border rounded-lg focus:ring-2 focus:ring-primary/20 focus:border-primary outline-none transition"
                                        placeholder="••••••••"
                                        value={password}
                                        onChange={e => setPassword(e.target.value)}
                                    />
                                </div>
                            </div>
                            <button
                                type="submit"
                                disabled={loading}
                                className="w-full bg-primary text-white py-3 rounded-lg font-bold hover:bg-blue-700 transition flex items-center justify-center gap-2 disabled:opacity-50"
                            >
                                {loading ? <Icon name="loader-2" className="animate-spin" size={20} /> : "Giriş Yap"}
                            </button>
                        </form>
                        <div className="p-6 bg-slate-50 text-center border-t border-slate-100">
                            <p className="text-xs text-slate-500">2025 İTT Yazılım &copy; Tüm hakları saklıdır.</p>
                        </div>
                    </div>
                </div>
            );
        };

        // --- SETTINGS BİLEŞENİ ---
        const Settings = ({ user, profile }) => {
            const [geminiKey, setGeminiKey] = useState(localStorage.getItem('fismatik_gemini_key') || '');
            const [isSaved, setIsSaved] = useState(false);

            const saveGeminiKey = () => {
                localStorage.setItem('fismatik_gemini_key', geminiKey);
                setIsSaved(true);
                setTimeout(() => setIsSaved(false), 2000);
            };

            return (
                <div className="max-w-4xl mx-auto py-8">
                    <h2 className="text-2xl font-bold text-slate-800 mb-8 border-b pb-4">Hesap ve Uygulama Ayarları</h2>

                    <div className="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
                        <div className="bg-white p-6 rounded-xl border border-slate-200 shadow-sm">
                            <div className="flex items-center gap-2 mb-4 text-slate-800 border-b pb-2">
                                <Icon name="user" size={20} className="text-primary" /> <h3 className="font-bold">Profil Bilgileri</h3>
                            </div>
                            <div className="space-y-4">
                                <div><p className="text-xs text-slate-500">Ad Soyad</p><p className="font-medium">{profile?.full_name || '-'}</p></div>
                                <div><p className="text-xs text-slate-500">E-Posta</p><p className="font-medium">{user?.email}</p></div>
                                <div><p className="text-xs text-slate-500">Yetki Seviyesi</p><span className={`inline-block px-2 py-1 rounded text-xs mt-1 ${profile?.role === 'admin' ? 'bg-purple-100 text-purple-700' : 'bg-blue-100 text-blue-700'}`}>{profile?.role === 'admin' ? 'Yönetici' : 'Personel'}</span></div>
                            </div>
                        </div>

                        <div className="bg-white p-6 rounded-xl border border-slate-200 shadow-sm">
                            <div className="flex items-center gap-2 mb-4 text-slate-800 border-b pb-2">
                                <Icon name="sparkles" size={20} className="text-ai" /> <h3 className="font-bold">Yapay Zeka (Gemini)</h3>
                            </div>
                            <div className="space-y-4">
                                <p className="text-xs text-slate-500 leading-relaxed">
                                    Harcama analizleri ve tasarruf önerileri almak için Google AI Studio'dan aldığınız API anahtarını buraya girin.
                                </p>
                                <div className="space-y-2">
                                    <input
                                        type="password"
                                        placeholder="AI_STUDIO_API_KEY"
                                        className="w-full p-2 border rounded text-sm"
                                        value={geminiKey}
                                        onChange={e => setGeminiKey(e.target.value)}
                                    />
                                    <button
                                        onClick={saveGeminiKey}
                                        className="w-full bg-slate-800 text-white py-2 rounded text-sm hover:bg-slate-900 transition flex items-center justify-center gap-2"
                                    >
                                        <Icon name={isSaved ? "check" : "save"} size={16} /> {isSaved ? "Kaydedildi" : "Kaydet"}
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div className="space-y-6">
                        <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <MetadataSettings companyId={profile?.company_id} type="categories" title="Kategoriler" icon="tag" />
                            <MetadataSettings companyId={profile?.company_id} type="projects" title="Projeler" icon="folder" />
                        </div>
                        <MetadataSettings companyId={profile?.company_id} type="company_cards" title="Şirket Kredi Kartları" icon="credit-card" />
                    </div>
                </div>
            );
        };

        // Not: Bileşenler "Bağımlılık Sırasına" göre dizilmiştir. 
        // Login bileşeni App'ten önce tanımlanmalıdır.

        const StatCard = ({ title, value, icon, color, bg }) => (
            <div className="bg-white p-6 rounded-xl border border-slate-200 shadow-sm flex items-center gap-4">
                <div className={`p-4 rounded-full ${bg} ${color}`}><Icon name={icon} size={24} /></div>
                <div><p className="text-slate-500 text-sm font-medium">{title}</p><p className="text-2xl font-bold text-slate-800">{value}</p></div>
            </div>
        );

        const DatabaseFix = () => {
            const sql = `-- BU KODU SUPABASE > SQL EDITOR EKRANINA YAPIŞTIRIN VE ÇALIŞTIRIN (RUN)

GRANT USAGE ON SCHEMA public TO postgres, anon, authenticated, service_role;
GRANT ALL ON ALL TABLES IN SCHEMA public TO postgres, anon, authenticated, service_role;
GRANT ALL ON ALL SEQUENCES IN SCHEMA public TO postgres, anon, authenticated, service_role;
GRANT ALL ON ALL FUNCTIONS IN SCHEMA public TO postgres, anon, authenticated, service_role;

DO $$ 
BEGIN
  IF EXISTS (SELECT 1 FROM pg_constraint WHERE conname = 'fk_fisler_users') THEN
    ALTER TABLE public.fisler DROP CONSTRAINT fk_fisler_users;
  END IF;
  IF EXISTS (SELECT 1 FROM pg_constraint WHERE conname = 'fisler_user_id_fkey') THEN
    ALTER TABLE public.fisler DROP CONSTRAINT fisler_user_id_fkey;
  END IF;
END $$;

ALTER TABLE public.fisler 
ADD CONSTRAINT fk_fisler_users 
FOREIGN KEY (user_id) 
REFERENCES public.users (id) 
ON DELETE CASCADE 
ON UPDATE CASCADE;

UPDATE public.users
SET id = au.id
FROM auth.users au
WHERE public.users.email = au.email
AND public.users.id != au.id;

CREATE OR REPLACE FUNCTION public.get_current_user_company_id()
RETURNS bigint
LANGUAGE plpgsql
SECURITY DEFINER
SET search_path = public
AS $$
DECLARE
  c_id bigint;
BEGIN
  SELECT company_id INTO c_id FROM public.users WHERE id = auth.uid();
  IF c_id IS NULL THEN
    SELECT u.company_id INTO c_id 
    FROM public.users u
    JOIN auth.users au ON u.email = au.email
    WHERE au.id = auth.uid();
  END IF;
  RETURN c_id;
END;
$$;

ALTER TABLE public.users ENABLE ROW LEVEL SECURITY;
ALTER TABLE public.companies ENABLE ROW LEVEL SECURITY;
ALTER TABLE public.categories ENABLE ROW LEVEL SECURITY;
ALTER TABLE public.projects ENABLE ROW LEVEL SECURITY;
ALTER TABLE public.company_cards ENABLE ROW LEVEL SECURITY;
ALTER TABLE public.fisler ENABLE ROW LEVEL SECURITY;
ALTER TABLE public.companies ENABLE ROW LEVEL SECURITY;

DROP POLICY IF EXISTS "Kategorileri yönet" ON public.categories;
DROP POLICY IF EXISTS "Projeleri yönet" ON public.projects;
DROP POLICY IF EXISTS "Kartları yönet" ON public.company_cards;
DROP POLICY IF EXISTS "Fişleri yönet" ON public.fisler;
DROP POLICY IF EXISTS "Şirketim" ON public.companies;
DROP POLICY IF EXISTS "Kullanıcılar kendi profillerini görebilir" ON public.users;
DROP POLICY IF EXISTS "Ekip arkadaşlarını gör" ON public.users;

CREATE POLICY "Ekip arkadaşlarını gör" ON public.users FOR SELECT USING (
  id = auth.uid() OR company_id = get_current_user_company_id()
);

CREATE POLICY "Kategorileri yönet" ON public.categories FOR ALL USING (company_id = get_current_user_company_id());
CREATE POLICY "Projeleri yönet" ON public.projects FOR ALL USING (company_id = get_current_user_company_id());
CREATE POLICY "Kartları yönet" ON public.company_cards FOR ALL USING (company_id = get_current_user_company_id());
CREATE POLICY "Fişleri yönet" ON public.fisler FOR ALL USING (company_id = get_current_user_company_id());
CREATE POLICY "Şirketim" ON public.companies FOR SELECT USING (id = get_current_user_company_id());`;

            const copySql = () => {
                const textArea = document.createElement("textarea");
                textArea.value = sql;
                textArea.style.position = "fixed";
                textArea.style.left = "-9999px";
                textArea.style.top = "0";
                document.body.appendChild(textArea);
                textArea.focus();
                textArea.select();

                try {
                    const successful = document.execCommand('copy');
                    if (successful) {
                        alert("GÜÇLÜ ONARIM KODU KOPYALANDI!\n\nLütfen Supabase > SQL Editor'de çalıştırın.");
                    } else {
                        throw new Error("Kopyalama başarısız");
                    }
                } catch (err) {
                    alert("Kopyalama başarısız oldu. Lütfen aşağıdaki kodu manuel olarak seçip kopyalayın:\n\n" + sql.substring(0, 100) + "...");
                }
                document.body.removeChild(textArea);
            };

            return (
                <div className="bg-amber-50 p-4 rounded-xl border border-amber-200 mb-8 animate-in fade-in slide-in-from-top-4">
                    <div className="flex items-start gap-3">
                        <div className="text-amber-600 mt-1"><Icon name="alert-triangle" size={24} /></div>
                        <div>
                            <h3 className="font-bold text-amber-800 text-sm">Veritabanı İzin Sorunu Mu Var?</h3>
                            <p className="text-amber-700 text-xs mt-1 mb-3">
                                Eğer "Kaydetme Hatası" alıyorsanız, bu kodu çalıştırarak veritabanı izinlerini onarabilirsiniz.
                            </p>
                            <button onClick={copySql} className="bg-amber-600 text-white px-3 py-1.5 rounded text-xs font-medium hover:bg-amber-700 flex items-center gap-1 transition">
                                <Icon name="database" size={14} /> Onarım Kodunu Kopyala (Tam Çözüm)
                            </button>
                        </div>
                    </div>
                </div>
            );
        };

        const MetadataSettings = ({ companyId, type, title, icon }) => {
            const [items, setItems] = useState([]);
            const [newItem, setNewItem] = useState({ name: '', last4: '' });
            const [loading, setLoading] = useState(false);

            useEffect(() => {
                lucide.createIcons();
            }, [items]);

            const fetchItems = useCallback(async () => {
                if (!companyId) {
                    setItems([]);
                    return;
                }
                try {
                    const { data, error } = await sb.from(type).select('*').eq('company_id', companyId).order('id');
                    if (error) {
                        console.warn(`${type} yükleme hatası:`, error);
                        setItems([]);
                    } else {
                        setItems(data || []);
                    }
                } catch (err) {
                    console.error(`${type} yükleme exception:`, err);
                    setItems([]);
                }
            }, [companyId, type]);

            useEffect(() => { if (companyId) fetchItems(); }, [fetchItems]);

            const addItem = async () => {
                if ((type !== 'company_cards' && !newItem.name) || (type === 'company_cards' && !newItem.last4)) return;

                if (type === 'company_cards' && newItem.last4.length < 4) return alert("Kart son 4 hanesi en az 4 rakam olmalı.");

                if (!companyId) {
                    alert("Şirket bilgisi bulunamadı. Lütfen tekrar giriş yapın.");
                    return;
                }

                setLoading(true);
                let payload = { company_id: parseInt(companyId) };

                if (type === 'categories') {
                    payload.name = newItem.name;
                }
                if (type === 'projects') {
                    payload.name = newItem.name;
                }
                if (type === 'company_cards') {
                    payload.bank_name = 'Kredi Kartı';
                    payload.card_alias = `Kart ${newItem.last4}`;
                    payload.last_4_digits = newItem.last4;
                }

                try {
                    const { error } = await sb.from(type).insert([payload]);
                    if (error) {
                        console.error(`${type} ekleme hatası:`, error);
                        if (error.code === '42501' || error.message.includes('row-level security')) {
                            alert(`YETKİ HATASI: Veritabanı izniniz eksik. Lütfen yukarıdaki 'Onarım Kodunu Kopyala' butonunu kullanın.`);
                        } else {
                            alert("Hata: " + error.message);
                        }
                    } else {
                        setNewItem({ name: '', last4: '' });
                        fetchItems();
                    }
                } catch (err) {
                    console.error("Beklenmeyen hata:", err);
                    alert("Bir hata oluştu.");
                } finally {
                    setLoading(false);
                }
            };

            const deleteItem = async (id) => {
                if (!confirm("Silmek istediğinize emin misiniz?")) return;
                try {
                    const { error } = await sb.from(type).delete().eq('id', id);
                    if (error) {
                        alert("Silme hatası: " + error.message);
                    } else {
                        fetchItems();
                    }
                } catch (err) {
                    alert("Bir hata oluştu.");
                }
            };

            return (
                <div className="bg-white p-6 rounded-xl border border-slate-200 shadow-sm mb-6">
                    <div className="flex items-center gap-2 mb-4 text-slate-800 border-b pb-2">
                        <Icon name={icon} size={20} className="text-primary" /> <h3 className="font-bold">{title}</h3>
                    </div>

                    <div className="flex gap-2 mb-4">
                        {type === 'company_cards' ? (
                            <input
                                className="border p-2 rounded text-sm w-full"
                                placeholder="Kart Son 4 Rakam (Örn: 4492)"
                                maxLength="4"
                                value={newItem.last4}
                                onChange={e => setNewItem({ ...newItem, last4: e.target.value.replace(/\D/g, '') })}
                            />
                        ) : (
                            <input
                                className="border p-2 rounded text-sm w-full"
                                placeholder={`${title} Adı`}
                                value={newItem.name}
                                onChange={e => setNewItem({ ...newItem, name: e.target.value })}
                            />
                        )}
                        <button onClick={addItem} disabled={loading} className="bg-green-600 text-white px-4 rounded hover:bg-green-700 disabled:opacity-50 flex items-center justify-center"><Icon name="plus" size={18} /></button>
                    </div>

                    <ul className="space-y-2 max-h-40 overflow-y-auto custom-scrollbar">
                        {items.map(i => (
                            <li key={i.id} className="flex justify-between items-center bg-slate-50 p-2 rounded text-sm border">
                                <span>
                                    {type === 'company_cards' ? `**** **** **** ${i.last_4_digits}` : i.name}
                                </span>
                                <button onClick={() => deleteItem(i.id)} className="text-red-400 hover:text-red-600"><Icon name="trash-2" size={16} /></button>
                            </li>
                        ))}
                        {items.length === 0 && <li className="text-slate-400 text-xs text-center">Henüz kayıt yok.</li>}
                    </ul>
                </div>
            );
        };

        const TeamManagement = ({ user, profile }) => {
            const [users, setUsers] = useState([]);
            const [company, setCompany] = useState(null);
            const [loading, setLoading] = useState(false);
            const [showAddModal, setShowAddModal] = useState(false);
            const [newUser, setNewUser] = useState({ email: '', full_name: '', password: '', role: 'user', phone: '' });
            const [adding, setAdding] = useState(false);
            const [deleting, setDeleting] = useState(null);

            const fetchTeam = useCallback(async () => {
                if (!profile?.company_id) return;
                setLoading(true);
                try {
                    const { data: comp, error: compError } = await sb.from('companies').select('*').eq('id', profile.company_id).single();
                    if (compError) console.warn("Şirket bilgisi çekilemedi:", compError);
                    setCompany(comp);
                    const { data: team } = await sb.from('users').select('*').eq('company_id', profile.company_id);
                    setUsers(team || []);
                } catch (err) {
                    console.error("Ekip verisi hatası:", err);
                }
                setLoading(false);
            }, [profile?.company_id]);

            useEffect(() => { fetchTeam(); }, [fetchTeam]);

            const handleAddUser = async (e) => {
                if (!company) { alert("Şirket bilgileri yüklenemedi. Lütfen veritabanı izinlerini (RLS) kontrol edin."); return; }
                const maxUsers = company.max_users || 5;
                if (users.length >= maxUsers) { alert(`Şirket kullanıcı limitinize (${maxUsers}) ulaştınız. Daha fazla kullanıcı ekleyemezsiniz.`); return; }
                setAdding(true);

                const isLocalhost = window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1';
                const forceTest = e && e.shiftKey;
                const targetUrl = forceTest ? WEBHOOKS.ADD_USER.TEST : (isLocalhost ? WEBHOOKS.ADD_USER.TEST : WEBHOOKS.ADD_USER.PROD);

                try {
                    await fetch(targetUrl, {
                        method: 'POST',
                        mode: 'no-cors',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            company_id: profile.company_id,
                            email: newUser.email,
                            full_name: newUser.full_name,
                            password: newUser.password,
                            role: newUser.role,
                            phone: normalizePhone(newUser.phone),
                            manager_id: user.id
                        })
                    });
                    alert("Kullanıcı oluşturma isteği gönderildi. Birkaç saniye içinde listede görünecektir.");
                    setShowAddModal(false);
                    setNewUser({ email: '', full_name: '', password: '', role: 'user', phone: '' });
                    setTimeout(fetchTeam, 3000);
                } catch (error) { alert("Hata: " + error.message); } finally { setAdding(false); }
            };

            const handleDeleteUser = async (userIdToDelete, e) => {
                if (!confirm("Bu kullanıcıyı silmek istediğinize emin misiniz? Bu işlem geri alınamaz.")) return;
                setDeleting(userIdToDelete);

                const isLocalhost = window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1';
                const forceTest = e && e.shiftKey;
                const targetUrl = forceTest ? WEBHOOKS.DELETE_USER.TEST : (isLocalhost ? WEBHOOKS.DELETE_USER.TEST : WEBHOOKS.DELETE_USER.PROD);

                try {
                    await fetch(targetUrl, {
                        method: 'POST',
                        mode: 'no-cors',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            target_user_id: userIdToDelete,
                            manager_id: user.id
                        })
                    });
                    alert("Silme isteği gönderildi.");
                    setTimeout(fetchTeam, 2000);
                } catch (error) { alert("Silme hatası: " + error.message); } finally { setDeleting(null); }
            };

            if (loading) return <div className="text-center p-10 text-slate-400">Yükleniyor...</div>;

            return (
                <div className="space-y-6">
                    <div className="flex justify-between items-center">
                        <div><h2 className="text-2xl font-bold text-slate-800">Ekip Yönetimi</h2><p className="text-slate-500 text-sm">{company?.name || 'Şirket Yükleniyor...'} (Kullanıcılar: {users.length} / {company?.max_users || '-'})</p></div>
                        <button onClick={() => setShowAddModal(true)} className="bg-primary text-white px-4 py-2 rounded-lg flex items-center gap-2 hover:bg-blue-700 transition"><Icon name="user-plus" size={18} /> Yeni Kullanıcı</button>
                    </div>
                    <div className="bg-white rounded-xl border border-slate-200 overflow-hidden">
                        <table className="w-full text-left text-sm">
                            <thead className="bg-slate-50 text-slate-500 uppercase text-xs"><tr><th className="px-6 py-3">Ad Soyad</th><th className="px-6 py-3">E-Posta</th><th className="px-6 py-3">Rol</th><th className="px-6 py-3">Durum</th><th className="px-6 py-3 text-right">İşlem</th></tr></thead>
                            <tbody className="divide-y divide-slate-100">
                                {users.map(u => (
                                    <tr key={u.id} className="hover:bg-slate-50">
                                        <td className="px-6 py-4 font-medium text-slate-800">{u.full_name || '-'}</td><td className="px-6 py-4 text-slate-600">{u.email}</td>
                                        <td className="px-6 py-4"><span className={`px-2 py-1 rounded text-xs ${u.role === 'admin' ? 'bg-purple-100 text-purple-700' : 'bg-blue-100 text-blue-700'}`}>{u.role === 'admin' ? 'Yönetici' : 'Personel'}</span></td>
                                        <td className="px-6 py-4">
                                            {u.status === 'pending' || u.status === 'beklemede' ?
                                                <span className="text-orange-500 flex items-center gap-1"><Icon name="clock" size={14} /> Beklemede</span> :
                                                <span className="text-green-600 flex items-center gap-1"><Icon name="check-circle" size={14} /> Aktif</span>
                                            }
                                        </td>
                                        <td className="px-6 py-4 text-right">
                                            {u.id !== user.id && (
                                                <button
                                                    onClick={(e) => handleDeleteUser(u.id, e)}
                                                    disabled={deleting === u.id}
                                                    className="text-red-400 hover:text-red-600 p-2 hover:bg-red-50 rounded transition disabled:opacity-50"
                                                >
                                                    {deleting === u.id ? <Icon name="loader-2" size={16} className="animate-spin" /> : <Icon name="trash-2" size={16} />}
                                                </button>
                                            )}
                                        </td>
                                    </tr>
                                ))}
                            </tbody>
                        </table>
                    </div>
                    {showAddModal && (
                        <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-50">
                            <div className="bg-white p-6 rounded-xl shadow-xl w-full max-w-md animate-in fade-in zoom-in duration-200">
                                <h3 className="text-lg font-bold mb-4">Yeni Kullanıcı Ekle</h3>
                                <div className="space-y-3">
                                    <input type="text" placeholder="Ad Soyad" className="w-full p-2 border rounded" value={newUser.full_name} onChange={e => setNewUser({ ...newUser, full_name: e.target.value })} />
                                    <input type="email" placeholder="E-Posta" className="w-full p-2 border rounded" value={newUser.email} onChange={e => setNewUser({ ...newUser, email: e.target.value })} />
                                    <input type="text" placeholder="Telefon (5XX...)" className="w-full p-2 border rounded" value={newUser.phone} onChange={e => setNewUser({ ...newUser, phone: e.target.value })} />
                                    <input type="password" placeholder="Geçici Şifre" className="w-full p-2 border rounded" value={newUser.password} onChange={e => setNewUser({ ...newUser, password: e.target.value })} />
                                    <select className="w-full p-2 border rounded" value={newUser.role} onChange={e => setNewUser({ ...newUser, role: e.target.value })}><option value="user">Personel</option><option value="admin">Yönetici</option></select>
                                </div>
                                <div className="mt-6 flex justify-end gap-2">
                                    <button onClick={() => setShowAddModal(false)} className="px-4 py-2 text-slate-500 hover:bg-slate-100 rounded">İptal</button>
                                    <button onClick={(e) => handleAddUser(e)} disabled={adding} className="px-4 py-2 bg-primary text-white rounded hover:bg-blue-700 flex items-center gap-2">{adding ? <Icon name="loader-2" className="loading-spin" size={16} /> : <Icon name="user-plus" size={16} />} Ekle</button>
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        const AboutContent = () => (
            <div className="space-y-8 text-left">
                <div className="flex items-start gap-4"><div className="p-3 bg-blue-100 rounded-lg text-primary mt-1"><Icon name="zap" size={24} /></div><div><h3 className="text-lg font-bold text-slate-800 mb-2">FişMatik Nedir?</h3><p className="text-slate-600 leading-relaxed">FişMatik, işletmelerin ve çalışanların harcama fişlerini yapay zeka destekli OCR teknolojisi ile saniyeler içinde dijitalleştiren, raporlayan ve muhasebeleştiren akıllı bir platformdur. Manuel veri girişini ortadan kaldırır, zamandan tasarruf sağlar.</p></div></div>
                <div className="flex items-start gap-4"><div className="p-3 bg-green-100 rounded-lg text-green-600 mt-1"><Icon name="scan-line" size={24} /></div><div><h3 className="text-lg font-bold text-slate-800 mb-2">Nasıl Kullanılır?</h3><ul className="list-disc list-inside text-slate-600 space-y-2"><li>Telegram botumuza fiş fotoğrafını gönderin.</li><li>Yapay zeka fişinizi okur ve sisteme kaydeder.</li><li>Bu panel üzerinden harcamalarınızı görüntüleyin ve düzenleyin.</li><li>Tek tıkla Excel raporunuzu e-posta adresinize alın.</li></ul></div></div>
                <div className="flex items-start gap-4"><div className="p-3 bg-indigo-100 rounded-lg text-indigo-600 mt-1"><Icon name="sparkles" size={24} /></div><div><h3 className="text-lg font-bold text-slate-800 mb-2">Yapay Zeka Analizi</h3><p className="text-slate-600 leading-relaxed">Google Gemini ile harcamalarınızı analiz edin, tasarruf önerileri alın. Ayarlar sayfasında "Google Gemini API Anahtarı" bölümüne Gemini API anahtarınızı girerek bu özelliği aktif edebilirsiniz. sistemdeki fiş kayıtlarınız arttıkça tutarlı sonuçlar verme olasılığı artacaktır.</p></div></div>
                <div className="flex items-start gap-4"><div className="p-3 bg-purple-100 rounded-lg text-purple-600 mt-1"><Icon name="user-plus" size={24} /></div><div><h3 className="text-lg font-bold text-slate-800 mb-2">Nasıl Kayıt Olunur?</h3><div className="bg-slate-50 p-4 rounded-lg border border-slate-200"><p className="text-slate-600 mb-3">FişMatik şu an davetiye ve başvuru usulü ile çalışmaktadır. Sisteme kayıt olmak ve şirketiniz için aktivasyon sağlamak için lütfen Telegram botumuz üzerinden başvuru yapınız.</p><a href="https://t.me/ITT_Fis_matik_BOT" target="_blank" className="inline-flex items-center gap-2 text-primary font-medium hover:underline"><Icon name="send" size={16} /> FişMatik Telegram Botuna Git</a></div></div></div>
            </div>
        );

        const AboutPage = ({ onBack }) => (
            <div className="min-h-screen bg-slate-50 flex flex-col items-center justify-center p-4">
                <div className="max-w-3xl w-full bg-white rounded-2xl shadow-xl overflow-hidden animate-in fade-in zoom-in duration-300">
                    <div className="bg-gradient-to-r from-blue-600 to-indigo-700 p-8 text-center text-white relative"><button onClick={onBack} className="absolute left-6 top-6 p-2 bg-white/10 hover:bg-white/20 rounded-full transition text-white"><Icon name="arrow-left" size={24} /></button><div className="flex justify-center mb-4"><div className="p-3 bg-white/20 rounded-full backdrop-blur-sm"><Icon name="receipt" size={40} /></div></div><h1 className="text-3xl font-bold mb-2">FişMatik</h1><p className="text-blue-100">Akıllı Harcama Yönetim Asistanınız</p></div>
                    <div className="p-8 md:p-12"><AboutContent /></div>
                    <div className="bg-slate-50 p-6 text-center border-t border-slate-100 text-slate-500 text-sm">&copy; 2025 İTT Yazılım. Tüm hakları saklıdır.</div>
                </div>
            </div>
        );

        const ReceiptsTable = ({ receipts, loading, simple, supabase, refresh, onLocalUpdate, userRole, profile }) => {
            const [editItem, setEditItem] = useState(null);
            const [isSaving, setIsSaving] = useState(false);
            const [filters, setFilters] = useState({ tarih: '', isletme_adi: '', toplam_tutar: '', durum: '', kategori: '', kart_son_4: '' });
            const [imgRotation, setImgRotation] = useState(0);
            const [imgZoom, setImgZoom] = useState(1);
            const [pan, setPan] = useState({ x: 0, y: 0 });
            const [isDragging, setIsDragging] = useState(false);
            const [dragStart, setDragStart] = useState({ x: 0, y: 0 });

            const [metaCategories, setMetaCategories] = useState([]);
            const [metaProjects, setMetaProjects] = useState([]);

            useEffect(() => {
                if (profile?.company_id) {
                    sb.from('categories').select('*').eq('company_id', profile.company_id).then(({ data }) => setMetaCategories(data || []));
                    sb.from('projects').select('*').eq('company_id', profile.company_id).then(({ data }) => setMetaProjects(data || []));
                }
            }, [profile?.company_id]);

            useEffect(() => { if (editItem) { setImgRotation(0); setImgZoom(1); setPan({ x: 0, y: 0 }); } }, [editItem]);
            useEffect(() => { /* İkonlar artık otomatik render ediliyor */ }, [imgRotation, imgZoom, pan, filtered, loading]);
            const handleMouseDown = (e) => { e.preventDefault(); setIsDragging(true); setDragStart({ x: e.clientX - pan.x, y: e.clientY - pan.y }); };
            const handleMouseMove = (e) => { if (!isDragging) return; e.preventDefault(); setPan({ x: e.clientX - dragStart.x, y: e.clientY - dragStart.y }); };
            const handleMouseUp = () => { setIsDragging(false); };

            const getStatusBadge = (status) => {
                const s = status?.toLowerCase() || '';
                let classes = 'bg-gray-100 text-gray-800'; let label = status || '-';
                if (s === 'onaylandi') { classes = 'bg-green-100 text-green-800'; label = 'Onaylandı'; }
                else if (s === 'beklemede') { classes = 'bg-yellow-100 text-yellow-800'; label = 'Beklemede'; }
                else if (s === 'reddedildi') { classes = 'bg-red-100 text-red-800'; label = 'Reddedildi'; }
                else if (s === 'mukerrer') { classes = 'bg-orange-100 text-orange-800'; label = 'Mükerrer'; }
                else if (s === 'rapor alindi' || s === 'rapor alındı' || s === 'rapor_alindi') { classes = 'bg-indigo-100 text-indigo-800'; label = 'Rapor Alındı'; }
                return <span className={`px-2 py-1 rounded text-xs font-medium whitespace-nowrap ${classes}`}>{label}</span>;
            };

            const filtered = useMemo(() => {
                if (simple) return receipts;
                return receipts.filter(r => {
                    const matchTarih = !filters.tarih || r.tarih?.includes(filters.tarih);
                    const matchIsletme = !filters.isletme_adi || r.isletme_adi?.toLowerCase().includes(filters.isletme_adi.toLowerCase());
                    const matchTutar = !filters.toplam_tutar || r.toplam_tutar?.toString().includes(filters.toplam_tutar);
                    const matchKategori = !filters.kategori || r.kategori?.toLowerCase().includes(filters.kategori.toLowerCase());
                    const matchKart = !filters.kart_son_4 || r.kart_son_4?.toString().includes(filters.kart_son_4);
                    let matchDurum = true;
                    if (filters.durum) {
                        const s = r.durum?.toLowerCase() || '';
                        const f = filters.durum.toLowerCase();
                        if (f === 'onaylandi') matchDurum = s === 'onaylandi' || s === 'onaylandı';
                        else if (f === 'mukerrer') matchDurum = s === 'mukerrer' || s === 'mükerrer';
                        else if (f === 'rapor alindi') matchDurum = s.includes('rapor');
                        else matchDurum = s.includes(f);
                    }
                    return matchTarih && matchIsletme && matchTutar && matchDurum && matchKategori && matchKart;
                });
            }, [receipts, filters, simple]);

            const handleSave = async () => {
                setIsSaving(true);
                const updatedItem = { ...editItem };
                const categories = updatedItem.ocr_detaylari?.map(l => l.kategori).filter(Boolean) || [];
                const uniqueCategories = [...new Set(categories)];
                updatedItem.kategori = uniqueCategories.length > 1 ? 'Çoklu' : (uniqueCategories[0] || 'Genel');
                if (onLocalUpdate) onLocalUpdate(updatedItem);
                setEditItem(null);
                try {
                    await supabase.from('fisler').update({
                        isletme_adi: updatedItem.isletme_adi,
                        toplam_tutar: parseFloat(updatedItem.toplam_tutar),
                        tarih: updatedItem.tarih,
                        durum: updatedItem.durum,
                        kategori: updatedItem.kategori,
                        proje: updatedItem.proje,
                        ocr_detaylari: updatedItem.ocr_detaylari,
                        fis_no: updatedItem.fis_no,
                        kart_son_4: updatedItem.kart_son_4
                    }).eq('id', updatedItem.id);
                    if (refresh) refresh();
                } catch (e) { alert("Hata: " + e.message); if (refresh) refresh(); } finally { setIsSaving(false); }
            };

            const addLine = () => setEditItem({ ...editItem, ocr_detaylari: [...(editItem.ocr_detaylari || []), { aciklama: '', kategori: '', kdv: 18, tutar: 0 }] });
            const removeLine = (idx) => { const lines = [...editItem.ocr_detaylari]; lines.splice(idx, 1); setEditItem({ ...editItem, ocr_detaylari: lines }); };
            const updateLine = (idx, key, val) => { const lines = [...editItem.ocr_detaylari]; lines[idx][key] = val; setEditItem({ ...editItem, ocr_detaylari: lines }); };

            if (loading) return <div className="p-8 text-center text-slate-400">Yükleniyor...</div>;
            if (receipts.length === 0) return <div className="p-8 text-center text-slate-400">Veri yok.</div>;

            return (
                <>
                    <div className="overflow-x-auto">
                        <table className="w-full text-left text-sm">
                            <thead className="bg-slate-50 text-slate-500 uppercase text-xs sticky top-0">
                                <tr>
                                    <th className="px-6 py-3">Tarih</th><th className="px-6 py-3">İşletme</th><th className="px-6 py-3">Kategori</th><th className="px-6 py-3">Kart Son 4</th><th className="px-6 py-3">Tutar</th><th className="px-6 py-3">Durum</th>{!simple && <th className="px-6 py-3 text-right">İşlem</th>}
                                </tr>
                                {!simple && (
                                    <tr className="bg-slate-100">
                                        <th className="px-2"><input placeholder="Yıl-Ay-Gün" className="w-full p-1 border rounded" onChange={e => setFilters({ ...filters, tarih: e.target.value })} /></th>
                                        <th className="px-2"><input placeholder="Ara..." className="w-full p-1 border rounded" onChange={e => setFilters({ ...filters, isletme_adi: e.target.value })} /></th>
                                        <th className="px-2"><select className="w-full p-1 border rounded" onChange={e => setFilters({ ...filters, kategori: e.target.value })}><option value="">Hepsi</option>{metaCategories.map(c => <option key={c.id} value={c.name}>{c.name}</option>)}</select></th>
                                        <th className="px-2"><input placeholder="Son 4..." className="w-full p-1 border rounded" onChange={e => setFilters({ ...filters, kart_son_4: e.target.value })} /></th>
                                        <th className="px-2"><input placeholder="Tutar..." className="w-full p-1 border rounded" onChange={e => setFilters({ ...filters, toplam_tutar: e.target.value })} /></th>
                                        <th className="px-2"><select className="w-full p-1 border rounded" onChange={e => setFilters({ ...filters, durum: e.target.value })}><option value="">Hepsi</option><option value="beklemede">Beklemede</option><option value="onaylandi">Onaylandı</option><option value="reddedildi">Reddedildi</option><option value="mukerrer">Mükerrer</option><option value="rapor alindi">Rapor Alındı</option></select></th>
                                        <th></th>
                                    </tr>
                                )}
                            </thead>
                            <tbody className="divide-y divide-slate-100">
                                {filtered.map(r => (
                                    <tr key={r.id} className="hover:bg-slate-50 transition group">
                                        <td className="px-6 py-4">{new Date(r.tarih).toLocaleDateString('tr-TR')}</td><td className="px-6 py-4 font-medium">{r.isletme_adi}</td><td className="px-6 py-4 text-slate-500">{r.kategori || '-'}</td><td className="px-6 py-4 text-slate-500">{r.kart_son_4 || '-'}</td><td className="px-6 py-4 font-bold">{r.toplam_tutar?.toLocaleString('tr-TR', { style: 'currency', currency: 'TRY' })}</td><td className="px-6 py-4">{getStatusBadge(r.durum)}</td>
                                        {!simple && <td className="px-6 py-4 text-right"><button onClick={() => setEditItem(JSON.parse(JSON.stringify(r)))} className="text-primary hover:bg-blue-50 p-2 rounded"><Icon name="pencil" size={16} /></button></td>}
                                    </tr>
                                ))}
                            </tbody>
                        </table>
                    </div>
                    {editItem && (
                        <div className="fixed inset-0 bg-black/80 flex items-center justify-center z-50 p-4">
                            <div className="bg-white w-full max-w-6xl h-[90vh] rounded-xl flex overflow-hidden shadow-2xl">
                                <div className="w-1/2 bg-slate-900 flex items-center justify-center relative p-4 overflow-hidden group cursor-move" onMouseDown={handleMouseDown} onMouseMove={handleMouseMove} onMouseUp={handleMouseUp} onMouseLeave={handleMouseUp}>
                                    {editItem.gorsel_url ? <div className="image-container" style={{ transform: `translate(${pan.x}px, ${pan.y}px) rotate(${imgRotation}deg) scale(${imgZoom})`, maxWidth: '100%', maxHeight: '100%', display: 'flex', alignItems: 'center', justifyContent: 'center', transition: isDragging ? 'none' : 'transform 0.2s ease-out' }}><img src={editItem.gorsel_url} className="max-w-full max-h-full object-contain shadow-lg pointer-events-none" /></div> : <p className="text-white">Görsel Yok</p>}
                                    {editItem.gorsel_url && <a href={editItem.gorsel_url} target="_blank" className="absolute top-4 right-4 bg-white/10 p-2 rounded text-white hover:bg-white/20 transition z-10" onMouseDown={e => e.stopPropagation()}><Icon name="external-link" size={20} /></a>}
                                    <div className="absolute bottom-6 flex items-center gap-2 bg-slate-800/90 p-2 rounded-full backdrop-blur-sm border border-white/10 shadow-xl z-20 opacity-0 group-hover:opacity-100 transition-opacity duration-300" onMouseDown={e => e.stopPropagation()}><button onClick={() => setImgZoom(z => Math.max(0.5, z - 0.25))} className="p-2 text-white"><Icon name="zoom-out" /></button><button onClick={() => setImgZoom(z => Math.min(3, z + 0.25))} className="p-2 text-white"><Icon name="zoom-in" /></button><button onClick={() => { setImgZoom(1); setImgRotation(0); setPan({ x: 0, y: 0 }) }} className="p-2 text-white"><Icon name="refresh-ccw" /></button><button onClick={() => setImgRotation(r => r + 90)} className="p-2 text-white"><Icon name="rotate-cw" /></button></div>
                                </div>
                                <div className="w-1/2 flex flex-col bg-white">
                                    <div className="p-4 border-b flex justify-between items-center"><h3 className="font-bold text-lg">Fiş Detayları</h3><button onClick={() => setEditItem(null)}><Icon name="x" /></button></div>
                                    <div className="flex-1 overflow-y-auto p-6 space-y-6">
                                        <div className="grid grid-cols-2 gap-4">
                                            <div><label className="text-xs text-slate-500">İşletme</label><input className="w-full border p-2 rounded" value={editItem.isletme_adi} onChange={e => setEditItem({ ...editItem, isletme_adi: e.target.value })} /></div>
                                            <div><label className="text-xs text-slate-500">Tarih</label><input type="datetime-local" className="w-full border p-2 rounded" value={editItem.tarih ? editItem.tarih.slice(0, 16) : ''} onChange={e => setEditItem({ ...editItem, tarih: e.target.value })} /></div>

                                            {/* --- YENİ EKLENEN FİŞ NO ALANI --- */}
                                            <div><label className="text-xs text-slate-500">Fiş No</label><input className="w-full border p-2 rounded" value={editItem.fis_no || ''} onChange={e => setEditItem({ ...editItem, fis_no: e.target.value })} /></div>

                                            <div><label className="text-xs text-slate-500">Tutar</label><input type="number" step="0.01" className="w-full border p-2 rounded font-bold" value={editItem.toplam_tutar} onChange={e => setEditItem({ ...editItem, toplam_tutar: e.target.value })} /></div>
                                            <div><label className="text-xs text-slate-500">Kart Son 4</label><input className="w-full border p-2 rounded" placeholder="Örn: 1234" value={editItem.kart_son_4 || ''} onChange={e => setEditItem({ ...editItem, kart_son_4: e.target.value })} /></div>
                                            <div><label className="text-xs text-slate-500">Durum</label><select className="w-full border p-2 rounded" value={editItem.durum} onChange={e => setEditItem({ ...editItem, durum: e.target.value })}><option value="beklemede">Beklemede</option><option value="onaylandi">Onaylandı</option><option value="reddedildi">Reddedildi</option><option value="mukerrer">Mükerrer</option><option value="rapor alindi">Rapor Alındı</option></select></div>

                                            {/* PROJE SEÇİMİ (YENİ) */}
                                            <div>
                                                <label className="text-xs text-slate-500">Proje</label>
                                                <select className="w-full border p-2 rounded bg-white" value={editItem.proje || ''} onChange={e => setEditItem({ ...editItem, proje: e.target.value })}>
                                                    <option value="">Seçiniz</option>
                                                    {metaProjects.map(p => <option key={p.id} value={p.name}>{p.name} ({p.code})</option>)}
                                                    <option value="Genel">Genel</option>
                                                </select>
                                            </div>

                                            <div className="col-span-1"><label className="text-xs text-slate-500">Genel Kategori (Otomatik)</label><input className="w-full border p-2 rounded bg-slate-50 text-slate-500" value={editItem.kategori || 'Otomatik'} disabled /></div>
                                        </div>
                                        <hr />
                                        <div>
                                            <div className="flex justify-between mb-2 items-center">
                                                <h4 className="font-bold text-sm text-slate-700">Harcama Kalemleri</h4>
                                                <button onClick={addLine} className="text-xs bg-blue-50 text-blue-600 px-3 py-1.5 rounded-full hover:bg-blue-100 transition font-medium flex items-center gap-1"><Icon name="plus" size={14} /> Ekle</button>
                                            </div>
                                            <div className="space-y-2 mb-3">
                                                <div className="grid grid-cols-12 gap-2 text-xs font-bold text-slate-400 px-1"><div className="col-span-4">Açıklama</div><div className="col-span-3">Kategori</div><div className="col-span-2">KDV</div><div className="col-span-2">Tutar</div><div className="col-span-1"></div></div>
                                                {(editItem.ocr_detaylari || []).map((line, i) => (
                                                    <div key={i} className="grid grid-cols-12 gap-2 items-center bg-slate-50 p-2 rounded-lg border border-slate-100 group">
                                                        <div className="col-span-4"><input className="w-full bg-transparent border-b border-transparent focus:border-blue-300 outline-none text-sm transition" value={line.aciklama || line.UrunTuru || ''} onChange={e => updateLine(i, 'aciklama', e.target.value)} placeholder="Ürün Adı" /></div>
                                                        <div className="col-span-3">
                                                            {/* Kategori Dropdown'ı Güncellendi */}
                                                            <select className="w-full bg-transparent border-b border-transparent focus:border-blue-300 outline-none text-sm cursor-pointer" value={line.kategori || ''} onChange={e => updateLine(i, 'kategori', e.target.value)}>
                                                                <option value="">Seçiniz</option>
                                                                {metaCategories.length > 0 ? metaCategories.map(c => <option key={c.id} value={c.name}>{c.name}</option>) : (
                                                                    <>
                                                                        <option value="Yemek">Yemek</option><option value="Market">Market</option><option value="Yakıt">Yakıt</option><option value="Konaklama">Konaklama</option><option value="Ulaşım">Ulaşım</option><option value="Giyim">Giyim</option><option value="Kırtasiye">Kırtasiye</option><option value="Teknoloji">Teknoloji</option><option value="Temizlik">Temizlik</option><option value="Diğer">Diğer</option>
                                                                    </>
                                                                )}
                                                            </select>
                                                        </div>
                                                        <div className="col-span-2"><input type="number" className="w-full bg-transparent border-b border-transparent focus:border-blue-300 outline-none text-sm" value={line.kdv || line.KDVOrani || 0} onChange={e => updateLine(i, 'kdv', e.target.value)} /></div>
                                                        <div className="col-span-2"><input type="number" className="w-full bg-transparent border-b border-transparent focus:border-blue-300 outline-none text-sm font-medium" value={line.tutar || line.Tutar_KDVDahil || 0} onChange={e => updateLine(i, 'tutar', e.target.value)} /></div>
                                                        <div className="col-span-1 text-right"><button onClick={() => removeLine(i)} className="text-slate-400 hover:text-red-500 transition opacity-0 group-hover:opacity-100"><Icon name="trash-2" size={16} /></button></div>
                                                    </div>
                                                ))}
                                            </div>

                                            {/* YENİ EKLENEN BÜYÜK BUTON */}
                                            <button onClick={addLine} className="w-full py-3 border-2 border-dashed border-slate-200 rounded-xl text-slate-500 hover:border-blue-400 hover:text-blue-600 hover:bg-blue-50 transition flex items-center justify-center gap-2 text-sm font-medium"><Icon name="plus-circle" size={18} /> Yeni Satır Ekle</button>
                                        </div>
                                    </div>
                                    <div className="p-4 border-t flex justify-end gap-2"><button onClick={() => setEditItem(null)} className="px-4 py-2 text-slate-500 hover:bg-slate-100 rounded">İptal</button><button onClick={handleSave} disabled={isSaving} className="px-6 py-2 bg-green-600 text-white rounded hover:bg-green-700 flex items-center gap-2">{isSaving ? <><Icon name="loader-2" className="loading-spin" /> Kaydediliyor...</> : 'Kaydet'}</button></div>
                                </div>
                            </div>
                        </div>
                    )}
                </>
            );
        };

        // --- REPORT PAGE (HTML2PDF) ---
        const ReportPage = ({ user, profile }) => {
            const [dates, setDates] = useState({ start: new Date().toISOString().split('T')[0], end: new Date().toISOString().split('T')[0] });
            const [loading, setLoading] = useState(false);
            const [reportData, setReportData] = useState(null);
            const [activeTab, setActiveTab] = useState('all'); // all, cards, projects
            const [companyCards, setCompanyCards] = useState([]);

            // Verileri Çek ve Grupla
            const generateReport = async () => {
                if (!profile?.company_id) return;
                setLoading(true);

                try {
                    // 1. Şirket Kartlarını Çek
                    const { data: cards } = await sb.from('company_cards').select('*').eq('company_id', profile.company_id);
                    setCompanyCards(cards || []);
                    const cardNumbers = new Set((cards || []).map(c => c.last_4_digits));

                    // 2. Fişleri Çek
                    let query = sb.from('fisler').select('*')
                        .eq('company_id', profile.company_id)
                        .in('durum', ['onaylandi', 'beklemede', 'Onaylandı', 'Beklemede']) // Sadece bu durumlar
                        .gte('tarih', dates.start)
                        .lte('tarih', dates.end + ' 23:59:59')
                        .order('tarih', { ascending: true });

                    const { data: fisler, error: fetchError } = await query;
                    if (fetchError) throw fetchError;

                    if (fisler) {
                        // --- MÜKERRER KONTROLÜ VE FİLTRELEME ---
                        const seen = new Map();
                        const uniqueFisler = [];
                        const duplicatesToUpdate = [];

                        fisler.forEach(f => {
                            // Parmak izi: İşletme adı (normalize), Tarih, Net Tutar, Fiş No
                            const normalizedBusiness = (f.isletme_adi || "").toLowerCase().replace(/[^a-z0-9]/g, '');
                            const dateStr = f.tarih ? f.tarih.slice(0, 10) : 'no-date';
                            const fingerprint = `${normalizedBusiness}|${dateStr}|${f.toplam_tutar || 0}|${f.fis_no || ''}`;

                            if (seen.has(fingerprint)) {
                                duplicatesToUpdate.push(f.id);
                            } else {
                                seen.set(fingerprint, true);
                                uniqueFisler.push(f);
                            }
                        });

                        // Mükerrerleri toplu güncelle
                        if (duplicatesToUpdate.length > 0) {
                            sb.from('fisler').update({ durum: 'mukerrer' }).in('id', duplicatesToUpdate).then(() => { });
                        }

                        // GRUPLAMA MANTIĞI
                        let cardGroups = {};
                        let projectGroups = {};

                        uniqueFisler.forEach(f => {
                            const isCC = (f.odeme_tipi === 'Kredi Kartı' || f.odeme_tipi === 'Kredi Karti');
                            const isCompanyCard = isCC && f.kart_son_4 && cardNumbers.has(f.kart_son_4);

                            if (isCompanyCard) {
                                const key = f.kart_son_4;
                                if (!cardGroups[key]) cardGroups[key] = { title: `Kredi Kartı - ${key}`, items: [], total: 0 };
                                cardGroups[key].items.push(f);
                                cardGroups[key].total += (f.toplam_tutar || 0);
                            } else {
                                const key = (f.proje && f.proje !== "Seçiniz" && f.proje !== "") ? f.proje : "Genel/Belirsiz";
                                if (!projectGroups[key]) projectGroups[key] = { title: `Proje - ${key}`, items: [], total: 0 };
                                projectGroups[key].items.push(f);
                                projectGroups[key].total += (f.toplam_tutar || 0);
                            }
                        });

                        setReportData({ cardGroups, projectGroups, allItems: uniqueFisler });
                    }
                } catch (e) {
                    console.error(e);
                    alert("Rapor oluşturulurken hata oluştu.");
                } finally {
                    setLoading(false);
                }
            };

            const downloadPDF = () => {
                const element = document.getElementById('printable-area');
                const opt = {
                    margin: 5,
                    filename: `Fismatik_Rapor_${dates.start}_${dates.end}.pdf`,
                    image: { type: 'jpeg', quality: 0.98 },
                    html2canvas: { scale: 2 },
                    jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' }
                };
                html2pdf().set(opt).from(element).save();
            };

            const formatMoney = (amount) => {
                return amount?.toLocaleString('tr-TR', { minimumFractionDigits: 2, maximumFractionDigits: 2 }) + ' ₺';
            };

            const ReportTable = ({ title, items, total }) => (
                <div className="report-page mb-8 break-inside-avoid">
                    <div className="border-b-2 border-slate-800 pb-4 mb-4 flex justify-between items-end">
                        <div>
                            <h2 className="text-2xl font-bold text-slate-800">{profile?.company_name || "Şirket Adı"}</h2>
                            <p className="text-slate-500 text-sm">Harcama Raporu</p>
                        </div>
                        <div className="text-right">
                            <p className="font-bold text-lg">{title}</p>
                            <p className="text-xs text-slate-500">{new Date().toLocaleDateString('tr-TR')}</p>
                        </div>
                    </div>

                    <div className="mb-4 text-xs text-slate-500 flex gap-4">
                        <span className="bg-slate-100 px-2 py-1 rounded">Başlangıç: <b>{dates.start}</b></span>
                        <span className="bg-slate-100 px-2 py-1 rounded">Bitiş: <b>{dates.end}</b></span>
                    </div>

                    <table className="w-full text-left text-xs mb-6">
                        <thead className="border-b-2 border-slate-200 text-slate-500 uppercase">
                            <tr>
                                <th className="py-2">Tarih</th>
                                <th className="py-2">Fiş No</th>
                                <th className="py-2">İşletme</th>
                                <th className="py-2">Açıklama</th>
                                <th className="py-2">Kategori</th>
                                <th className="py-2 text-right">Tutar</th>
                            </tr>
                        </thead>
                        <tbody className="divide-y divide-slate-100">
                            {items.map(item => (
                                <tr key={item.id}>
                                    <td className="py-2">{new Date(item.tarih).toLocaleDateString('tr-TR')}</td>
                                    <td className="py-2">{item.fis_no || '-'}</td>
                                    <td className="py-2 font-medium">{item.isletme_adi}</td>
                                    <td className="py-2 text-slate-500 truncate max-w-[150px]">
                                        {item.ocr_detaylari?.map(d => d.aciklama || d.UrunTuru).join(', ')}
                                    </td>
                                    <td className="py-2">{item.kategori}</td>
                                    <td className="py-2 text-right font-bold">{formatMoney(item.toplam_tutar)}</td>
                                </tr>
                            ))}
                        </tbody>
                        <tfoot className="border-t-2 border-slate-800 font-bold">
                            <tr>
                                <td colSpan="5" className="py-3 text-right">GENEL TOPLAM:</td>
                                <td className="py-3 text-right text-lg">{formatMoney(total)}</td>
                            </tr>
                        </tfoot>
                    </table>

                    <div className="grid grid-cols-3 gap-8 mt-12 text-center text-xs text-slate-400">
                        <div>
                            <p className="font-bold mb-8 text-slate-800">TESLİM EDEN</p>
                            <div className="border-t border-slate-300 pt-2">İmza</div>
                        </div>
                        <div>
                            <p className="font-bold mb-8 text-slate-800">KONTROL EDEN</p>
                            <div className="border-t border-slate-300 pt-2">İmza</div>
                        </div>
                        <div>
                            <p className="font-bold mb-8 text-slate-800">ONAYLAYAN</p>
                            <div className="border-t border-slate-300 pt-2">İmza</div>
                        </div>
                    </div>
                </div>
            );

            return (
                <div className="flex flex-col h-full">
                    {/* Üst Bar */}
                    <div className="bg-white p-4 rounded-xl border border-slate-200 shadow-sm mb-6 flex justify-between items-center">
                        <div className="flex gap-4 items-center">
                            <div className="bg-blue-100 p-2 rounded-lg text-primary"><Icon name="file-bar-chart-2" /></div>
                            <div>
                                <h2 className="font-bold text-slate-800">Rapor Merkezi</h2>
                                <p className="text-xs text-slate-500">Tarih aralığı seçip raporu görüntüleyin.</p>
                            </div>
                        </div>
                        <div className="flex gap-2">
                            <input type="date" className="border rounded p-2 text-sm" value={dates.start} onChange={e => setDates({ ...dates, start: e.target.value })} />
                            <input type="date" className="border rounded p-2 text-sm" value={dates.end} onChange={e => setDates({ ...dates, end: e.target.value })} />
                            <button onClick={generateReport} disabled={loading} className="bg-slate-800 text-white px-4 py-2 rounded hover:bg-slate-900 flex gap-2 items-center">
                                {loading ? <Icon name="loader-2" className="animate-spin" /> : <Icon name="search" />} Getir
                            </button>
                            {reportData && (
                                <button onClick={downloadPDF} className="bg-red-600 text-white px-4 py-2 rounded hover:bg-red-700 flex gap-2 items-center">
                                    <Icon name="file-down" /> PDF İndir
                                </button>
                            )}
                        </div>
                    </div>

                    {/* Rapor İçeriği */}
                    {reportData ? (
                        <div className="flex-1 overflow-auto bg-slate-500/10 p-4 rounded-xl relative">

                            {/* Sekmeler */}
                            <div className="flex gap-2 mb-4 sticky top-0 z-10 bg-slate-50/90 backdrop-blur p-2 rounded-lg border">
                                <button onClick={() => setActiveTab('all')} className={`px-3 py-1 rounded text-sm ${activeTab === 'all' ? 'bg-white shadow text-primary font-bold' : 'text-slate-500'}`}>Tümünü Göster</button>
                                <button onClick={() => setActiveTab('cards')} className={`px-3 py-1 rounded text-sm ${activeTab === 'cards' ? 'bg-white shadow text-primary font-bold' : 'text-slate-500'}`}>Şirket Kartları</button>
                                <button onClick={() => setActiveTab('projects')} className={`px-3 py-1 rounded text-sm ${activeTab === 'projects' ? 'bg-white shadow text-primary font-bold' : 'text-slate-500'}`}>Projeler</button>
                            </div>

                            {/* Yazdırılacak Alan */}
                            <div id="printable-area">
                                {/* Kart Raporları */}
                                {(activeTab === 'all' || activeTab === 'cards') && Object.keys(reportData.cardGroups).map(key => (
                                    <ReportTable
                                        key={key}
                                        title={reportData.cardGroups[key].title}
                                        items={reportData.cardGroups[key].items}
                                        total={reportData.cardGroups[key].total}
                                    />
                                ))}

                                {/* Proje Raporları */}
                                {(activeTab === 'all' || activeTab === 'projects') && Object.keys(reportData.projectGroups).map(key => (
                                    <ReportTable
                                        key={key}
                                        title={reportData.projectGroups[key].title}
                                        items={reportData.projectGroups[key].items}
                                        total={reportData.projectGroups[key].total}
                                    />
                                ))}

                                {/* Genel Liste (Sadece 'Tümünü Göster'de en sonda çıksın istenirse) */}
                                {activeTab === 'all' && (
                                    <ReportTable
                                        title="GENEL DÖKÜM LİSTESİ"
                                        items={reportData.allItems}
                                        total={reportData.allItems.reduce((a, b) => a + b.toplam_tutar, 0)}
                                    />
                                )}
                            </div>

                        </div>
                    ) : (
                        <div className="flex-1 flex flex-col items-center justify-center text-slate-400">
                            <Icon name="file-search" size={48} className="mb-4 opacity-50" />
                            <p>Rapor oluşturmak için tarih seçip "Getir" butonuna basın.</p>
                        </div>
                    )}
                </div>
            );
        };

        const Dashboard = ({ user, profile, supabase, onLogout }) => {
            const [view, setView] = useState('dashboard');
            const [receipts, setReceipts] = useState([]);
            const [loading, setLoading] = useState(true);
            const [stats, setStats] = useState({ total: 0, count: 0, pending: 0 });
            const [aiAnalysis, setAiAnalysis] = useState(null);
            const [aiLoading, setAiLoading] = useState(false);

            const fetchData = useCallback(async () => {
                if (!user?.id) { setLoading(false); return; }
                setLoading(true);
                try {
                    let q = sb.from('fisler').select('*').order('tarih', { ascending: false });
                    if (profile?.company_id) { q = q.eq('company_id', profile.company_id); }
                    else { q = q.eq('user_id', user.id); }
                    const { data, error } = await q;
                    if (!error) {
                        setReceipts(data || []);
                        const total = (data || []).reduce((a, b) => a + (b.toplam_tutar || 0), 0);
                        const pending = (data || []).filter(r => r.durum === 'beklemede').length;
                        setStats({ total, count: (data || []).length, pending });
                    } else { setReceipts([]); }
                } catch (e) { setReceipts([]); }
                finally { setLoading(false); }
            }, [user?.id, profile?.company_id]);

            const handleLocalUpdate = (updatedItem) => {
                setReceipts(prev => prev.map(r => r.id === updatedItem.id ? updatedItem : r));
            };

            const runAiAnalysis = async () => {
                const apiKey = localStorage.getItem('fismatik_gemini_key');
                if (!apiKey) {
                    alert("Yapay zeka analizini kullanabilmek için Ayarlar sayfasından Gemini API anahtarınızı tanımlamanız gerekmektedir.");
                    return;
                }

                setAiLoading(true);
                setAiAnalysis(null);

                try {
                    const recentReceipts = receipts.slice(0, 20);
                    const receiptsSummary = recentReceipts.map(r =>
                        `- Tarih: ${r.tarih}, İşletme: ${r.isletme_adi}, Tutar: ${r.toplam_tutar} TL, Kategori: ${r.kategori}`
                    ).join('\n');

                    const prompt = `Aşağıdaki son harcama fişi verilerini analiz et ve bana şunları içeren kısa bir özet rapor sun:
                    1. Harcamalarımın genel özeti.
                    2. En çok hangi kategoride harcama yapılmış?
                    3. Tasarruf için 3 spesifik öneri.
                    4. Gelecek ay için tahmini harcama uyarısı.

                    Yanıtını Markdown formatında, profesyonel bir tonda ve Türkçe ver.

                    Veriler:
                    ${receiptsSummary}`;

                    const result = await callGemini(apiKey, prompt);
                    setAiAnalysis(result);
                } catch (err) {
                    console.error("AI Analiz Hatası:", err);
                    alert("Analiz sırasında bir hata oluştu: " + err.message);
                } finally {
                    setAiLoading(false);
                }
            };

            useEffect(() => { fetchData(); }, [fetchData]);
            useEffect(() => { /* İkonlar artık otomatik render ediliyor */ }, [view, receipts]);

            return (
                <div className="min-h-screen flex flex-col md:flex-row">
                    <aside className="w-full md:w-64 bg-white border-r border-slate-200 flex flex-col z-20">
                        <div className="p-6 flex items-center gap-2 border-b border-slate-100"><Icon name="receipt" className="text-primary" /><span className="font-bold text-lg text-slate-800">FişMatik</span></div>
                        <nav className="flex-1 p-4 space-y-1">
                            {['dashboard', 'receipts', 'reports', 'team', 'settings', 'about'].map(v => {
                                if (v === 'team' && profile?.role !== 'admin') return null;
                                return (<button key={v} onClick={() => setView(v)} className={`w-full flex items-center gap-3 px-4 py-3 rounded-lg text-sm font-medium transition ${view === v ? 'bg-blue-50 text-primary' : 'text-slate-600 hover:bg-slate-50'}`}><Icon name={v === 'dashboard' ? 'layout-dashboard' : v === 'receipts' ? 'file-text' : v === 'reports' ? 'bar-chart-3' : v === 'team' ? 'users' : v === 'settings' ? 'settings' : 'info'} size={18} /> {v === 'dashboard' ? 'Genel Bakış' : v === 'receipts' ? 'Fişlerim' : v === 'reports' ? 'Raporlar' : v === 'team' ? 'Ekip Yönetimi' : v === 'settings' ? 'Ayarlar' : 'Hakkında'}</button>)
                            })}
                        </nav>
                        <div className="p-4 border-t"><div className="mb-4 text-xs text-slate-500"><p className="font-bold text-slate-800 truncate">{profile?.full_name || user.email}</p><p>Rol: {profile?.role || 'User'}</p></div><button onClick={onLogout} className="w-full flex items-center gap-2 text-red-500 text-sm hover:bg-red-50 p-2 rounded transition"><Icon name="log-out" size={16} /> Çıkış</button></div>
                    </aside>
                    <main className="flex-1 p-4 md:p-8 overflow-y-auto h-screen bg-slate-50">
                        {view === 'dashboard' && (
                            <div className="space-y-6">
                                <div className="grid grid-cols-1 md:grid-cols-3 gap-6"><StatCard title="Toplam Harcama" value={stats.total.toLocaleString('tr-TR', { style: 'currency', currency: 'TRY' })} icon="wallet" color="text-green-600" bg="bg-green-50" /><StatCard title="Toplam Fiş" value={stats.count} icon="file-stack" color="text-blue-600" bg="bg-blue-50" /><StatCard title="Bekleyen" value={stats.pending} icon="clock" color="text-orange-600" bg="bg-orange-50" /></div>
                                <div className="bg-white p-6 rounded border shadow-sm"><h3 className="font-bold mb-4">Son Hareketler</h3><ReceiptsTable receipts={receipts.slice(0, 5)} loading={loading} simple={true} profile={profile} /></div>

                                <div className="bg-white p-6 rounded-xl border border-slate-200 shadow-sm overflow-hidden relative group">
                                    <div className="flex justify-between items-center mb-6 border-b pb-4">
                                        <div className="flex items-center gap-3">
                                            <div className="p-2 bg-purple-100 text-purple-600 rounded-lg"><Icon name="sparkles" size={20} /></div>
                                            <div>
                                                <h3 className="font-bold text-slate-800">Yapay Zeka Harcama Analizi</h3>
                                                <p className="text-xs text-slate-500">Google Gemini ile harcamalarınızı optimize edin.</p>
                                            </div>
                                        </div>
                                        <button
                                            onClick={runAiAnalysis}
                                            disabled={aiLoading || receipts.length === 0}
                                            className="bg-purple-600 text-white px-4 py-2 rounded-lg text-sm font-bold hover:bg-purple-700 transition flex items-center gap-2 disabled:opacity-50"
                                        >
                                            {aiLoading ? <Icon name="loader-2" className="animate-spin" size={18} /> : <Icon name="zap" size={18} />}
                                            Analizi Başlat
                                        </button>
                                    </div>

                                    {aiLoading && (
                                        <div className="py-12 flex flex-col items-center justify-center text-slate-400 animate-pulse">
                                            <Icon name="brain-circuit" size={48} className="mb-4 text-purple-300" />
                                            <p>Yapay zeka verileri inceliyor ve strateji oluşturuyor...</p>
                                        </div>
                                    )}

                                    {aiAnalysis && (
                                        <div className="bg-slate-50 p-6 rounded-xl border border-purple-100 prose prose-slate max-w-none animate-in fade-in slide-in-from-bottom-4 duration-500">
                                            <div dangerouslySetInnerHTML={{ __html: marked.parse(aiAnalysis) }} className="markdown-body" />
                                        </div>
                                    )}

                                    {!aiAnalysis && !aiLoading && (
                                        <div className="py-8 text-center border-2 border-dashed border-slate-100 rounded-xl">
                                            <p className="text-slate-400 text-sm">Hala analiz yapılmadı. "Analizi Başlat" butonuna tıklayarak ilk raporunuzu alın.</p>
                                        </div>
                                    )}
                                </div>
                            </div>
                        )}
                        {view === 'receipts' && <div className="bg-white rounded border shadow-sm p-4 h-full flex flex-col"><div className="flex justify-between mb-4"><h2 className="text-xl font-bold">Fiş Kayıtları</h2><button onClick={fetchData}><Icon name="refresh-ccw" /></button></div><ReceiptsTable receipts={receipts} loading={loading} supabase={sb} refresh={fetchData} onLocalUpdate={handleLocalUpdate} userRole={profile?.role} profile={profile} /></div>}

                        {/* YENİ RAPOR SAYFASI BURADA ÇAĞRILIYOR */}
                        {view === 'reports' && <ReportPage user={user} profile={profile} />}

                        {view === 'team' && <div className="max-w-4xl mx-auto mt-5"><TeamManagement user={user} profile={profile} /></div>}
                        {view === 'settings' && <Settings user={user} profile={profile} />}
                        {view === 'about' && <div className="max-w-3xl mx-auto bg-white p-8 rounded-xl border border-slate-200 shadow-sm animate-in fade-in zoom-in duration-300"><div className="text-center mb-8 border-b border-slate-100 pb-6"><h2 className="text-2xl font-bold text-slate-800">Hakkımızda</h2></div><AboutContent /></div>}
                    </main>
                </div>
            );
        };

        const App = () => {
            const [user, setUser] = useState(null);
            const [profile, setProfile] = useState(null);
            const [pendingApproval, setPendingApproval] = useState(false);
            const [profileLoading, setProfileLoading] = useState(true);

            const fetchProfile = useCallback(async (u) => {
                if (!u?.id) return;
                setProfileLoading(true);
                try {
                    let { data, error } = await sb.from('users').select('*').eq('id', u.id).limit(1);
                    if (error || !data || data.length === 0) {
                        const res = await sb.from('users').select('*').eq('email', u.email).limit(1);
                        if (res.data && res.data.length > 0) data = res.data;
                    }
                    if (data && data.length > 0) {
                        const userProfile = data[0];
                        if (userProfile.status === 'pending' || userProfile.status === 'beklemede') { setPendingApproval(true); setProfile(userProfile); }
                        else { setPendingApproval(false); setProfile(userProfile); }
                    } else { setProfile(null); }
                } catch (e) { setProfile(null); }
                finally { setProfileLoading(false); }
            }, []);

            useEffect(() => {
                let mounted = true;
                sb.auth.getUser().then(({ data }) => {
                    if (mounted && data?.user) { setUser(data.user); fetchProfile(data.user); }
                    else { setProfileLoading(false); }
                });
                const { data: { subscription } } = sb.auth.onAuthStateChange((_, session) => {
                    if (!mounted) return;
                    if (session?.user) { setUser(session.user); fetchProfile(session.user); }
                    else { setUser(null); setProfile(null); setPendingApproval(false); setProfileLoading(false); }
                });
                return () => { mounted = false; if (subscription) subscription.unsubscribe(); };
            }, [fetchProfile]);

            if (profileLoading) return <div className="min-h-screen flex items-center justify-center bg-slate-50"><div className="text-center"><Icon name="loader-2" className="animate-spin h-10 w-10 text-primary mx-auto mb-4" /><p className="text-slate-500">Yükleniyor...</p></div></div>;
            if (!user) return <Login onLogin={() => { }} />;
            if (pendingApproval) {
                return <div className="min-h-screen flex items-center justify-center bg-slate-50 p-4"><div className="bg-white p-8 rounded-xl shadow-xl max-w-md text-center border-t-4 border-yellow-400">Onay Bekleniyor...</div></div>;
            }
            return <Dashboard user={user} profile={profile} onLogout={() => sb.auth.signOut()} supabase={sb} />;
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>

</html>