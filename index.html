<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FişMatik - Akıllı Müşteri Paneli</title>
    
    <!-- GEREKLİ KÜTÜPHANELER (CDN) -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: { sans: ['Inter', 'sans-serif'] },
                    colors: {
                        primary: '#2563eb', 
                        secondary: '#1e293b',
                        ai: '#8b5cf6',
                    }
                }
            }
        }
    </script>
    <style>
        body { background-color: #f8fafc; }
        .glass-panel { background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(10px); border: 1px solid #e2e8f0; }
        .loading-spin { animation: spin 1s linear infinite; }
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .ai-glow { box-shadow: 0 0 15px rgba(139, 92, 246, 0.3); }
        .markdown-body ul { list-style-type: disc; margin-left: 1.5rem; margin-top: 0.5rem; }
        .markdown-body strong { color: #4b5563; font-weight: 700; }
        .markdown-body p { margin-bottom: 0.75rem; }
        
        /* Görsel Manipülasyonu İçin */
        .image-container {
            /* JS ile kontrol edeceğiz, default transition */
            transition: transform 0.2s ease-out;
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo, useCallback, useRef } = React;
        const { createClient } = supabase;

        // --- AYARLAR ---
        const DEFAULT_SB_URL = "https://hequoxateionmtfjzkxl.supabase.co";
        const DEFAULT_SB_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImhlcXVveGF0ZWlvbm10Zmp6a3hsIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjUyNTg5MDAsImV4cCI6MjA4MDgzNDkwMH0.aIiIdWw2l7Kcqa4BavNJQ8ARZrdPnmxD8qSMpTlXYhA";
        
        const N8N_REPORT_WEBHOOK_TEST = "https://n8n.ittyazilim.com/webhook-test/fismatik";
        const N8N_REPORT_WEBHOOK_PROD = "https://n8n.ittyazilim.com/webhook/fismatik";
        const N8N_RESET_PW_WEBHOOK_TEST = "https://n8n.ittyazilim.com/webhook-test/3eafd39c-fdee-406f-88ef-1b9ab4bd555e";
        const N8N_RESET_PW_WEBHOOK_PROD = "https://n8n.ittyazilim.com/webhook/3eafd39c-fdee-406f-88ef-1b9ab4bd555e";
        const N8N_REGISTER_URLS = { TEST: "https://n8n.ittyazilim.com/webhook-test/030dfb1b-49f9-4dc8-82e3-98b884f3065c", PROD: "https://n8n.ittyazilim.com/webhook/030dfb1b-49f9-4dc8-82e3-98b884f3065c" };
        const N8N_ADD_USER_URLS = { TEST: "https://n8n.ittyazilim.com/webhook-test/alt-kullanici-ekle", PROD: "https://n8n.ittyazilim.com/webhook/alt-kullanici-ekle" };

        const sb = createClient(DEFAULT_SB_URL, DEFAULT_SB_KEY);

        const Icon = ({ name, size = 20, className }) => {
            return <i data-lucide={name} width={size} height={size} className={className}></i>;
        };

        const callGemini = async (apiKey, prompt) => {
            const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;
            const response = await fetch(url, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
            });
            const data = await response.json();
            if (data.error) throw new Error(data.error.message);
            return data.candidates?.[0]?.content?.parts?.[0]?.text || "Yanıt alınamadı.";
        };

        // --- YARDIMCI FONKSİYONLAR ---
        const normalizePhone = (phone) => {
            if (!phone) return "";
            let clean = phone.replace(/\D/g, ''); 
            if (clean.startsWith('0')) clean = clean.substring(1);
            if (clean.startsWith('90') && clean.length > 10) clean = clean.substring(2);
            if (clean.length === 10) return "+90" + clean;
            return "+" + clean;
        };

        // --- BİLEŞENLER ---
        
        // YENİ: Veritabanı Onarım Bileşeni (GÜÇLENDİRİLDİ)
        const DatabaseFix = () => {
            const sql = `-- BU KODU SUPABASE > SQL EDITOR EKRANINA YAPIŞTIRIN
-- 1. ID UYUŞMAZLIĞINI DÜZELT (SYNC)
-- E-posta adresi eşleşen ama ID'si farklı olan kayıtları onarır
UPDATE public.users
SET id = au.id
FROM auth.users au
WHERE public.users.email = au.email
AND public.users.id != au.id;

-- 2. GÜVENLİ FONKSİYONU GÜNCELLE (Smart Lookup)
CREATE OR REPLACE FUNCTION public.get_current_user_company_id()
RETURNS bigint
LANGUAGE plpgsql
SECURITY DEFINER
SET search_path = public
AS $$
DECLARE
  c_id bigint;
BEGIN
  -- Önce ID ile dene
  SELECT company_id INTO c_id FROM public.users WHERE id = auth.uid();
  
  -- Bulunamazsa E-posta ile dene (Yedek Plan)
  IF c_id IS NULL THEN
    SELECT u.company_id INTO c_id 
    FROM public.users u
    JOIN auth.users au ON u.email = au.email
    WHERE au.id = auth.uid();
  END IF;
  
  RETURN c_id;
END;
$$;

-- 3. İZİNLERİ SIFIRLA VE YENİDEN VER
GRANT USAGE ON SCHEMA public TO authenticated, service_role;
GRANT ALL ON ALL TABLES IN SCHEMA public TO authenticated, service_role;
GRANT ALL ON ALL SEQUENCES IN SCHEMA public TO authenticated, service_role;

DROP POLICY IF EXISTS "Kategorileri yönet" ON public.categories;
DROP POLICY IF EXISTS "Projeleri yönet" ON public.projects;
DROP POLICY IF EXISTS "Kartları yönet" ON public.company_cards;
DROP POLICY IF EXISTS "Fişleri yönet" ON public.fisler;

ALTER TABLE public.categories ENABLE ROW LEVEL SECURITY;
CREATE POLICY "Kategorileri yönet" ON public.categories FOR ALL USING (company_id = get_current_user_company_id());

ALTER TABLE public.projects ENABLE ROW LEVEL SECURITY;
CREATE POLICY "Projeleri yönet" ON public.projects FOR ALL USING (company_id = get_current_user_company_id());

ALTER TABLE public.company_cards ENABLE ROW LEVEL SECURITY;
CREATE POLICY "Kartları yönet" ON public.company_cards FOR ALL USING (company_id = get_current_user_company_id());

ALTER TABLE public.fisler ENABLE ROW LEVEL SECURITY;
CREATE POLICY "Fişleri yönet" ON public.fisler FOR ALL USING (company_id = get_current_user_company_id());`;

            const copySql = () => {
                navigator.clipboard.writeText(sql);
                alert("GÜÇLÜ ONARIM KODU KOPYALANDI!\n\nBu kod hem yetkileri düzeltir hem de bozulan kullanıcı ID'lerini eşitler.\n\nLütfen Supabase > SQL Editor'de çalıştırın.");
            };

            return (
                <div className="bg-amber-50 p-4 rounded-xl border border-amber-200 mb-8 animate-in fade-in slide-in-from-top-4">
                    <div className="flex items-start gap-3">
                        <div className="text-amber-600 mt-1"><Icon name="alert-triangle" size={24}/></div>
                        <div>
                            <h3 className="font-bold text-amber-800 text-sm">Veritabanı İzin Sorunu Mu Var?</h3>
                            <p className="text-amber-700 text-xs mt-1 mb-3">
                                Eğer "Kaydetme Hatası" veya "Yetkiniz Yok" uyarısı alıyorsanız, veritabanı izinlerini ve kullanıcı eşleşmelerini onarmanız gerekir.
                            </p>
                            <button onClick={copySql} className="bg-amber-600 text-white px-3 py-1.5 rounded text-xs font-medium hover:bg-amber-700 flex items-center gap-1 transition">
                                <Icon name="database" size={14}/> Onarım Kodunu Kopyala (Tam Çözüm)
                            </button>
                        </div>
                    </div>
                </div>
            );
        };

        const MetadataSettings = ({ companyId, type, title, icon }) => {
            const [items, setItems] = useState([]);
            const [newItem, setNewItem] = useState({ name: '', last4: '' });
            const [loading, setLoading] = useState(false);

            useEffect(() => {
                lucide.createIcons();
            }, [items]);

            const fetchItems = useCallback(async () => {
                if (!companyId) {
                    setItems([]);
                    return;
                }
                try {
                    const { data, error } = await sb.from(type).select('*').eq('company_id', companyId).order('id');
                    if (error) {
                        console.warn(`${type} yükleme hatası:`, error);
                        setItems([]);
                    } else {
                        setItems(data || []);
                    }
                } catch (err) {
                    console.error(`${type} yükleme exception:`, err);
                    setItems([]);
                }
            }, [companyId, type]);

            useEffect(() => { if(companyId) fetchItems(); }, [fetchItems]);

            const addItem = async () => {
                if ((type !== 'company_cards' && !newItem.name) || (type === 'company_cards' && !newItem.last4)) return;
                
                if (type === 'company_cards' && newItem.last4.length < 4) return alert("Kart son 4 hanesi en az 4 rakam olmalı.");

                if (!companyId) {
                    alert("Şirket bilgisi bulunamadı. Lütfen tekrar giriş yapın.");
                    return;
                }

                setLoading(true);
                let payload = { company_id: parseInt(companyId) };
                
                if (type === 'categories') {
                    payload.name = newItem.name;
                }
                if (type === 'projects') { 
                    payload.name = newItem.name; 
                }
                if (type === 'company_cards') { 
                    payload.bank_name = 'Kredi Kartı'; 
                    payload.card_alias = `Kart ${newItem.last4}`; 
                    payload.last_4_digits = newItem.last4; 
                }

                try {
                    const { error } = await sb.from(type).insert([payload]);
                    if (error) {
                        console.error(`${type} ekleme hatası:`, error);
                        if (error.code === '42501' || error.message.includes('row-level security')) {
                            alert(`YETKİ HATASI: Kullanıcı ID'niz veritabanıyla uyuşmuyor. Lütfen yukarıdaki 'Onarım Kodunu Kopyala' butonunu kullanın.`);
                        } else {
                            alert("Hata: " + error.message);
                        }
                    } else { 
                        setNewItem({ name: '', last4: '' }); 
                        fetchItems(); 
                    }
                } catch (err) {
                    console.error("Beklenmeyen hata:", err);
                    alert("Bir hata oluştu.");
                } finally {
                    setLoading(false);
                }
            };

            const deleteItem = async (id) => {
                if(!confirm("Silmek istediğinize emin misiniz?")) return;
                try {
                    const { error } = await sb.from(type).delete().eq('id', id);
                    if (error) {
                        alert("Silme hatası: " + error.message);
                    } else {
                        fetchItems();
                    }
                } catch (err) {
                    alert("Bir hata oluştu.");
                }
            };

            return (
                <div className="bg-white p-6 rounded-xl border border-slate-200 shadow-sm mb-6">
                    <div className="flex items-center gap-2 mb-4 text-slate-800 border-b pb-2">
                        <Icon name={icon} size={20} className="text-primary"/> <h3 className="font-bold">{title}</h3>
                    </div>
                    
                    <div className="flex gap-2 mb-4">
                        {type === 'company_cards' ? (
                            <input 
                                className="border p-2 rounded text-sm w-full" 
                                placeholder="Kart Son 4 Rakam (Örn: 4492)" 
                                maxLength="4" 
                                value={newItem.last4} 
                                onChange={e=>setNewItem({...newItem, last4:e.target.value.replace(/\D/g,'')})} 
                            />
                        ) : (
                            <input 
                                className="border p-2 rounded text-sm w-full" 
                                placeholder={`${title} Adı`} 
                                value={newItem.name} 
                                onChange={e=>setNewItem({...newItem, name:e.target.value})} 
                            />
                        )}
                        <button onClick={addItem} disabled={loading} className="bg-green-600 text-white px-4 rounded hover:bg-green-700 disabled:opacity-50 flex items-center justify-center"><Icon name="plus" size={18}/></button>
                    </div>

                    <ul className="space-y-2 max-h-40 overflow-y-auto custom-scrollbar">
                        {items.map(i => (
                            <li key={i.id} className="flex justify-between items-center bg-slate-50 p-2 rounded text-sm border">
                                <span>
                                    {type === 'company_cards' ? `**** **** **** ${i.last_4_digits}` : i.name}
                                </span>
                                <button onClick={()=>deleteItem(i.id)} className="text-red-400 hover:text-red-600"><Icon name="trash-2" size={16}/></button>
                            </li>
                        ))}
                        {items.length === 0 && <li className="text-slate-400 text-xs text-center">Henüz kayıt yok.</li>}
                    </ul>
                </div>
            );
        };

        const StatCard = ({ title, value, icon, color, bg }) => (
            <div className="bg-white p-6 rounded-xl border border-slate-200 shadow-sm flex items-center gap-4">
                <div className={`p-4 rounded-full ${bg} ${color}`}><Icon name={icon} size={24} /></div>
                <div><p className="text-slate-500 text-sm font-medium">{title}</p><p className="text-2xl font-bold text-slate-800">{value}</p></div>
            </div>
        );

        const TeamManagement = ({ user, profile }) => {
            const [users, setUsers] = useState([]);
            const [company, setCompany] = useState(null);
            const [loading, setLoading] = useState(false);
            const [showAddModal, setShowAddModal] = useState(false);
            const [newUser, setNewUser] = useState({ email: '', full_name: '', password: '', role: 'user' });
            const [adding, setAdding] = useState(false);

            const fetchTeam = useCallback(async () => {
                if(!profile?.company_id) return;
                setLoading(true);
                try {
                    const { data: comp, error: compError } = await sb.from('companies').select('*').eq('id', profile.company_id).single();
                    if (compError) console.warn("Şirket bilgisi çekilemedi:", compError);
                    setCompany(comp);
                    const { data: team } = await sb.from('users').select('*').eq('company_id', profile.company_id);
                    setUsers(team || []);
                } catch (err) { console.error("Ekip verisi hatası:", err); }
                setLoading(false);
            }, [profile?.company_id]);

            useEffect(() => { fetchTeam(); }, [fetchTeam]);

            const handleAddUser = async () => {
                if (!company) { alert("Şirket bilgileri yüklenemedi."); return; }
                const maxUsers = company.max_users || 5; 
                if (users.length >= maxUsers) { alert(`Limit (${maxUsers}) doldu.`); return; }
                setAdding(true);
                const isLocalhost = window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1';
                const targetUrl = isLocalhost ? N8N_ADD_USER_URLS.TEST : N8N_ADD_USER_URLS.PROD;
                try {
                    await fetch(targetUrl, {
                        method: 'POST',
                        mode: 'no-cors',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ company_id: profile.company_id, email: newUser.email, full_name: newUser.full_name, password: newUser.password, role: newUser.role, manager_id: user.id })
                    });
                    alert("İstek gönderildi."); setShowAddModal(false); setNewUser({ email: '', full_name: '', password: '', role: 'user' }); setTimeout(fetchTeam, 3000);
                } catch (error) { alert("Hata: " + error.message); } finally { setAdding(false); }
            };

            if (loading) return <div className="text-center p-10 text-slate-400">Yükleniyor...</div>;

            return (
                <div className="space-y-6">
                    <div className="flex justify-between items-center">
                        <div><h2 className="text-2xl font-bold text-slate-800">Ekip Yönetimi</h2><p className="text-slate-500 text-sm">{company?.name || 'Şirket Yükleniyor...'} (Kullanıcılar: {users.length} / {company?.max_users || '-'})</p></div>
                        <button onClick={() => setShowAddModal(true)} className="bg-primary text-white px-4 py-2 rounded-lg flex items-center gap-2 hover:bg-blue-700 transition"><Icon name="user-plus" size={18} /> Yeni Kullanıcı</button>
                    </div>
                    <div className="bg-white rounded-xl border border-slate-200 overflow-hidden">
                        <table className="w-full text-left text-sm">
                            <thead className="bg-slate-50 text-slate-500 uppercase text-xs"><tr><th className="px-6 py-3">Ad Soyad</th><th className="px-6 py-3">E-Posta</th><th className="px-6 py-3">Rol</th><th className="px-6 py-3">Durum</th></tr></thead>
                            <tbody className="divide-y divide-slate-100">
                                {users.map(u => (
                                    <tr key={u.id} className="hover:bg-slate-50">
                                        <td className="px-6 py-4 font-medium text-slate-800">{u.full_name || '-'}</td><td className="px-6 py-4 text-slate-600">{u.email}</td>
                                        <td className="px-6 py-4"><span className={`px-2 py-1 rounded text-xs ${u.role === 'admin' ? 'bg-purple-100 text-purple-700' : 'bg-blue-100 text-blue-700'}`}>{u.role === 'admin' ? 'Yönetici' : 'Personel'}</span></td>
                                        <td className="px-6 py-4">{u.status === 'active' || u.status === 'onaylandi' ? <span className="text-green-600 flex items-center gap-1"><Icon name="check-circle" size={14}/> Aktif</span> : <span className="text-orange-500 flex items-center gap-1"><Icon name="clock" size={14}/> Beklemede</span>}</td>
                                    </tr>
                                ))}
                            </tbody>
                        </table>
                    </div>
                    {showAddModal && (
                        <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-50">
                            <div className="bg-white p-6 rounded-xl shadow-xl w-full max-w-md animate-in fade-in zoom-in duration-200">
                                <h3 className="text-lg font-bold mb-4">Yeni Kullanıcı Ekle</h3>
                                <div className="space-y-3">
                                    <input type="text" placeholder="Ad Soyad" className="w-full p-2 border rounded" value={newUser.full_name} onChange={e=>setNewUser({...newUser, full_name:e.target.value})} />
                                    <input type="email" placeholder="E-Posta" className="w-full p-2 border rounded" value={newUser.email} onChange={e=>setNewUser({...newUser, email:e.target.value})} />
                                    <input type="password" placeholder="Geçici Şifre" className="w-full p-2 border rounded" value={newUser.password} onChange={e=>setNewUser({...newUser, password:e.target.value})} />
                                    <select className="w-full p-2 border rounded" value={newUser.role} onChange={e=>setNewUser({...newUser, role:e.target.value})}><option value="user">Personel</option><option value="admin">Yönetici</option></select>
                                </div>
                                <div className="mt-6 flex justify-end gap-2"><button onClick={()=>setShowAddModal(false)} className="px-4 py-2 text-slate-500 hover:bg-slate-100 rounded">İptal</button><button onClick={handleAddUser} disabled={adding} className="px-4 py-2 bg-primary text-white rounded hover:bg-blue-700 flex items-center gap-2">{adding ? <Icon name="loader-2" className="loading-spin" size={16}/> : <Icon name="user-plus" size={16}/>} Ekle</button></div>
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        const AboutContent = () => (
            <div className="space-y-8 text-left">
                <div className="flex items-start gap-4"><div className="p-3 bg-blue-100 rounded-lg text-primary mt-1"><Icon name="zap" size={24} /></div><div><h3 className="text-lg font-bold text-slate-800 mb-2">FişMatik Nedir?</h3><p className="text-slate-600 leading-relaxed">FişMatik, işletmelerin ve çalışanların harcama fişlerini yapay zeka destekli OCR teknolojisi ile saniyeler içinde dijitalleştiren, raporlayan ve muhasebeleştiren akıllı bir platformdur. Manuel veri girişini ortadan kaldırır, zamandan tasarruf sağlar.</p></div></div>
                <div className="flex items-start gap-4"><div className="p-3 bg-green-100 rounded-lg text-green-600 mt-1"><Icon name="scan-line" size={24} /></div><div><h3 className="text-lg font-bold text-slate-800 mb-2">Nasıl Kullanılır?</h3><ul className="list-disc list-inside text-slate-600 space-y-2"><li>Telegram botumuza fiş fotoğrafını gönderin.</li><li>Yapay zeka fişinizi okur ve sisteme kaydeder.</li><li>Bu panel üzerinden harcamalarınızı görüntüleyin ve düzenleyin.</li><li>Tek tıkla Excel raporunuzu e-posta adresinize alın.</li></ul></div></div>
                <div className="flex items-start gap-4"><div className="p-3 bg-indigo-100 rounded-lg text-indigo-600 mt-1"><Icon name="sparkles" size={24} /></div><div><h3 className="text-lg font-bold text-slate-800 mb-2">Yapay Zeka Analizi</h3><p className="text-slate-600 leading-relaxed">Google Gemini ile harcamalarınızı analiz edin, tasarruf önerileri alın. Ayarlar sayfasında "Google Gemini API Anahtarı" bölümüne Gemini API anahtarınızı girerek bu özelliği aktif edebilirsiniz. sistemdeki fiş kayıtlarınız arttıkça tutarlı sonuçlar verme olasılığı artacaktır.</p></div></div>
                <div className="flex items-start gap-4"><div className="p-3 bg-purple-100 rounded-lg text-purple-600 mt-1"><Icon name="user-plus" size={24} /></div><div><h3 className="text-lg font-bold text-slate-800 mb-2">Nasıl Kayıt Olunur?</h3><div className="bg-slate-50 p-4 rounded-lg border border-slate-200"><p className="text-slate-600 mb-3">FişMatik şu an davetiye ve başvuru usulü ile çalışmaktadır. Sisteme kayıt olmak ve şirketiniz için aktivasyon sağlamak için lütfen Telegram botumuz üzerinden başvuru yapınız.</p><a href="https://t.me/ITT_Fis_matik_BOT" target="_blank" className="inline-flex items-center gap-2 text-primary font-medium hover:underline"><Icon name="send" size={16} /> FişMatik Telegram Botuna Git</a></div></div></div>
            </div>
        );

        const AboutPage = ({ onBack }) => (
            <div className="min-h-screen bg-slate-50 flex flex-col items-center justify-center p-4">
                <div className="max-w-3xl w-full bg-white rounded-2xl shadow-xl overflow-hidden animate-in fade-in zoom-in duration-300">
                    <div className="bg-gradient-to-r from-blue-600 to-indigo-700 p-8 text-center text-white relative"><button onClick={onBack} className="absolute left-6 top-6 p-2 bg-white/10 hover:bg-white/20 rounded-full transition text-white"><Icon name="arrow-left" size={24} /></button><div className="flex justify-center mb-4"><div className="p-3 bg-white/20 rounded-full backdrop-blur-sm"><Icon name="receipt" size={40} /></div></div><h1 className="text-3xl font-bold mb-2">FişMatik</h1><p className="text-blue-100">Akıllı Harcama Yönetim Asistanınız</p></div>
                    <div className="p-8 md:p-12"><AboutContent /></div>
                    <div className="bg-slate-50 p-6 text-center border-t border-slate-100 text-slate-500 text-sm">&copy; 2025 İTT Yazılım. Tüm hakları saklıdır.</div>
                </div>
            </div>
        );

        const ReceiptsTable = ({ receipts, loading, simple, supabase, refresh, onLocalUpdate, userRole, profile }) => {
            const [editItem, setEditItem] = useState(null);
            const [isSaving, setIsSaving] = useState(false);
            const [filters, setFilters] = useState({ tarih: '', isletme_adi: '', toplam_tutar: '', durum: '', kategori: '', kart_son_4: '' });
            const [imgRotation, setImgRotation] = useState(0);
            const [imgZoom, setImgZoom] = useState(1);
            const [pan, setPan] = useState({ x: 0, y: 0 });
            const [isDragging, setIsDragging] = useState(false);
            const [dragStart, setDragStart] = useState({ x: 0, y: 0 });
            
            const [metaCategories, setMetaCategories] = useState([]);
            const [metaProjects, setMetaProjects] = useState([]);

            useEffect(() => {
                if (profile?.company_id) {
                    sb.from('categories').select('*').eq('company_id', profile.company_id).then(({data}) => setMetaCategories(data || []));
                    sb.from('projects').select('*').eq('company_id', profile.company_id).then(({data}) => setMetaProjects(data || []));
                }
            }, [profile?.company_id]);

            useEffect(() => { if (editItem) { setImgRotation(0); setImgZoom(1); setPan({ x: 0, y: 0 }); lucide.createIcons(); } }, [editItem]);
            useEffect(() => { lucide.createIcons(); }, [imgRotation, imgZoom, pan]);
            const handleMouseDown = (e) => { e.preventDefault(); setIsDragging(true); setDragStart({ x: e.clientX - pan.x, y: e.clientY - pan.y }); };
            const handleMouseMove = (e) => { if (!isDragging) return; e.preventDefault(); setPan({ x: e.clientX - dragStart.x, y: e.clientY - dragStart.y }); };
            const handleMouseUp = () => { setIsDragging(false); };

            const getStatusBadge = (status) => {
                const s = status?.toLowerCase() || '';
                let classes = 'bg-gray-100 text-gray-800'; let label = status || '-';
                if (s === 'onaylandi') { classes = 'bg-green-100 text-green-800'; label = 'Onaylandı'; }
                else if (s === 'beklemede') { classes = 'bg-yellow-100 text-yellow-800'; label = 'Beklemede'; }
                else if (s === 'reddedildi') { classes = 'bg-red-100 text-red-800'; label = 'Reddedildi'; }
                else if (s === 'mukerrer') { classes = 'bg-orange-100 text-orange-800'; label = 'Mükerrer'; }
                else if (s === 'rapor alindi' || s === 'rapor alındı' || s === 'rapor_alindi') { classes = 'bg-indigo-100 text-indigo-800'; label = 'Rapor Alındı'; }
                return <span className={`px-2 py-1 rounded text-xs font-medium whitespace-nowrap ${classes}`}>{label}</span>;
            };

            const filtered = useMemo(() => {
                if (simple) return receipts;
                return receipts.filter(r => {
                    const matchTarih = !filters.tarih || r.tarih?.includes(filters.tarih);
                    const matchIsletme = !filters.isletme_adi || r.isletme_adi?.toLowerCase().includes(filters.isletme_adi.toLowerCase());
                    const matchTutar = !filters.toplam_tutar || r.toplam_tutar?.toString().includes(filters.toplam_tutar);
                    const matchKategori = !filters.kategori || r.kategori?.toLowerCase().includes(filters.kategori.toLowerCase());
                    const matchKart = !filters.kart_son_4 || r.kart_son_4?.toString().includes(filters.kart_son_4);
                    let matchDurum = true;
                    if (filters.durum) {
                        const s = r.durum?.toLowerCase() || '';
                        const f = filters.durum.toLowerCase();
                        if (f === 'onaylandi') matchDurum = s === 'onaylandi' || s === 'onaylandı';
                        else if (f === 'mukerrer') matchDurum = s === 'mukerrer' || s === 'mükerrer';
                        else if (f === 'rapor alindi') matchDurum = s.includes('rapor');
                        else matchDurum = s.includes(f);
                    }
                    return matchTarih && matchIsletme && matchTutar && matchDurum && matchKategori && matchKart;
                });
            }, [receipts, filters, simple]);

            const handleSave = async () => {
                setIsSaving(true);
                const updatedItem = { ...editItem };
                const categories = updatedItem.ocr_detaylari?.map(l => l.kategori).filter(Boolean) || [];
                const uniqueCategories = [...new Set(categories)];
                updatedItem.kategori = uniqueCategories.length > 1 ? 'Çoklu' : (uniqueCategories[0] || 'Genel');
                if(onLocalUpdate) onLocalUpdate(updatedItem);
                setEditItem(null); 
                try {
                    await supabase.from('fisler').update({
                        isletme_adi: updatedItem.isletme_adi,
                        toplam_tutar: parseFloat(updatedItem.toplam_tutar),
                        tarih: updatedItem.tarih,
                        durum: updatedItem.durum,
                        kategori: updatedItem.kategori,
                        proje: updatedItem.proje, 
                        ocr_detaylari: updatedItem.ocr_detaylari
                    }).eq('id', updatedItem.id);
                    if (refresh) refresh(); 
                } catch (e) { alert("Hata: " + e.message); if (refresh) refresh(); } finally { setIsSaving(false); }
            };

            const addLine = () => setEditItem({ ...editItem, ocr_detaylari: [...(editItem.ocr_detaylari||[]), {aciklama:'', kategori:'', kdv:18, tutar:0}] });
            const removeLine = (idx) => { const lines = [...editItem.ocr_detaylari]; lines.splice(idx, 1); setEditItem({ ...editItem, ocr_detaylari: lines }); };
            const updateLine = (idx, key, val) => { const lines = [...editItem.ocr_detaylari]; lines[idx][key] = val; setEditItem({ ...editItem, ocr_detaylari: lines }); };

            if (loading) return <div className="p-8 text-center text-slate-400">Yükleniyor...</div>;
            if (receipts.length === 0) return <div className="p-8 text-center text-slate-400">Veri yok.</div>;

            return (
                <>
                    <div className="overflow-x-auto">
                        <table className="w-full text-left text-sm">
                            <thead className="bg-slate-50 text-slate-500 uppercase text-xs sticky top-0">
                                <tr>
                                    <th className="px-6 py-3">Tarih</th><th className="px-6 py-3">İşletme</th><th className="px-6 py-3">Kategori</th><th className="px-6 py-3">Kart Son 4</th><th className="px-6 py-3">Tutar</th><th className="px-6 py-3">Durum</th>{!simple && <th className="px-6 py-3 text-right">İşlem</th>}
                                </tr>
                                {!simple && (
                                    <tr className="bg-slate-100">
                                        <th className="px-2"><input placeholder="Yıl-Ay-Gün" className="w-full p-1 border rounded" onChange={e=>setFilters({...filters, tarih:e.target.value})}/></th>
                                        <th className="px-2"><input placeholder="Ara..." className="w-full p-1 border rounded" onChange={e=>setFilters({...filters, isletme_adi:e.target.value})}/></th>
                                        <th className="px-2"><select className="w-full p-1 border rounded" onChange={e=>setFilters({...filters, kategori:e.target.value})}><option value="">Hepsi</option>{metaCategories.map(c=><option key={c.id} value={c.name}>{c.name}</option>)}</select></th>
                                        <th className="px-2"><input placeholder="Son 4..." className="w-full p-1 border rounded" onChange={e=>setFilters({...filters, kart_son_4:e.target.value})}/></th>
                                        <th className="px-2"><input placeholder="Tutar..." className="w-full p-1 border rounded" onChange={e=>setFilters({...filters, toplam_tutar:e.target.value})}/></th>
                                        <th className="px-2"><select className="w-full p-1 border rounded" onChange={e=>setFilters({...filters, durum:e.target.value})}><option value="">Hepsi</option><option value="beklemede">Beklemede</option><option value="onaylandi">Onaylandı</option><option value="reddedildi">Reddedildi</option><option value="mukerrer">Mükerrer</option><option value="rapor alindi">Rapor Alındı</option></select></th>
                                        <th></th>
                                    </tr>
                                )}
                            </thead>
                            <tbody className="divide-y divide-slate-100">
                                {filtered.map(r => (
                                    <tr key={r.id} className="hover:bg-slate-50 transition group">
                                        <td className="px-6 py-4">{new Date(r.tarih).toLocaleDateString('tr-TR')}</td><td className="px-6 py-4 font-medium">{r.isletme_adi}</td><td className="px-6 py-4 text-slate-500">{r.kategori || '-'}</td><td className="px-6 py-4 text-slate-500">{r.kart_son_4 || '-'}</td><td className="px-6 py-4 font-bold">{r.toplam_tutar?.toLocaleString('tr-TR', {style:'currency', currency:'TRY'})}</td><td className="px-6 py-4">{getStatusBadge(r.durum)}</td>
                                        {!simple && <td className="px-6 py-4 text-right"><button onClick={()=>setEditItem(JSON.parse(JSON.stringify(r)))} className="text-primary hover:bg-blue-50 p-2 rounded"><Icon name="pencil" size={16}/></button></td>}
                                    </tr>
                                ))}
                            </tbody>
                        </table>
                    </div>
                    {editItem && (
                        <div className="fixed inset-0 bg-black/80 flex items-center justify-center z-50 p-4">
                            <div className="bg-white w-full max-w-6xl h-[90vh] rounded-xl flex overflow-hidden shadow-2xl">
                                <div className="w-1/2 bg-slate-900 flex items-center justify-center relative p-4 overflow-hidden group cursor-move" onMouseDown={handleMouseDown} onMouseMove={handleMouseMove} onMouseUp={handleMouseUp} onMouseLeave={handleMouseUp}>
                                    {editItem.gorsel_url ? <div className="image-container" style={{ transform: `translate(${pan.x}px, ${pan.y}px) rotate(${imgRotation}deg) scale(${imgZoom})`, maxWidth:'100%', maxHeight:'100%', display:'flex', alignItems:'center', justifyContent:'center', transition: isDragging?'none':'transform 0.2s ease-out' }}><img src={editItem.gorsel_url} className="max-w-full max-h-full object-contain shadow-lg pointer-events-none" /></div> : <p className="text-white">Görsel Yok</p>}
                                    {editItem.gorsel_url && <a href={editItem.gorsel_url} target="_blank" className="absolute top-4 right-4 bg-white/10 p-2 rounded text-white hover:bg-white/20 transition z-10" onMouseDown={e=>e.stopPropagation()}><Icon name="external-link" size={20}/></a>}
                                    <div className="absolute bottom-6 flex items-center gap-2 bg-slate-800/90 p-2 rounded-full backdrop-blur-sm border border-white/10 shadow-xl z-20 opacity-0 group-hover:opacity-100 transition-opacity duration-300" onMouseDown={e=>e.stopPropagation()}><button onClick={()=>setImgZoom(z=>Math.max(0.5,z-0.25))} className="p-2 text-white"><Icon name="zoom-out"/></button><button onClick={()=>setImgZoom(z=>Math.min(3,z+0.25))} className="p-2 text-white"><Icon name="zoom-in"/></button><button onClick={()=>{setImgZoom(1);setImgRotation(0);setPan({x:0,y:0})}} className="p-2 text-white"><Icon name="refresh-ccw"/></button><button onClick={()=>setImgRotation(r=>r+90)} className="p-2 text-white"><Icon name="rotate-cw"/></button></div>
                                </div>
                                <div className="w-1/2 flex flex-col bg-white">
                                    <div className="p-4 border-b flex justify-between items-center"><h3 className="font-bold text-lg">Fiş Detayları</h3><button onClick={()=>setEditItem(null)}><Icon name="x"/></button></div>
                                    <div className="flex-1 overflow-y-auto p-6 space-y-6">
                                        <div className="grid grid-cols-2 gap-4">
                                            <div><label className="text-xs text-slate-500">İşletme</label><input className="w-full border p-2 rounded" value={editItem.isletme_adi} onChange={e=>setEditItem({...editItem, isletme_adi:e.target.value})} /></div>
                                            <div><label className="text-xs text-slate-500">Tarih</label><input type="datetime-local" className="w-full border p-2 rounded" value={editItem.tarih ? editItem.tarih.slice(0,16) : ''} onChange={e=>setEditItem({...editItem, tarih:e.target.value})} /></div>
                                            <div><label className="text-xs text-slate-500">Tutar</label><input type="number" step="0.01" className="w-full border p-2 rounded font-bold" value={editItem.toplam_tutar} onChange={e=>setEditItem({...editItem, toplam_tutar:e.target.value})} /></div>
                                            <div><label className="text-xs text-slate-500">Durum</label><select className="w-full border p-2 rounded" value={editItem.durum} onChange={e=>setEditItem({...editItem, durum:e.target.value})}><option value="beklemede">Beklemede</option><option value="onaylandi">Onaylandı</option><option value="reddedildi">Reddedildi</option><option value="mukerrer">Mükerrer</option><option value="rapor alindi">Rapor Alındı</option></select></div>
                                            
                                            {/* PROJE SEÇİMİ (YENİ) */}
                                            <div>
                                                <label className="text-xs text-slate-500">Proje</label>
                                                <select className="w-full border p-2 rounded bg-white" value={editItem.proje || ''} onChange={e=>setEditItem({...editItem, proje:e.target.value})}>
                                                    <option value="">Seçiniz</option>
                                                    {metaProjects.map(p => <option key={p.id} value={p.name}>{p.name} ({p.code})</option>)}
                                                    <option value="Genel">Genel</option>
                                                </select>
                                            </div>

                                            <div className="col-span-1"><label className="text-xs text-slate-500">Genel Kategori (Otomatik)</label><input className="w-full border p-2 rounded bg-slate-50 text-slate-500" value={editItem.kategori || 'Otomatik'} disabled /></div>
                                        </div>
                                        <hr/>
                                        <div>
                                            <div className="flex justify-between mb-2 items-center">
                                                <h4 className="font-bold text-sm text-slate-700">Harcama Kalemleri</h4>
                                                <button onClick={addLine} className="text-xs bg-blue-50 text-blue-600 px-3 py-1.5 rounded-full hover:bg-blue-100 transition font-medium flex items-center gap-1"><Icon name="plus" size={14}/> Ekle</button>
                                            </div>
                                            <div className="space-y-2 mb-3">
                                                <div className="grid grid-cols-12 gap-2 text-xs font-bold text-slate-400 px-1"><div className="col-span-4">Açıklama</div><div className="col-span-3">Kategori</div><div className="col-span-2">KDV</div><div className="col-span-2">Tutar</div><div className="col-span-1"></div></div>
                                                {(editItem.ocr_detaylari || []).map((line, i) => (
                                                    <div key={i} className="grid grid-cols-12 gap-2 items-center bg-slate-50 p-2 rounded-lg border border-slate-100 group">
                                                        <div className="col-span-4"><input className="w-full bg-transparent border-b border-transparent focus:border-blue-300 outline-none text-sm transition" value={line.aciklama||line.UrunTuru||''} onChange={e=>updateLine(i,'aciklama',e.target.value)} placeholder="Ürün Adı" /></div>
                                                        <div className="col-span-3">
                                                            {/* Kategori Dropdown'ı Güncellendi */}
                                                            <select className="w-full bg-transparent border-b border-transparent focus:border-blue-300 outline-none text-sm cursor-pointer" value={line.kategori||''} onChange={e=>updateLine(i,'kategori',e.target.value)}>
                                                                <option value="">Seçiniz</option>
                                                                {metaCategories.length > 0 ? metaCategories.map(c => <option key={c.id} value={c.name}>{c.name}</option>) : (
                                                                    <>
                                                                        <option value="Yemek">Yemek</option><option value="Market">Market</option><option value="Yakıt">Yakıt</option><option value="Konaklama">Konaklama</option><option value="Ulaşım">Ulaşım</option><option value="Giyim">Giyim</option><option value="Kırtasiye">Kırtasiye</option><option value="Teknoloji">Teknoloji</option><option value="Temizlik">Temizlik</option><option value="Diğer">Diğer</option>
                                                                    </>
                                                                )}
                                                            </select>
                                                        </div>
                                                        <div className="col-span-2"><input type="number" className="w-full bg-transparent border-b border-transparent focus:border-blue-300 outline-none text-sm" value={line.kdv||line.KDVOrani||0} onChange={e=>updateLine(i,'kdv',e.target.value)} /></div>
                                                        <div className="col-span-2"><input type="number" className="w-full bg-transparent border-b border-transparent focus:border-blue-300 outline-none text-sm font-medium" value={line.tutar||line.Tutar_KDVDahil||0} onChange={e=>updateLine(i,'tutar',e.target.value)} /></div>
                                                        <div className="col-span-1 text-right"><button onClick={()=>removeLine(i)} className="text-slate-400 hover:text-red-500 transition opacity-0 group-hover:opacity-100"><Icon name="trash-2" size={16}/></button></div>
                                                    </div>
                                                ))}
                                            </div>
                                            
                                            {/* YENİ EKLENEN BÜYÜK BUTON */}
                                            <button onClick={addLine} className="w-full py-3 border-2 border-dashed border-slate-200 rounded-xl text-slate-500 hover:border-blue-400 hover:text-blue-600 hover:bg-blue-50 transition flex items-center justify-center gap-2 text-sm font-medium"><Icon name="plus-circle" size={18} /> Yeni Satır Ekle</button>
                                        </div>
                                    </div>
                                    <div className="p-4 border-t flex justify-end gap-2"><button onClick={()=>setEditItem(null)} className="px-4 py-2 text-slate-500 hover:bg-slate-100 rounded">İptal</button><button onClick={handleSave} disabled={isSaving} className="px-6 py-2 bg-green-600 text-white rounded hover:bg-green-700 flex items-center gap-2">{isSaving?<><Icon name="loader-2" className="loading-spin"/> Kaydediliyor...</>:'Kaydet'}</button></div>
                                </div>
                            </div>
                        </div>
                    )}
                </>
            );
        };

        const ReportCard = ({ user, profile }) => {
            const [dates, setDates] = useState({ start: '', end: '' });
            const [loading, setLoading] = useState(false);
            
            // Modified to accept the event object 'e'
            const sendReport = async (e) => {
                if(!dates.start || !dates.end) return alert("Lütfen tarih aralığı seçiniz.");
                setLoading(true);
                const payload = { company_id: profile?.company_id || null, start: dates.start, end: dates.end, email: user.email || 'kullanici@mail.com', source: 'FisMatik_Panel' };
                const isLocalhost = window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1';
                const forceTest = e && e.shiftKey;
                const targetUrl = forceTest ? N8N_REPORT_WEBHOOK_TEST : (isLocalhost ? N8N_REPORT_WEBHOOK_TEST : N8N_REPORT_WEBHOOK_PROD);
                try {
                    await fetch(targetUrl, { method: 'POST', mode: 'no-cors', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                    const envMsg = forceTest ? "(TEST ORTAMI)" : ""; alert(`Rapor isteğiniz alındı ${envMsg}. Raporunuz hazırlandığında mail adresinize gönderilecektir.`);
                } catch (error) { console.error("Webhook hatası:", error); alert("Rapor isteğiniz alındı."); } finally { setLoading(false); }
            };
            return (
                <div className="bg-white p-8 rounded-xl border border-slate-200 shadow-sm text-center"><div className="inline-block p-4 bg-blue-50 rounded-full text-primary mb-4"><Icon name="mail" size={32} /></div><h2 className="text-xl font-bold text-slate-800 mb-2">Rapor Oluştur</h2><div className="flex gap-4 mb-6"><div className="w-1/2 text-left"><label className="text-xs font-semibold text-slate-500">Başlangıç</label><input type="date" className="w-full border p-2 rounded mt-1" value={dates.start} onChange={e=>setDates({...dates, start:e.target.value})} /></div><div className="w-1/2 text-left"><label className="text-xs font-semibold text-slate-500">Bitiş</label><input type="date" className="w-full border p-2 rounded mt-1" value={dates.end} onChange={e=>setDates({...dates, end:e.target.value})} /></div></div><button onClick={sendReport} disabled={loading} className="w-full bg-primary text-white py-3 rounded-lg font-medium hover:bg-blue-700 transition flex justify-center gap-2">{loading ? <><Icon name="loader-2" className="loading-spin" size={18} /> Gönderiliyor...</> : <><Icon name="send" size={18} /> Raporu E-Postala</>}</button></div>
            );
        };

        const Settings = ({ user, profile }) => {
            const [apiKey, setApiKey] = useState(localStorage.getItem('gemini_key') || '');
            const [saved, setSaved] = useState(false);
            const [newPassword, setNewPassword] = useState('');
            const [confirmPassword, setConfirmPassword] = useState('');
            const [passLoading, setPassLoading] = useState(false);
            const [passMsg, setPassMsg] = useState({ type: '', text: '' });
            const saveSettings = () => { localStorage.setItem('gemini_key', apiKey); setSaved(true); setTimeout(() => setSaved(false), 2000); };
            const handleChangePassword = async (e) => { e.preventDefault(); if (newPassword !== confirmPassword) { setPassMsg({ type: 'error', text: 'Şifreler eşleşmiyor.' }); return; } if (newPassword.length < 6) { setPassMsg({ type: 'error', text: 'Şifre en az 6 karakter olmalı.' }); return; } setPassLoading(true); setPassMsg({ type: '', text: '' }); const { error } = await sb.auth.updateUser({ password: newPassword }); if (error) setPassMsg({ type: 'error', text: 'Hata: ' + error.message }); else { setPassMsg({ type: 'success', text: 'Şifre güncellendi.' }); setNewPassword(''); setConfirmPassword(''); } setPassLoading(false); };

            return (
                <div className="max-w-2xl mx-auto mt-10 space-y-8">
                    {/* METADATA AYARLARI (YENİ) - GÜNCELLENDİ: Hata Yönetimi Ekli */}
                    <div className="bg-white p-8 rounded-xl border border-slate-200 shadow-sm">
                        <div className="flex items-center gap-3 mb-6"><div className="p-3 bg-blue-100 rounded-full text-primary"><Icon name="list" size={24} /></div><div><h2 className="text-xl font-bold text-slate-800">Tanımlamalar</h2><p className="text-sm text-slate-500">Kategoriler, Projeler ve Kartlar</p></div></div>
                        <DatabaseFix />
                        <MetadataSettings companyId={profile?.company_id} type="categories" title="Kategoriler" icon="tag" />
                        <MetadataSettings companyId={profile?.company_id} type="projects" title="Projeler" icon="folder" />
                        <MetadataSettings companyId={profile?.company_id} type="company_cards" title="Şirket Kartları" icon="credit-card" />
                    </div>

                    <div className="bg-white p-8 rounded-xl border border-slate-200 shadow-sm"><div className="flex items-center gap-3 mb-6"><div className="p-3 bg-slate-100 rounded-full text-slate-600"><Icon name="sparkles" size={24} /></div><div><h2 className="text-xl font-bold text-slate-800">Yapay Zeka</h2><p className="text-sm text-slate-500">Analiz için API anahtarı</p></div></div><div className="space-y-4"><div><label className="block text-sm font-medium text-slate-700 mb-1">Google Gemini API Anahtarı</label><input type="password" value={apiKey} onChange={e=>setApiKey(e.target.value)} placeholder="AIzaSy..." className="w-full p-3 border rounded-lg focus:ring-2 focus:ring-ai outline-none font-mono text-sm"/></div><button onClick={saveSettings} className="px-6 py-2 bg-slate-800 text-white rounded-lg hover:bg-slate-900 transition flex items-center gap-2">{saved ? <Icon name="check" size={18} /> : <Icon name="save" size={18} />} {saved ? 'Kaydedildi' : 'Kaydet'}</button></div></div>
                    <div className="bg-white p-8 rounded-xl border border-slate-200 shadow-sm"><div className="flex items-center gap-3 mb-6"><div className="p-3 bg-slate-100 rounded-full text-slate-600"><Icon name="lock" size={24} /></div><div><h2 className="text-xl font-bold text-slate-800">Güvenlik</h2><p className="text-sm text-slate-500">Şifrenizi güncelleyin</p></div></div><form onSubmit={handleChangePassword} className="space-y-4"><div><label className="block text-sm font-medium text-slate-700 mb-1">Yeni Şifre</label><input type="password" value={newPassword} onChange={e=>setNewPassword(e.target.value)} className="w-full p-3 border rounded-lg focus:ring-2 focus:ring-primary outline-none" required /></div><div><label className="block text-sm font-medium text-slate-700 mb-1">Yeni Şifre (Tekrar)</label><input type="password" value={confirmPassword} onChange={e=>setConfirmPassword(e.target.value)} className="w-full p-3 border rounded-lg focus:ring-2 focus:ring-primary outline-none" required /></div>{passMsg.text && (<div className={`p-3 rounded text-sm ${passMsg.type === 'error' ? 'bg-red-50 text-red-600' : 'bg-green-50 text-green-600'}`}>{passMsg.text}</div>)}<button disabled={passLoading} className="px-6 py-2 bg-primary text-white rounded-lg hover:bg-blue-700 transition flex items-center gap-2">{passLoading ? <Icon name="loader-2" className="loading-spin" /> : 'Şifreyi Güncelle'}</button></form></div>
                </div>
            );
        };

        const Login = ({ onLogin }) => {
            const [email, setEmail] = useState(''); const [password, setPassword] = useState(''); const [loading, setLoading] = useState(false); const [error, setError] = useState(''); const [info, setInfo] = useState(''); const [view, setView] = useState('login'); const [regData, setRegData] = useState({ company_name: '', tax_no: '', full_name: '', email: '', password: '', first_name: '', last_name: '', phone: '', tax_office: '' });
            const shiftKeyRef = useRef(false);
            const handleLogin = async (e) => { e.preventDefault(); setLoading(true); setError(''); const { data, error } = await sb.auth.signInWithPassword({ email, password }); if (error) setError("Giriş başarısız: " + error.message); setLoading(false); };
            const handleRegister = async (e) => { e.preventDefault(); setLoading(true); setError(''); const isLocalhost = window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1'; const forceTest = shiftKeyRef.current; shiftKeyRef.current = false; const targetUrl = forceTest ? N8N_REGISTER_URLS.TEST : (isLocalhost ? N8N_REGISTER_URLS.TEST : N8N_REGISTER_URLS.PROD); const payload = { "telegram_id": "", "Adınız": regData.first_name, "Soyadınız": regData.last_name, "Mail Adresiniz": regData.email, "Telefon Numaranız": normalizePhone(regData.phone), "Şirketiniz": regData.company_name, "Vergi Dairesi": regData.tax_office, "Vergi Numarası": regData.tax_no, "password": regData.password }; try { await fetch(targetUrl, { method: 'POST', mode: 'no-cors', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) }); setInfo("✅ Kayıt talebiniz alındı! Yönetici onayından sonra giriş yapabileceksiniz."); setView('login'); } catch (e) { setError("Kayıt hatası: " + e.message); } setLoading(false); };
            const handleReset = async (e) => { e.preventDefault(); setLoading(true); setError(''); setInfo(''); const isLocal = window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1'; const forceTest = shiftKeyRef.current; shiftKeyRef.current = false; const url = forceTest ? N8N_RESET_PW_WEBHOOK_TEST : (isLocal ? N8N_RESET_PW_WEBHOOK_TEST : N8N_RESET_PW_WEBHOOK_PROD); try { await fetch(url, { method: 'POST', mode: 'no-cors', headers: {'Content-Type':'application/json'}, body: JSON.stringify({ email, source: 'FisMatik_Login_Reset' }) }); setInfo(`✅ Talep gönderildi.${forceTest?'(T)':''}`); } catch (e) { setError("Hata."); } setLoading(false); };
            return (
                <div className="min-h-screen flex items-center justify-center p-4 bg-slate-50">
                    <div className="glass-panel p-8 rounded-2xl shadow-xl w-full max-w-sm animate-in fade-in zoom-in duration-300">
                        {view === 'login' && (<><div className="flex justify-center mb-4 text-primary"><Icon name="receipt" size={48} /></div><h1 className="text-2xl font-bold text-center text-slate-800 mb-2">FişMatik</h1><p className="text-center text-slate-500 text-sm mb-6">Akıllı Müşteri Paneline Giriş</p><form onSubmit={handleLogin} className="space-y-4"><input type="email" placeholder="E-Posta" value={email} onChange={e=>setEmail(e.target.value)} className="w-full p-3 border rounded-lg" required /><input type="password" placeholder="Şifre" value={password} onChange={e=>setPassword(e.target.value)} className="w-full p-3 border rounded-lg" required />{info && <div className="p-3 bg-green-50 text-green-700 text-xs rounded border border-green-100">{info}</div>}{error && <p className="text-red-500 text-xs">{error}</p>}<button disabled={loading} className="w-full bg-primary text-white py-3 rounded-lg">{loading ? <Icon name="loader-2" className="loading-spin"/> : 'Giriş Yap'}</button><div className="flex flex-col gap-2 mt-4 text-center"><button type="button" onClick={()=>setView('forgot')} className="text-xs text-slate-500 hover:text-primary">Şifremi Unuttum</button><div className="flex justify-between mt-2"><button type="button" onClick={()=>setView('register')} className="text-sm text-primary font-bold hover:underline">Kayıt Ol</button><button type="button" onClick={()=>setView('about')} className="text-sm text-slate-600 hover:underline">FişMatik Nedir?</button></div></div></form></>)}
                        {view === 'register' && (<><div className="flex justify-center mb-4 text-purple-600"><Icon name="user-plus" size={48} /></div><h2 className="text-xl font-bold text-center mb-4">Yeni Hesap Oluştur</h2>
                            <form onSubmit={handleRegister} className="space-y-3">
                                <div className="flex gap-2"><input type="text" placeholder="Adınız" className="w-1/2 p-3 border rounded-lg text-sm" value={regData.first_name} onChange={e=>setRegData({...regData, first_name:e.target.value})} required /><input type="text" placeholder="Soyadınız" className="w-1/2 p-3 border rounded-lg text-sm" value={regData.last_name} onChange={e=>setRegData({...regData, last_name:e.target.value})} required /></div>
                                <input type="email" placeholder="E-Posta" className="w-full p-3 border rounded-lg text-sm" value={regData.email} onChange={e=>setRegData({...regData, email:e.target.value})} required /><input type="text" placeholder="Telefon (5XX...)" className="w-full p-3 border rounded-lg text-sm" value={regData.phone} onChange={e=>setRegData({...regData, phone:e.target.value})} required /><input type="text" placeholder="Şirket Adı" className="w-full p-3 border rounded-lg text-sm mt-4" value={regData.company_name} onChange={e=>setRegData({...regData, company_name:e.target.value})} required /><div className="flex gap-2"><input type="text" placeholder="Vergi Dairesi" className="w-1/2 p-3 border rounded-lg text-sm" value={regData.tax_office} onChange={e=>setRegData({...regData, tax_office:e.target.value})} required /><input type="text" placeholder="Vergi No / T.C." className="w-1/2 p-3 border rounded-lg text-sm" value={regData.tax_no} onChange={e=>setRegData({...regData, tax_no:e.target.value})} required /></div><input type="password" placeholder="Şifre Belirleyin" className="w-full p-3 border rounded-lg text-sm mt-2" value={regData.password} onChange={e=>setRegData({...regData, password:e.target.value})} required />{error && <p className="text-red-500 text-xs">{error}</p>}
                                {/* onClick ile Shift kontrolü yapıyoruz, type="button" ile form submit'i engelliyoruz */}
                                <button type="button" disabled={loading} onClick={(e) => { shiftKeyRef.current = e.shiftKey; handleRegister(e); }} className="w-full bg-purple-600 text-white py-3 rounded-lg hover:bg-purple-700 transition">{loading ? <Icon name="loader-2" className="loading-spin"/> : 'Kayıt Ol ve Onaya Gönder'}</button>
                                <button type="button" onClick={()=>setView('login')} className="w-full text-slate-500 text-sm mt-2">Girişe Dön</button>
                            </form>
                        </>)}
                        {view === 'forgot' && (<form onSubmit={handleReset} className="space-y-4"><h3 className="text-center font-bold">Şifre Sıfırlama</h3><input type="email" placeholder="E-Posta" value={email} onChange={e=>setEmail(e.target.value)} className="w-full p-3 border rounded-lg" required />
                            {/* onClick ile Shift kontrolü yapıyoruz */}
                            <button type="button" disabled={loading} onClick={(e) => { shiftKeyRef.current = e.shiftKey; handleReset(e); }} className="w-full bg-primary text-white py-3 rounded-lg">Link Gönder</button>
                            <button type="button" onClick={()=>setView('login')} className="w-full text-slate-500 text-sm">İptal</button></form>
                        )}
                        {view === 'about' && (<div className="text-left"><div className="flex items-center gap-2 mb-4 text-primary"><button onClick={()=>setView('login')} className="p-1 hover:bg-blue-50 rounded-full"><Icon name="arrow-left" size={20} /></button><span className="font-bold text-lg">Hakkımızda</span></div><div className="max-h-[60vh] overflow-y-auto pr-2 space-y-6 custom-scrollbar"><AboutContent /></div></div>)}
                    </div>
                </div>
            );
        };

        const Dashboard = ({ user, profile, supabase, onLogout }) => {
            const [view, setView] = useState('dashboard');
            const [receipts, setReceipts] = useState([]);
            const [loading, setLoading] = useState(true);
            const [stats, setStats] = useState({ total:0, count:0, pending:0 });
            const [aiAnalysis, setAiAnalysis] = useState(null);
            const [aiLoading, setAiLoading] = useState(false);

            // Veri Çekme - Hata Yönetimi ve Profil/Kullanıcı Kontrolü
            const fetchData = useCallback(async () => {
                if(!user?.id) return;
                
                setLoading(true);
                try {
                    let q = sb.from('fisler').select('*').order('tarih', { ascending: false });
                    
                    if (profile?.company_id) {
                        q = q.eq('company_id', profile.company_id);
                    } else {
                        q = q.eq('user_id', user.id);
                    }

                    const { data, error } = await q;

                    if (!error) {
                        setReceipts(data || []);
                        const total = (data||[]).reduce((a,b)=>a+(b.toplam_tutar||0),0);
                        const pending = (data||[]).filter(r=>r.durum==='beklemede').length;
                        setStats({ total, count: data.length, pending });
                    }
                } catch(e) { console.error(e); }
                setLoading(false);
            }, [user?.id, profile?.company_id]);

            // Yerel (Optimistic) Güncelleme
            const handleLocalUpdate = (updatedItem) => {
                setReceipts(prev => prev.map(r => r.id === updatedItem.id ? updatedItem : r));
            };

            const runAiAnalysis = async () => {
                const apiKey = localStorage.getItem('gemini_key');
                if(!apiKey) return alert("API Anahtarı eksik.");
                setAiLoading(true);
                const data = { total: stats.total, count: stats.count, recent: receipts.slice(0,10) };
                const prompt = `Analiz et: ${JSON.stringify(data)}. Türkçe, Markdown.`;
                try {
                    const res = await callGemini(apiKey, prompt);
                    setAiAnalysis(res);
                } catch(e) { alert(e.message); }
                setAiLoading(false);
            };

            useEffect(() => { fetchData(); }, [fetchData]);
            useEffect(() => { lucide.createIcons(); }, [view, receipts, aiAnalysis]);

            return (
                <div className="min-h-screen flex flex-col md:flex-row">
                    <aside className="w-full md:w-64 bg-white border-r border-slate-200 flex flex-col z-20">
                        <div className="p-6 flex items-center gap-2 border-b border-slate-100"><Icon name="receipt" className="text-primary" /><span className="font-bold text-lg text-slate-800">FişMatik</span></div>
                        <nav className="flex-1 p-4 space-y-1">
                            {['dashboard','receipts','reports','team','settings','about'].map(v => {
                                // Ekip yönetimi sadece admin için
                                if (v === 'team' && profile?.role !== 'admin') return null;
                                return (
                                    <button key={v} onClick={()=>setView(v)} className={`w-full flex items-center gap-3 px-4 py-3 rounded-lg text-sm font-medium transition ${view===v?'bg-blue-50 text-primary':'text-slate-600 hover:bg-slate-50'}`}>
                                        <Icon name={v==='dashboard'?'layout-dashboard':v==='receipts'?'file-text':v==='reports'?'bar-chart-3':v==='team'?'users':v==='settings'?'settings':'info'} size={18}/> 
                                        {v==='dashboard'?'Genel Bakış':v==='receipts'?'Fişlerim':v==='reports'?'Raporlar':v==='team'?'Ekip Yönetimi':v==='settings'?'Ayarlar':'Hakkında'}
                                    </button>
                                )
                            })}
                        </nav>
                        <div className="p-4 border-t"><div className="mb-4 text-xs text-slate-500"><p className="font-bold text-slate-800 truncate">{profile?.full_name || user.email}</p><p>Rol: {profile?.role || 'User'}</p></div><button onClick={onLogout} className="w-full flex items-center gap-2 text-red-500 text-sm hover:bg-red-50 p-2 rounded transition"><Icon name="log-out" size={16}/> Çıkış</button></div>
                    </aside>
                    <main className="flex-1 p-4 md:p-8 overflow-y-auto h-screen bg-slate-50">
                        {view==='dashboard' && (
                            <div className="space-y-6">
                                <div className="flex justify-between items-center"><h2 className="text-2xl font-bold">Hoş Geldiniz</h2><button onClick={runAiAnalysis} disabled={aiLoading} className="px-4 py-2 bg-gradient-to-r from-violet-600 to-indigo-600 text-white rounded shadow flex gap-2 items-center">{aiLoading?<Icon name="loader-2" className="loading-spin"/>:<Icon name="sparkles"/>} Analiz</button></div>
                                {aiAnalysis && <div className="bg-white p-6 rounded border border-violet-100 shadow ai-glow relative"><div className="text-sm markdown-body" dangerouslySetInnerHTML={{__html:marked.parse(aiAnalysis)}}></div><button onClick={()=>setAiAnalysis(null)} className="absolute top-4 right-4"><Icon name="x"/></button></div>}
                                <div className="grid grid-cols-1 md:grid-cols-3 gap-6">
                                    <StatCard title="Toplam Harcama" value={stats.total.toLocaleString('tr-TR',{style:'currency',currency:'TRY'})} icon="wallet" color="text-green-600" bg="bg-green-50"/>
                                    <StatCard title="Toplam Fiş" value={stats.count} icon="file-stack" color="text-blue-600" bg="bg-blue-50"/>
                                    <StatCard title="Bekleyen" value={stats.pending} icon="clock" color="text-orange-600" bg="bg-orange-50"/>
                                </div>
                                <div className="bg-white p-6 rounded border shadow-sm"><h3 className="font-bold mb-4">Son Hareketler</h3><ReceiptsTable receipts={receipts.slice(0,5)} loading={loading} simple={true} /></div>
                            </div>
                        )}
                        {view==='receipts' && <div className="bg-white rounded border shadow-sm p-4 h-full flex flex-col"><div className="flex justify-between mb-4"><h2 className="text-xl font-bold">Fiş Kayıtları</h2><button onClick={fetchData}><Icon name="refresh-ccw"/></button></div><ReceiptsTable receipts={receipts} loading={loading} supabase={sb} refresh={fetchData} onLocalUpdate={handleLocalUpdate} userRole={profile?.role} profile={profile} /></div>}
                        {view==='reports' && <div className="max-w-xl mx-auto mt-10"><ReportCard user={user} profile={profile}/></div>}
                        {view==='team' && <div className="max-w-4xl mx-auto mt-5"><TeamManagement user={user} profile={profile} /></div>}
                        {view==='settings' && <Settings user={user} profile={profile} />}
                        {view==='about' && <div className="max-w-3xl mx-auto bg-white p-8 rounded-xl border border-slate-200 shadow-sm animate-in fade-in zoom-in duration-300"><div className="text-center mb-8 border-b border-slate-100 pb-6"><h2 className="text-2xl font-bold text-slate-800">Hakkımızda</h2></div><AboutContent /></div>}
                    </main>
                </div>
            );
        };

        // --- APP ---
        const App = () => {
            const [user, setUser] = useState(null);
            const [profile, setProfile] = useState(null);
            const [pendingApproval, setPendingApproval] = useState(false);
            const [profileLoading, setProfileLoading] = useState(true);

            const fetchProfile = useCallback(async (u) => {
                if(!u?.id) return;
                setProfileLoading(true);
                try {
                    console.log("Profil Yükleniyor...", u.id);
                    let { data, error } = await sb.from('users').select('*').eq('id', u.id).limit(1);
                    if(error || !data || data.length === 0) {
                        console.log("Profil ID ile bulunamadı, email ile deneniyor...", u.email);
                        const res = await sb.from('users').select('*').eq('email', u.email).limit(1);
                        if(res.data && res.data.length > 0) { data = res.data; error = res.error; }
                    }
                    if(data && data.length > 0) {
                        const userProfile = data[0];
                        console.log("Profil Bulundu:", userProfile);
                        if (userProfile.status === 'pending' || userProfile.status === 'beklemede') { setPendingApproval(true); setProfile(userProfile); } 
                        else { setPendingApproval(false); setProfile(userProfile); }
                    } else { console.warn("Profil bulunamadı"); setProfile(null); }
                } catch(e) { console.error("Profil Fetch Exception:", e); setProfile(null); }
                finally { setProfileLoading(false); }
            }, []);

            useEffect(() => {
                let mounted = true;
                sb.auth.getUser().then(({data}) => { 
                    if(mounted && data?.user) { setUser(data.user); fetchProfile(data.user); } 
                    else { setProfileLoading(false); }
                });
                const { data: { subscription } } = sb.auth.onAuthStateChange((_, session) => { 
                    if(!mounted) return;
                    if(session?.user) { setUser(session.user); fetchProfile(session.user); } 
                    else { setUser(null); setProfile(null); setPendingApproval(false); setProfileLoading(false); }
                });
                return () => { mounted = false; if(subscription) subscription.unsubscribe(); };
            }, [fetchProfile]);

            if (profileLoading) return <div className="min-h-screen flex items-center justify-center bg-slate-50"><div className="text-center"><Icon name="loader-2" className="animate-spin h-10 w-10 text-primary mx-auto mb-4" /><p className="text-slate-500">Yükleniyor...</p></div></div>;
            if(!user) return <Login onLogin={()=>{}} />;
            if (pendingApproval) {
                return (
                    <div className="min-h-screen flex items-center justify-center bg-slate-50 p-4">
                        <div className="bg-white p-8 rounded-xl shadow-xl max-w-md text-center border-t-4 border-yellow-400">
                            <div className="inline-block p-4 bg-yellow-50 rounded-full text-yellow-600 mb-4"><Icon name="clock" size={40} /></div><h2 className="text-2xl font-bold text-slate-800 mb-2">Onay Bekleniyor</h2><p className="text-slate-600 mb-6">Hesabınız oluşturuldu ancak yönetici onayı bekleniyor. Onaylandığında size e-posta ile bilgi verilecektir.</p><button onClick={()=>sb.auth.signOut()} className="text-slate-500 hover:text-slate-800 underline">Çıkış Yap</button>
                        </div>
                    </div>
                );
            }
            return <Dashboard user={user} profile={profile} onLogout={()=>sb.auth.signOut()} supabase={sb} />;
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>