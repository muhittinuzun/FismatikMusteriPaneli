<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FiÅŸMatik - AkÄ±llÄ± MÃ¼ÅŸteri Paneli</title>
    
    <!-- GEREKLÄ° KÃœTÃœPHANELER (CDN) -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: { sans: ['Inter', 'sans-serif'] },
                    colors: {
                        primary: '#2563eb', 
                        secondary: '#1e293b',
                        ai: '#8b5cf6',
                    }
                }
            }
        }
    </script>
    <style>
        body { background-color: #f8fafc; }
        .glass-panel { background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(10px); border: 1px solid #e2e8f0; }
        .loading-spin { animation: spin 1s linear infinite; }
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .ai-glow { box-shadow: 0 0 15px rgba(139, 92, 246, 0.3); }
        .markdown-body ul { list-style-type: disc; margin-left: 1.5rem; margin-top: 0.5rem; }
        .markdown-body strong { color: #4b5563; font-weight: 700; }
        .markdown-body p { margin-bottom: 0.75rem; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo } = React;
        const { createClient } = supabase;

        // --- SABÄ°T AYARLAR ---
        const DEFAULT_SB_URL = "https://hequoxateionmtfjzkxl.supabase.co";
        const DEFAULT_SB_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImhlcXVveGF0ZWlvbm10Zmp6a3hsIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjUyNTg5MDAsImV4cCI6MjA4MDgzNDkwMH0.aIiIdWw2l7Kcqa4BavNJQ8ARZrdPnmxD8qSMpTlXYhA";
        
        // n8n Webhook Adresleri
        const N8N_REPORT_WEBHOOK = "https://n8n.ittyazilim.com/webhook/rapor-olustur";
        const N8N_RESET_PASSWORD_WEBHOOK = "https://n8n.ittyazilim.com/webhook/3eafd39c-fdee-406f-88ef-1b9ab4bd555e";

        // Global Supabase Client
        const sb = createClient(DEFAULT_SB_URL, DEFAULT_SB_KEY);

        const Icon = ({ name, size = 20, className }) => {
            return <i data-lucide={name} width={size} height={size} className={className}></i>;
        };

        const callGemini = async (apiKey, prompt) => {
            const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;
            const response = await fetch(url, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
            });
            const data = await response.json();
            if (data.error) throw new Error(data.error.message);
            return data.candidates?.[0]?.content?.parts?.[0]?.text || "YanÄ±t alÄ±namadÄ±.";
        };

        const Login = ({ onLogin }) => {
            const [email, setEmail] = useState('');
            const [password, setPassword] = useState('');
            const [loading, setLoading] = useState(false);
            const [error, setError] = useState('');
            const [info, setInfo] = useState('');
            const [view, setView] = useState('login'); // 'login' or 'forgot'

            const handleLogin = async (e) => {
                e.preventDefault();
                setLoading(true);
                setError('');
                const { data, error } = await sb.auth.signInWithPassword({ email, password });
                if (error) setError("GiriÅŸ baÅŸarÄ±sÄ±z: " + error.message);
                // onLogin App componentinde session listener ile tetiklenecek
                setLoading(false);
            };

            const handleResetPassword = async (e) => {
                e.preventDefault();
                setLoading(true);
                setError('');
                setInfo('');
                
                try {
                    // Supabase yerine n8n Webhook'u tetikliyoruz
                    const response = await fetch(N8N_RESET_PASSWORD_WEBHOOK, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ email: email })
                    });

                    if (response.ok) {
                        setInfo("âœ… Åžifre sÄ±fÄ±rlama talebiniz alÄ±ndÄ±. LÃ¼tfen e-posta kutunuzu (ve spam klasÃ¶rÃ¼nÃ¼) kontrol ediniz.");
                    } else {
                        throw new Error("Sunucuya ulaÅŸÄ±lamadÄ±, lÃ¼tfen daha sonra tekrar deneyin.");
                    }
                } catch (err) {
                    setError("Hata: " + err.message);
                } finally {
                    setLoading(false);
                }
            };

            return (
                <div className="min-h-screen flex items-center justify-center p-4 bg-slate-50">
                    <div className="glass-panel p-8 rounded-2xl shadow-xl w-full max-w-sm">
                        <div className="flex justify-center mb-4 text-primary"><Icon name="receipt" size={48} /></div>
                        <h1 className="text-2xl font-bold text-center text-slate-800 mb-2">FiÅŸMatik</h1>
                        <p className="text-center text-slate-500 text-sm mb-6">AkÄ±llÄ± MÃ¼ÅŸteri Paneli</p>
                        
                        {view === 'login' ? (
                            <form onSubmit={handleLogin} className="space-y-4">
                                <input type="email" placeholder="E-Posta" value={email} onChange={e=>setEmail(e.target.value)} className="w-full p-3 border rounded-lg focus:ring-2 focus:ring-primary outline-none" required />
                                <input type="password" placeholder="Åžifre" value={password} onChange={e=>setPassword(e.target.value)} className="w-full p-3 border rounded-lg focus:ring-2 focus:ring-primary outline-none" required />
                                {error && <p className="text-red-500 text-xs">{error}</p>}
                                <button disabled={loading} className="w-full bg-primary text-white py-3 rounded-lg font-medium hover:bg-blue-700 transition flex justify-center">{loading ? <Icon name="loader-2" className="loading-spin" /> : 'GiriÅŸ Yap'}</button>
                                <div className="text-center mt-4">
                                    <button type="button" onClick={() => setView('forgot')} className="text-xs text-primary hover:underline">Åžifremi Unuttum</button>
                                </div>
                            </form>
                        ) : (
                            <form onSubmit={handleResetPassword} className="space-y-4">
                                <div className="text-center mb-4">
                                    <h3 className="font-semibold text-slate-700">Åžifre SÄ±fÄ±rlama</h3>
                                    <p className="text-xs text-slate-500">E-posta adresinizi girin, size yeni bir ÅŸifre gÃ¶nderelim.</p>
                                </div>
                                <input type="email" placeholder="E-Posta" value={email} onChange={e=>setEmail(e.target.value)} className="w-full p-3 border rounded-lg focus:ring-2 focus:ring-primary outline-none" required />
                                {error && <p className="text-red-500 text-xs">{error}</p>}
                                {info && <div className="text-green-700 text-xs bg-green-50 p-3 rounded border border-green-200">{info}</div>}
                                <button disabled={loading} className="w-full bg-primary text-white py-3 rounded-lg font-medium hover:bg-blue-700 transition flex justify-center">{loading ? <Icon name="loader-2" className="loading-spin" /> : 'SÄ±fÄ±rlama Talebi GÃ¶nder'}</button>
                                <div className="text-center mt-4">
                                    <button type="button" onClick={() => setView('login')} className="text-xs text-slate-500 hover:text-slate-700">GiriÅŸ EkranÄ±na DÃ¶n</button>
                                </div>
                            </form>
                        )}
                    </div>
                </div>
            );
        };

        const Settings = ({ user }) => {
            const [apiKey, setApiKey] = useState(localStorage.getItem('gemini_key') || '');
            const [saved, setSaved] = useState(false);
            
            // Åžifre DeÄŸiÅŸtirme State'leri
            const [newPassword, setNewPassword] = useState('');
            const [confirmPassword, setConfirmPassword] = useState('');
            const [passLoading, setPassLoading] = useState(false);
            const [passMsg, setPassMsg] = useState({ type: '', text: '' });

            const saveSettings = () => {
                localStorage.setItem('gemini_key', apiKey);
                setSaved(true); setTimeout(() => setSaved(false), 2000);
            };

            const handleChangePassword = async (e) => {
                e.preventDefault();
                if (newPassword !== confirmPassword) {
                    setPassMsg({ type: 'error', text: 'Åžifreler eÅŸleÅŸmiyor.' });
                    return;
                }
                if (newPassword.length < 6) {
                    setPassMsg({ type: 'error', text: 'Åžifre en az 6 karakter olmalÄ±.' });
                    return;
                }

                setPassLoading(true);
                setPassMsg({ type: '', text: '' });

                const { error } = await sb.auth.updateUser({ password: newPassword });

                if (error) {
                    setPassMsg({ type: 'error', text: 'Hata: ' + error.message });
                } else {
                    setPassMsg({ type: 'success', text: 'Åžifreniz baÅŸarÄ±yla gÃ¼ncellendi.' });
                    setNewPassword('');
                    setConfirmPassword('');
                }
                setPassLoading(false);
            };

            return (
                <div className="max-w-2xl mx-auto mt-10 space-y-8">
                    {/* Gemini AyarlarÄ± */}
                    <div className="bg-white p-8 rounded-xl border border-slate-200 shadow-sm">
                        <div className="flex items-center gap-3 mb-6">
                            <div className="p-3 bg-slate-100 rounded-full text-slate-600"><Icon name="sparkles" size={24} /></div>
                            <div><h2 className="text-xl font-bold text-slate-800">Yapay Zeka</h2><p className="text-sm text-slate-500">Analiz iÃ§in API anahtarÄ±</p></div>
                        </div>
                        <div className="space-y-4">
                            <div>
                                <label className="block text-sm font-medium text-slate-700 mb-1">Google Gemini API AnahtarÄ±</label>
                                <input type="password" value={apiKey} onChange={e=>setApiKey(e.target.value)} placeholder="AIzaSy..." className="w-full p-3 border rounded-lg focus:ring-2 focus:ring-ai outline-none font-mono text-sm"/>
                            </div>
                            <button onClick={saveSettings} className="px-6 py-2 bg-slate-800 text-white rounded-lg hover:bg-slate-900 transition flex items-center gap-2">{saved ? <Icon name="check" size={18} /> : <Icon name="save" size={18} />} {saved ? 'Kaydedildi' : 'Kaydet'}</button>
                        </div>
                    </div>

                    {/* Åžifre DeÄŸiÅŸtirme */}
                    <div className="bg-white p-8 rounded-xl border border-slate-200 shadow-sm">
                        <div className="flex items-center gap-3 mb-6">
                            <div className="p-3 bg-slate-100 rounded-full text-slate-600"><Icon name="lock" size={24} /></div>
                            <div><h2 className="text-xl font-bold text-slate-800">GÃ¼venlik</h2><p className="text-sm text-slate-500">Åžifrenizi gÃ¼ncelleyin</p></div>
                        </div>
                        <form onSubmit={handleChangePassword} className="space-y-4">
                            <div>
                                <label className="block text-sm font-medium text-slate-700 mb-1">Yeni Åžifre</label>
                                <input type="password" value={newPassword} onChange={e=>setNewPassword(e.target.value)} className="w-full p-3 border rounded-lg focus:ring-2 focus:ring-primary outline-none" required />
                            </div>
                            <div>
                                <label className="block text-sm font-medium text-slate-700 mb-1">Yeni Åžifre (Tekrar)</label>
                                <input type="password" value={confirmPassword} onChange={e=>setConfirmPassword(e.target.value)} className="w-full p-3 border rounded-lg focus:ring-2 focus:ring-primary outline-none" required />
                            </div>
                            
                            {passMsg.text && (
                                <div className={`p-3 rounded text-sm ${passMsg.type === 'error' ? 'bg-red-50 text-red-600' : 'bg-green-50 text-green-600'}`}>
                                    {passMsg.text}
                                </div>
                            )}

                            <button disabled={passLoading} className="px-6 py-2 bg-primary text-white rounded-lg hover:bg-blue-700 transition flex items-center gap-2">
                                {passLoading ? <Icon name="loader-2" className="loading-spin" /> : 'Åžifreyi GÃ¼ncelle'}
                            </button>
                        </form>
                    </div>
                </div>
            );
        };

        const Dashboard = ({ user, profile, supabase, onLogout }) => {
            const [view, setView] = useState('dashboard'); 
            const [receipts, setReceipts] = useState([]);
            const [stats, setStats] = useState({ total: 0, count: 0, pending: 0 });
            const [loading, setLoading] = useState(true);
            const [aiAnalysis, setAiAnalysis] = useState(null);
            const [aiLoading, setAiLoading] = useState(false);
            
            const fetchData = async () => {
                if (!profile?.company_id && !user?.id) return; 
                setLoading(true);
                
                try {
                    let query = supabase.from('fisler').select('*').order('tarih', { ascending: false });
                    
                    if (profile?.company_id) {
                        query = query.eq('company_id', profile.company_id);
                    } else {
                        query = query.eq('user_id', user.id);
                    }

                    const { data, error } = await query;

                    if (!error) {
                        setReceipts(data || []);
                        const total = (data || []).reduce((acc, r) => acc + (r.toplam_tutar || 0), 0);
                        const pending = (data || []).filter(r => r.durum === 'beklemede').length;
                        setStats({ total, count: data?.length || 0, pending });
                    }
                } catch (err) {
                    console.error("Veri hatasÄ±:", err);
                } finally {
                    setLoading(false);
                }
            };

            const runAiAnalysis = async () => {
                const apiKey = localStorage.getItem('gemini_key');
                if (!apiKey) return alert("LÃ¼tfen Ayarlar sayfasÄ±ndan Gemini API anahtarÄ±nÄ±zÄ± giriniz.");
                if (receipts.length === 0) return alert("Analiz iÃ§in veri bulunamadÄ±.");
                setAiLoading(true);
                const analysisData = {
                    toplam: stats.total, adet: stats.count, bekleyen: stats.pending,
                    ozet: receipts.slice(0, 15).map(r => ({ t: r.tarih?.slice(0, 10), m: r.isletme_adi, p: r.toplam_tutar }))
                };
                const prompt = `Finans asistanÄ±sÄ±n. TÃ¼rkÃ§e analiz yap. Veri: ${JSON.stringify(analysisData)}. 1. Harcama Ã¶zeti. 2. Anomali var mÄ±? 3. Tavsiye. Markdown kullan.`;
                try {
                    const result = await callGemini(apiKey, prompt);
                    setAiAnalysis(result);
                } catch (e) { alert("AI HatasÄ±: " + e.message); } finally { setAiLoading(false); }
            };

            useEffect(() => { fetchData(); }, [profile, user]); 
            useEffect(() => { lucide.createIcons(); }, [view, receipts, loading, aiAnalysis]);

            return (
                <div className="min-h-screen flex flex-col md:flex-row">
                    <aside className="w-full md:w-64 bg-white border-r border-slate-200 flex flex-col z-20">
                        <div className="p-6 flex items-center gap-2 border-b border-slate-100">
                            <Icon name="receipt" className="text-primary" />
                            <span className="font-bold text-lg text-slate-800">FiÅŸMatik</span>
                        </div>
                        <nav className="flex-1 p-4 space-y-1">
                            {[{id:'dashboard',icon:'layout-dashboard',label:'Genel BakÄ±ÅŸ'},{id:'receipts',icon:'file-text',label:'FiÅŸlerim'},{id:'reports',icon:'bar-chart-3',label:'Raporlar'},{id:'settings',icon:'settings',label:'Ayarlar'}].map(item=><button key={item.id} onClick={()=>setView(item.id)} className={`w-full flex items-center gap-3 px-4 py-3 rounded-lg text-sm font-medium transition ${view===item.id?'bg-blue-50 text-primary':'text-slate-600 hover:bg-slate-50'}`}><Icon name={item.icon} size={18}/> {item.label}</button>)}
                        </nav>
                        <div className="p-4 border-t border-slate-100">
                            <div className="flex items-center gap-3 mb-4">
                                <div className="w-8 h-8 rounded-full bg-blue-100 flex items-center justify-center text-primary font-bold">{(profile?.full_name || user.email)[0].toUpperCase()}</div>
                                <div className="overflow-hidden">
                                    <p className="text-xs font-medium text-slate-700 truncate">{profile?.full_name || user.email}</p>
                                    <p className="text-xs text-slate-400">Åžirket ID: {profile?.company_id || '-'}</p>
                                </div>
                            </div>
                            <button onClick={onLogout} className="w-full flex items-center gap-2 text-red-500 text-sm hover:bg-red-50 p-2 rounded transition"><Icon name="log-out" size={16}/> Ã‡Ä±kÄ±ÅŸ Yap</button>
                        </div>
                    </aside>
                    <main className="flex-1 p-4 md:p-8 overflow-y-auto h-screen bg-slate-50">
                        {view === 'dashboard' && (
                            <div className="space-y-6">
                                <div className="flex flex-col md:flex-row justify-between md:items-center gap-4"><h2 className="text-2xl font-bold text-slate-800">HoÅŸ Geldiniz, {profile?.full_name?.split(' ')[0] || 'KullanÄ±cÄ±'} ðŸ‘‹</h2><button onClick={runAiAnalysis} disabled={aiLoading} className={`px-4 py-2 bg-gradient-to-r from-violet-600 to-indigo-600 text-white rounded-lg shadow-md hover:shadow-lg transition flex items-center gap-2 text-sm font-medium ${aiLoading?'opacity-75 cursor-not-allowed':'hover:scale-105'}`}>{aiLoading?<Icon name="loader-2" className="loading-spin"/>:<Icon name="sparkles"/>}{aiLoading?'Analiz Ediliyor...':'Yapay Zeka Analizi BaÅŸlat'}</button></div>
                                {aiAnalysis && <div className="bg-white p-6 rounded-xl border border-violet-100 shadow-sm ai-glow relative overflow-hidden"><div className="absolute top-0 right-0 p-4 opacity-10 pointer-events-none"><Icon name="bot" size={100} className="text-violet-600"/></div><div className="flex items-center gap-2 mb-4 text-violet-700"><Icon name="brain-circuit" size={24}/><h3 className="font-bold text-lg">Finansal Asistan GÃ¶rÃ¼ÅŸÃ¼</h3></div><div className="text-sm text-slate-600 leading-relaxed markdown-body" dangerouslySetInnerHTML={{__html: marked.parse(aiAnalysis)}}></div><button onClick={()=>setAiAnalysis(null)} className="absolute top-4 right-4 text-slate-400 hover:text-slate-600"><Icon name="x" size={20}/></button></div>}
                                <div className="grid grid-cols-1 md:grid-cols-3 gap-6"><StatCard title="Toplam Harcama" value={stats.total.toLocaleString('tr-TR',{style:'currency',currency:'TRY'})} icon="wallet" color="text-green-600" bg="bg-green-50"/><StatCard title="Toplam FiÅŸ" value={stats.count} icon="file-stack" color="text-blue-600" bg="bg-blue-50"/><StatCard title="Onay Bekleyen" value={stats.pending} icon="clock" color="text-orange-600" bg="bg-orange-50"/></div>
                                <div className="bg-white p-6 rounded-xl border border-slate-200 shadow-sm"><div className="flex justify-between items-center mb-4"><h3 className="font-semibold text-slate-700">Son Hareketler</h3><button onClick={()=>setView('receipts')} className="text-sm text-primary hover:underline">TÃ¼mÃ¼nÃ¼ GÃ¶r</button></div><ReceiptsTable receipts={receipts.slice(0,5)} loading={loading} simple={true}/></div>
                            </div>
                        )}
                        {view === 'receipts' && <div className="space-y-6"><div className="flex justify-between items-center"><h2 className="text-2xl font-bold text-slate-800">FiÅŸ KayÄ±tlarÄ±</h2><button onClick={fetchData} className="p-2 text-slate-500 hover:text-primary"><Icon name="refresh-ccw" /></button></div><div className="bg-white rounded-xl border border-slate-200 shadow-sm overflow-hidden"><ReceiptsTable receipts={receipts} loading={loading} supabase={supabase} refresh={fetchData}/></div></div>}
                        {view === 'reports' && <div className="max-w-xl mx-auto mt-10"><ReportCard user={user} profile={profile}/></div>}
                        {view === 'settings' && <Settings user={user} />}
                    </main>
                </div>
            );
        };

        const StatCard = ({ title, value, icon, color, bg }) => (<div className="bg-white p-6 rounded-xl border border-slate-200 shadow-sm flex items-center gap-4"><div className={`p-4 rounded-full ${bg} ${color}`}><Icon name={icon} size={24}/></div><div><p className="text-slate-500 text-sm font-medium">{title}</p><p className="text-2xl font-bold text-slate-800">{value}</p></div></div>);

        const ReceiptsTable = ({ receipts, loading, simple, supabase, refresh }) => {
            const [editItem, setEditItem] = useState(null);
            const [filters, setFilters] = useState({ tarih: '', isletme_adi: '', toplam_tutar: '', durum: '' });
            const filteredReceipts = useMemo(() => {
                if (simple) return receipts;
                return receipts.filter(r => {
                    const matchTarih = !filters.tarih || (r.tarih && r.tarih.includes(filters.tarih));
                    const matchIsletme = !filters.isletme_adi || (r.isletme_adi && r.isletme_adi.toLowerCase().includes(filters.isletme_adi.toLowerCase()));
                    const matchTutar = !filters.toplam_tutar || (r.toplam_tutar && r.toplam_tutar.toString().includes(filters.toplam_tutar));
                    const matchDurum = !filters.durum || (r.durum && r.durum.toLowerCase().includes(filters.durum.toLowerCase()));
                    return matchTarih && matchIsletme && matchTutar && matchDurum;
                });
            }, [receipts, filters, simple]);
            const handleSave = async () => { try { const { error } = await supabase.from('fisler').update({ isletme_adi: editItem.isletme_adi, toplam_tutar: parseFloat(editItem.toplam_tutar), tarih: editItem.tarih, durum: editItem.durum, ocr_detaylari: editItem.ocr_detaylari }).eq('id', editItem.id); if (error) throw error; setEditItem(null); refresh(); } catch (e) { alert("KayÄ±t hatasÄ±: " + e.message); } };
            const addLineItem = () => { setEditItem({ ...editItem, ocr_detaylari: [...(editItem.ocr_detaylari || []), { aciklama: '', kdv: 18, tutar: 0 }] }); };
            const removeLineItem = (index) => { const n = [...editItem.ocr_detaylari]; n.splice(index, 1); setEditItem({ ...editItem, ocr_detaylari: n }); };
            const updateLineItem = (index, field, value) => { const n = [...editItem.ocr_detaylari]; n[index][field] = value; setEditItem({ ...editItem, ocr_detaylari: n }); };
            if (loading) return <div className="p-8 text-center text-slate-400">YÃ¼kleniyor...</div>;
            if (receipts.length === 0) return <div className="p-8 text-center text-slate-400">KayÄ±t bulunamadÄ±.</div>;
            return (
                <>
                    <table className="w-full text-left text-sm">
                        <thead className="bg-slate-50 text-slate-500 uppercase text-xs sticky top-0">
                            <tr><th className="px-6 py-3">Tarih</th><th className="px-6 py-3">Ä°ÅŸletme</th><th className="px-6 py-3">Tutar</th><th className="px-6 py-3">Durum</th>{!simple && <th className="px-6 py-3 text-right">Ä°ÅŸlem</th>}</tr>
                            {!simple && (<tr className="bg-slate-100"><th className="px-2 py-2"><input placeholder="YÄ±l-Ay-GÃ¼n" className="w-full p-1 border rounded font-normal" value={filters.tarih} onChange={e=>setFilters({...filters, tarih: e.target.value})} /></th><th className="px-2 py-2"><input placeholder="Ara..." className="w-full p-1 border rounded font-normal" value={filters.isletme_adi} onChange={e=>setFilters({...filters, isletme_adi: e.target.value})} /></th><th className="px-2 py-2"><input placeholder="Tutar..." className="w-full p-1 border rounded font-normal" value={filters.toplam_tutar} onChange={e=>setFilters({...filters, toplam_tutar: e.target.value})} /></th><th className="px-2 py-2"><select className="w-full p-1 border rounded font-normal" value={filters.durum} onChange={e=>setFilters({...filters, durum: e.target.value})}><option value="">Hepsi</option><option value="beklemede">Beklemede</option><option value="onaylandi">OnaylandÄ±</option><option value="aktarildi">AktarÄ±ldÄ±</option></select></th><th></th></tr>)}
                        </thead>
                        <tbody className="divide-y divide-slate-100">
                            {filteredReceipts.map(r => (<tr key={r.id} className="hover:bg-slate-50 transition group"><td className="px-6 py-4 text-slate-600 whitespace-nowrap">{new Date(r.tarih).toLocaleDateString('tr-TR')}<div className="text-xs text-slate-400">{new Date(r.tarih).toLocaleTimeString('tr-TR', {hour: '2-digit', minute:'2-digit'})}</div></td><td className="px-6 py-4 font-medium text-slate-900 flex items-center gap-2">{r.gorsel_url && <a href={r.gorsel_url} target="_blank" className="text-blue-400 hover:text-blue-600"><Icon name="image" size={16}/></a>}{r.isletme_adi}</td><td className="px-6 py-4 font-bold text-slate-800">{r.toplam_tutar?.toLocaleString('tr-TR', {style:'currency', currency:'TRY'})}</td><td className="px-6 py-4"><span className={`px-2 py-1 rounded-full text-xs font-semibold ${r.durum === 'onaylandi' ? 'bg-green-100 text-green-700' : r.durum === 'aktarildi' ? 'bg-blue-100 text-blue-700' : 'bg-yellow-100 text-yellow-700'}`}>{r.durum.toUpperCase()}</span></td>{!simple && (<td className="px-6 py-4 text-right"><button onClick={()=>setEditItem(JSON.parse(JSON.stringify(r)))} className="text-primary hover:bg-blue-50 p-2 rounded transition"><Icon name="pencil" size={16} /></button></td>)}</tr>))}
                        </tbody>
                    </table>
                    {editItem && (
                        <div className="fixed inset-0 bg-black/70 flex items-center justify-center z-50 p-4"><div className="bg-white rounded-xl w-full max-w-6xl h-[90vh] flex shadow-2xl overflow-hidden"><div className="w-1/2 bg-slate-900 flex items-center justify-center relative p-4">{editItem.gorsel_url ? <img src={editItem.gorsel_url} className="max-w-full max-h-full object-contain rounded" /> : <div className="text-slate-500 flex flex-col items-center"><Icon name="image-off" size={48} /><p>GÃ¶rsel Yok</p></div>}<a href={editItem.gorsel_url} target="_blank" className="absolute top-4 right-4 bg-white/10 hover:bg-white/20 text-white p-2 rounded backdrop-blur-sm"><Icon name="external-link" size={20}/></a></div><div className="w-1/2 flex flex-col h-full"><div className="p-6 border-b flex justify-between items-center bg-white"><h3 className="text-xl font-bold text-slate-800">FiÅŸ DetaylarÄ±</h3><button onClick={()=>setEditItem(null)}><Icon name="x" className="text-slate-400 hover:text-slate-600"/></button></div><div className="flex-1 overflow-y-auto p-6 space-y-6"><div className="grid grid-cols-2 gap-4"><div><label className="text-xs font-semibold text-slate-500 uppercase">Ä°ÅŸletme AdÄ±</label><input className="w-full border p-2 rounded mt-1 bg-slate-50 focus:bg-white focus:ring-2 focus:ring-primary outline-none" value={editItem.isletme_adi} onChange={e=>setEditItem({...editItem, isletme_adi: e.target.value})} /></div><div><label className="text-xs font-semibold text-slate-500 uppercase">Tarih</label><input type="datetime-local" className="w-full border p-2 rounded mt-1 bg-slate-50 focus:bg-white" value={editItem.tarih ? editItem.tarih.slice(0,16) : ''} onChange={e=>setEditItem({...editItem, tarih: e.target.value})} /></div><div><label className="text-xs font-semibold text-slate-500 uppercase">Toplam Tutar</label><input type="number" step="0.01" className="w-full border p-2 rounded mt-1 bg-slate-50 focus:bg-white font-bold text-slate-800" value={editItem.toplam_tutar} onChange={e=>setEditItem({...editItem, toplam_tutar: e.target.value})} /></div><div><label className="text-xs font-semibold text-slate-500 uppercase">Durum</label><select className="w-full border p-2 rounded mt-1 bg-slate-50" value={editItem.durum} onChange={e=>setEditItem({...editItem, durum: e.target.value})}><option value="beklemede">Beklemede</option><option value="onaylandi">OnaylandÄ±</option><option value="aktarildi">AktarÄ±ldÄ±</option></select></div></div><hr /><div><div className="flex justify-between items-center mb-2"><label className="text-xs font-semibold text-slate-500 uppercase">Harcama Kalemleri</label><button onClick={addLineItem} className="text-xs bg-blue-50 text-primary px-2 py-1 rounded hover:bg-blue-100 flex items-center gap-1"><Icon name="plus" size={14}/> Ekle</button></div><div className="bg-slate-50 rounded-lg border overflow-hidden"><div className="grid grid-cols-12 gap-2 p-2 bg-slate-100 text-xs font-bold text-slate-500"><div className="col-span-6">AÃ§Ä±klama</div><div className="col-span-2">KDV %</div><div className="col-span-3">Tutar</div><div className="col-span-1"></div></div>{(editItem.ocr_detaylari || []).map((line, idx) => (<div key={idx} className="grid grid-cols-12 gap-2 p-2 border-t border-slate-200 items-center"><div className="col-span-6"><input className="w-full bg-transparent border-b border-transparent focus:border-primary outline-none text-sm" value={line.aciklama || line.UrunTuru || ''} onChange={e => updateLineItem(idx, 'aciklama', e.target.value)} placeholder="ÃœrÃ¼n AdÄ±" /></div><div className="col-span-2"><input type="number" className="w-full bg-transparent border-b border-transparent focus:border-primary outline-none text-sm text-center" value={line.kdv || line.KDVOrani || 0} onChange={e => updateLineItem(idx, 'kdv', e.target.value)} /></div><div className="col-span-3"><input type="number" step="0.01" className="w-full bg-transparent border-b border-transparent focus:border-primary outline-none text-sm font-medium" value={line.tutar || line.Tutar_KDVDahil || 0} onChange={e => updateLineItem(idx, 'tutar', e.target.value)} /></div><div className="col-span-1 text-right"><button onClick={()=>removeLineItem(idx)} className="text-slate-400 hover:text-red-500"><Icon name="trash-2" size={16}/></button></div></div>))}</div></div></div><div className="p-4 border-t bg-gray-50 flex justify-end gap-3"><button onClick={()=>setEditItem(null)} className="px-6 py-2 text-slate-600 hover:bg-slate-200 rounded-lg font-medium">VazgeÃ§</button><button onClick={handleSave} className="px-6 py-2 bg-green-600 text-white hover:bg-green-700 rounded-lg font-medium shadow-md flex items-center gap-2"><Icon name="save" size={18}/> DeÄŸiÅŸiklikleri Kaydet</button></div></div></div></div>
                    )}
                </>
            );
        };

        const ReportCard = ({ user, profile }) => {
            const [dates, setDates] = useState({ start: '', end: '' });
            const [loading, setLoading] = useState(false);
            const sendReport = async () => {
                if(!dates.start || !dates.end) return alert("Tarih seÃ§iniz.");
                setLoading(true);
                try {
                    await fetch(N8N_REPORT_WEBHOOK, { method: 'POST', body: JSON.stringify({ userId: user.id, companyId: profile?.company_id, ...dates }) });
                    alert("âœ… Rapor isteÄŸi baÅŸarÄ±yla gÃ¶nderildi!");
                } catch { alert("Hata oluÅŸtu."); }
                setLoading(false);
            };
            return (
                <div className="bg-white p-8 rounded-xl border border-slate-200 shadow-sm text-center"><div className="inline-block p-4 bg-blue-50 rounded-full text-primary mb-4"><Icon name="mail" size={32} /></div><h2 className="text-xl font-bold text-slate-800 mb-2">Rapor OluÅŸtur</h2><p className="text-slate-500 mb-6">SeÃ§tiÄŸiniz tarih aralÄ±ÄŸÄ±ndaki harcamalar Excel olarak e-postanÄ±za gÃ¶nderilecektir.</p><div className="flex gap-4 mb-6"><div className="w-1/2 text-left"><label className="text-xs font-semibold text-slate-500">BaÅŸlangÄ±Ã§</label><input type="date" className="w-full border p-2 rounded mt-1" onChange={e=>setDates({...dates, start:e.target.value})} /></div><div className="w-1/2 text-left"><label className="text-xs font-semibold text-slate-500">BitiÅŸ</label><input type="date" className="w-full border p-2 rounded mt-1" onChange={e=>setDates({...dates, end:e.target.value})} /></div></div><button onClick={sendReport} disabled={loading} className="w-full bg-primary text-white py-3 rounded-lg font-medium hover:bg-blue-700 transition flex justify-center gap-2">{loading ? 'GÃ¶nderiliyor...' : <><Icon name="send" size={18} /> Raporu E-Postala</>}</button></div>
            );
        }

        // --- UYGULAMA BAÅžLAT ---
        const App = () => {
            const [user, setUser] = useState(null);
            const [profile, setProfile] = useState(null);
            
            useEffect(() => {
                const sb = createClient(DEFAULT_SB_URL, DEFAULT_SB_KEY);
                sb.auth.getUser().then(({ data }) => { if(data.user) setUser(data.user); });
                const { data: authListener } = sb.auth.onAuthStateChange(async (event, session) => {
                    const u = session?.user ?? null;
                    setUser(u);
                    if(u) {
                        try {
                            const { data, error } = await sb.from('users').select('*').eq('id', u.id).single();
                            if(data) setProfile(data);
                            else console.warn("Profil bulunamadÄ±:", error);
                        } catch(e) { console.error(e); }
                    } else {
                        setProfile(null);
                    }
                });
                return () => authListener.subscription.unsubscribe();
            }, []);

            const getSupabase = () => createClient(DEFAULT_SB_URL, DEFAULT_SB_KEY);

            if (!user) return <Login onLogin={(u)=>setUser(u)} />;
            return <Dashboard user={user} profile={profile} supabase={getSupabase()} onLogout={async () => { await getSupabase().auth.signOut(); setUser(null); }} />;
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>