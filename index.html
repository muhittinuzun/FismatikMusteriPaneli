<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FişMatik - Akıllı Müşteri Paneli</title>
    
    <!-- GEREKLİ KÜTÜPHANELER (CDN) -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: { sans: ['Inter', 'sans-serif'] },
                    colors: {
                        primary: '#2563eb', 
                        secondary: '#1e293b',
                        ai: '#8b5cf6',
                    }
                }
            }
        }
    </script>
    <style>
        body { background-color: #f8fafc; }
        .glass-panel { background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(10px); border: 1px solid #e2e8f0; }
        .loading-spin { animation: spin 1s linear infinite; }
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .ai-glow { box-shadow: 0 0 15px rgba(139, 92, 246, 0.3); }
        .markdown-body ul { list-style-type: disc; margin-left: 1.5rem; margin-top: 0.5rem; }
        .markdown-body strong { color: #4b5563; font-weight: 700; }
        .markdown-body p { margin-bottom: 0.75rem; }
        
        /* Görsel Manipülasyonu İçin */
        .image-container {
            /* JS ile kontrol edeceğiz, default transition */
            transition: transform 0.2s ease-out;
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo, useCallback } = React;
        const { createClient } = supabase;

        // --- SABİT AYARLAR ---
        const DEFAULT_SB_URL = "https://hequoxateionmtfjzkxl.supabase.co";
        const DEFAULT_SB_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImhlcXVveGF0ZWlvbm10Zmp6a3hsIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjUyNTg5MDAsImV4cCI6MjA4MDgzNDkwMH0.aIiIdWw2l7Kcqa4BavNJQ8ARZrdPnmxD8qSMpTlXYhA";
        
        // 1. Rapor Webhook URLleri (Test ve Canlı Ayrımı Var)
        const N8N_REPORT_WEBHOOK_TEST = "https://n8n.ittyazilim.com/webhook-test/fbdbb58e-91f5-4137-891a-339eeb821168";
        const N8N_REPORT_WEBHOOK_PROD = "https://n8n.ittyazilim.com/webhook/fbdbb58e-91f5-4137-891a-339eeb821168";

        // 2. Şifre Sıfırlama Webhook URLsi (SADECE TEST İSTENDİ)
        const N8N_RESET_PW_WEBHOOK_TEST = "https://n8n.ittyazilim.com/webhook-test/3eafd39c-fdee-406f-88ef-1b9ab4bd555e";

        // Global Supabase Client
        const sb = createClient(DEFAULT_SB_URL, DEFAULT_SB_KEY);

        const Icon = ({ name, size = 20, className }) => {
            return <i data-lucide={name} width={size} height={size} className={className}></i>;
        };

        const callGemini = async (apiKey, prompt) => {
            const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;
            const response = await fetch(url, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
            });
            const data = await response.json();
            if (data.error) throw new Error(data.error.message);
            return data.candidates?.[0]?.content?.parts?.[0]?.text || "Yanıt alınamadı.";
        };

        // --- ALT BİLEŞENLER ---

        const StatCard = ({ title, value, icon, color, bg }) => (
            <div className="bg-white p-6 rounded-xl border border-slate-200 shadow-sm flex items-center gap-4">
                <div className={`p-4 rounded-full ${bg} ${color}`}><Icon name={icon} size={24} /></div>
                <div><p className="text-slate-500 text-sm font-medium">{title}</p><p className="text-2xl font-bold text-slate-800">{value}</p></div>
            </div>
        );

        const ReceiptsTable = ({ receipts, loading, simple, supabase, refresh, onLocalUpdate }) => {
            const [editItem, setEditItem] = useState(null);
            const [isSaving, setIsSaving] = useState(false);
            const [filters, setFilters] = useState({ tarih: '', isletme_adi: '', toplam_tutar: '', durum: '', kategori: '' });
            
            // GÖRSEL MANİPÜLASYON STATE'LERİ
            const [imgRotation, setImgRotation] = useState(0);
            const [imgZoom, setImgZoom] = useState(1);
            // Pan (Kaydırma) State'leri
            const [pan, setPan] = useState({ x: 0, y: 0 });
            const [isDragging, setIsDragging] = useState(false);
            const [dragStart, setDragStart] = useState({ x: 0, y: 0 });

            // Modal açıldığında state'leri sıfırla
            useEffect(() => {
                if (editItem) {
                    setImgRotation(0);
                    setImgZoom(1);
                    setPan({ x: 0, y: 0 });
                    lucide.createIcons();
                }
            }, [editItem]);

            // Zoom/Rotate/Pan değiştiğinde ikonları güncelle
            useEffect(() => {
                lucide.createIcons();
            }, [imgRotation, imgZoom, pan]);

            // --- PAN HANDLERS ---
            const handleMouseDown = (e) => {
                e.preventDefault(); // Resmin native sürüklenmesini engelle
                setIsDragging(true);
                setDragStart({ x: e.clientX - pan.x, y: e.clientY - pan.y });
            };

            const handleMouseMove = (e) => {
                if (!isDragging) return;
                e.preventDefault();
                setPan({
                    x: e.clientX - dragStart.x,
                    y: e.clientY - dragStart.y
                });
            };

            const handleMouseUp = () => {
                setIsDragging(false);
            };

            const filtered = useMemo(() => {
                if (simple) return receipts;
                return receipts.filter(r => {
                    return (!filters.tarih || r.tarih?.includes(filters.tarih)) &&
                           (!filters.isletme_adi || r.isletme_adi?.toLowerCase().includes(filters.isletme_adi.toLowerCase())) &&
                           (!filters.toplam_tutar || r.toplam_tutar?.toString().includes(filters.toplam_tutar)) &&
                           (!filters.durum || r.durum?.includes(filters.durum)) &&
                           (!filters.kategori || r.kategori?.toLowerCase().includes(filters.kategori.toLowerCase()));
                });
            }, [receipts, filters, simple]);

            const handleSave = async () => {
                setIsSaving(true);
                
                // İyimser Güncelleme
                const updatedItem = { ...editItem };
                
                // --- OTOMATİK KATEGORİ BELİRLEME ---
                const categories = updatedItem.ocr_detaylari?.map(l => l.kategori).filter(Boolean) || [];
                const uniqueCategories = [...new Set(categories)];
                const mainCategory = uniqueCategories.length > 1 ? 'Çoklu' : (uniqueCategories[0] || 'Genel');
                updatedItem.kategori = mainCategory;

                if(onLocalUpdate) onLocalUpdate(updatedItem);
                
                setEditItem(null); 

                try {
                    const { error } = await supabase.from('fisler').update({
                        isletme_adi: updatedItem.isletme_adi,
                        toplam_tutar: parseFloat(updatedItem.toplam_tutar),
                        tarih: updatedItem.tarih,
                        durum: updatedItem.durum,
                        kategori: mainCategory,
                        ocr_detaylari: updatedItem.ocr_detaylari
                    }).eq('id', updatedItem.id);

                    if (error) {
                        alert("Hata: " + error.message);
                        if (refresh) refresh(); 
                    }
                } catch (e) {
                    alert("Kayıt hatası: " + e.message);
                    if (refresh) refresh();
                } finally {
                    setIsSaving(false);
                }
            };

            const addLine = () => setEditItem({ ...editItem, ocr_detaylari: [...(editItem.ocr_detaylari||[]), {aciklama:'', kategori:'', kdv:18, tutar:0}] });
            const removeLine = (idx) => {
                const lines = [...editItem.ocr_detaylari];
                lines.splice(idx, 1);
                setEditItem({ ...editItem, ocr_detaylari: lines });
            };
            const updateLine = (idx, key, val) => {
                const lines = [...editItem.ocr_detaylari];
                lines[idx][key] = val;
                setEditItem({ ...editItem, ocr_detaylari: lines });
            };

            if (loading) return <div className="p-8 text-center text-slate-400">Yükleniyor...</div>;
            if (receipts.length === 0) return <div className="p-8 text-center text-slate-400">Veri yok.</div>;

            return (
                <>
                    <div className="overflow-x-auto">
                        <table className="w-full text-left text-sm">
                            <thead className="bg-slate-50 text-slate-500 uppercase text-xs sticky top-0">
                                <tr>
                                    <th className="px-6 py-3">Tarih</th>
                                    <th className="px-6 py-3">İşletme</th>
                                    <th className="px-6 py-3">Kategori</th>
                                    <th className="px-6 py-3">Tutar</th>
                                    <th className="px-6 py-3">Durum</th>
                                    {!simple && <th className="px-6 py-3 text-right">İşlem</th>}
                                </tr>
                                {!simple && (
                                    <tr className="bg-slate-100">
                                        <th className="px-2"><input placeholder="Yıl-Ay-Gün" className="w-full p-1 border rounded" onChange={e=>setFilters({...filters, tarih:e.target.value})}/></th>
                                        <th className="px-2"><input placeholder="Ara..." className="w-full p-1 border rounded" onChange={e=>setFilters({...filters, isletme_adi:e.target.value})}/></th>
                                        <th className="px-2">
                                            <select className="w-full p-1 border rounded" onChange={e=>setFilters({...filters, kategori:e.target.value})}>
                                                <option value="">Hepsi</option>
                                                <option value="Yemek">Yemek</option>
                                                <option value="Market">Market</option>
                                                <option value="Yakıt">Yakıt</option>
                                                <option value="Konaklama">Konaklama</option>
                                                <option value="Ulaşım">Ulaşım</option>
                                                <option value="Diğer">Diğer</option>
                                            </select>
                                        </th>
                                        <th className="px-2"><input placeholder="Tutar..." className="w-full p-1 border rounded" onChange={e=>setFilters({...filters, toplam_tutar:e.target.value})}/></th>
                                        <th className="px-2">
                                            <select className="w-full p-1 border rounded" onChange={e=>setFilters({...filters, durum:e.target.value})}>
                                                <option value="">Hepsi</option><option value="beklemede">Beklemede</option><option value="onaylandi">Onaylandı</option>
                                            </select>
                                        </th>
                                        <th></th>
                                    </tr>
                                )}
                            </thead>
                            <tbody className="divide-y divide-slate-100">
                                {filtered.map(r => (
                                    <tr key={r.id} className="hover:bg-slate-50 transition group">
                                        <td className="px-6 py-4">{new Date(r.tarih).toLocaleDateString('tr-TR')}</td>
                                        <td className="px-6 py-4 font-medium">{r.isletme_adi}</td>
                                        <td className="px-6 py-4 text-slate-500">{r.kategori || '-'}</td>
                                        <td className="px-6 py-4 font-bold">{r.toplam_tutar?.toLocaleString('tr-TR', {style:'currency', currency:'TRY'})}</td>
                                        <td className="px-6 py-4"><span className={`px-2 py-1 rounded text-xs ${r.durum==='onaylandi'?'bg-green-100 text-green-800':'bg-yellow-100 text-yellow-800'}`}>{r.durum}</span></td>
                                        {!simple && <td className="px-6 py-4 text-right"><button onClick={()=>setEditItem(JSON.parse(JSON.stringify(r)))} className="text-primary hover:bg-blue-50 p-2 rounded"><Icon name="pencil" size={16}/></button></td>}
                                    </tr>
                                ))}
                            </tbody>
                        </table>
                    </div>

                    {editItem && (
                        <div className="fixed inset-0 bg-black/80 flex items-center justify-center z-50 p-4">
                            <div className="bg-white w-full max-w-6xl h-[90vh] rounded-xl flex overflow-hidden shadow-2xl">
                                
                                {/* SOL TARAF: GÖRSEL (DÜZENLENMİŞ) */}
                                <div 
                                    className="w-1/2 bg-slate-900 flex items-center justify-center relative p-4 overflow-hidden group cursor-move"
                                    onMouseDown={handleMouseDown}
                                    onMouseMove={handleMouseMove}
                                    onMouseUp={handleMouseUp}
                                    onMouseLeave={handleMouseUp}
                                >
                                    {editItem.gorsel_url ? (
                                        <>
                                            <div 
                                                className="image-container"
                                                style={{ 
                                                    transform: `translate(${pan.x}px, ${pan.y}px) rotate(${imgRotation}deg) scale(${imgZoom})`,
                                                    maxWidth: '100%',
                                                    maxHeight: '100%',
                                                    display: 'flex',
                                                    alignItems: 'center',
                                                    justifyContent: 'center',
                                                    cursor: isDragging ? 'grabbing' : 'grab',
                                                    transition: isDragging ? 'none' : 'transform 0.2s ease-out'
                                                }}
                                            >
                                                <img src={editItem.gorsel_url} className="max-w-full max-h-full object-contain shadow-lg pointer-events-none" />
                                            </div>
                                            
                                            {/* GÖRSEL KONTROL TOOLBAR */}
                                            <div className="absolute bottom-6 flex items-center gap-2 bg-slate-800/90 p-2 rounded-full backdrop-blur-sm border border-white/10 shadow-xl z-20 opacity-0 group-hover:opacity-100 transition-opacity duration-300" onMouseDown={(e) => e.stopPropagation()}>
                                                <button onClick={() => setImgZoom(z => Math.max(0.5, z - 0.25))} className="p-2 text-white hover:bg-white/20 rounded-full transition" title="Uzaklaştır"><Icon name="zoom-out" size={18}/></button>
                                                <span className="text-xs text-slate-400 font-mono w-12 text-center">{Math.round(imgZoom * 100)}%</span>
                                                <button onClick={() => setImgZoom(z => Math.min(3, z + 0.25))} className="p-2 text-white hover:bg-white/20 rounded-full transition" title="Yakınlaştır"><Icon name="zoom-in" size={18}/></button>
                                                
                                                <div className="w-px h-6 bg-white/20 mx-1"></div>
                                                
                                                <button onClick={() => { setImgZoom(1); setImgRotation(0); setPan({x:0, y:0}); }} className="p-2 text-white hover:bg-white/20 rounded-full transition" title="Sıfırla"><Icon name="refresh-ccw" size={18}/></button>
                                                <button onClick={() => setImgRotation(r => r + 90)} className="p-2 text-white hover:bg-white/20 rounded-full transition" title="Sağa Döndür"><Icon name="rotate-cw" size={18}/></button>
                                            </div>
                                        </>
                                    ) : ( 
                                        <p className="text-white">Görsel Yok</p>
                                    )}
                                    {editItem.gorsel_url && <a href={editItem.gorsel_url} target="_blank" className="absolute top-4 right-4 bg-white/10 p-2 rounded text-white hover:bg-white/20 transition z-10" onMouseDown={(e) => e.stopPropagation()}><Icon name="external-link" size={20}/></a>}
                                </div>

                                {/* SAĞ TARAF: DÜZENLEME FORMU */}
                                <div className="w-1/2 flex flex-col bg-white">
                                    <div className="p-4 border-b flex justify-between items-center">
                                        <h3 className="font-bold text-lg">Fiş Detayları</h3>
                                        <button onClick={()=>setEditItem(null)}><Icon name="x"/></button>
                                    </div>
                                    <div className="flex-1 overflow-y-auto p-6 space-y-6">
                                        <div className="grid grid-cols-2 gap-4">
                                            <div><label className="text-xs text-slate-500">İşletme</label><input className="w-full border p-2 rounded" value={editItem.isletme_adi} onChange={e=>setEditItem({...editItem, isletme_adi:e.target.value})} /></div>
                                            <div><label className="text-xs text-slate-500">Tarih</label><input type="datetime-local" className="w-full border p-2 rounded" value={editItem.tarih ? editItem.tarih.slice(0,16) : ''} onChange={e=>setEditItem({...editItem, tarih:e.target.value})} /></div>
                                            <div><label className="text-xs text-slate-500">Tutar</label><input type="number" step="0.01" className="w-full border p-2 rounded font-bold" value={editItem.toplam_tutar} onChange={e=>setEditItem({...editItem, toplam_tutar:e.target.value})} /></div>
                                            <div><label className="text-xs text-slate-500">Durum</label><select className="w-full border p-2 rounded" value={editItem.durum} onChange={e=>setEditItem({...editItem, durum:e.target.value})}><option value="beklemede">Beklemede</option><option value="onaylandi">Onaylandı</option></select></div>
                                            
                                            {/* KATEGORİ ALANI */}
                                            <div className="col-span-2">
                                                <label className="text-xs text-slate-500">Genel Kategori (Otomatik)</label>
                                                <div className="flex gap-2">
                                                    <input className="w-full border p-2 rounded bg-slate-50 text-slate-500" value={editItem.kategori || 'Otomatik'} disabled />
                                                </div>
                                            </div>

                                        </div>
                                        <hr/>
                                        <div>
                                            <div className="flex justify-between mb-2">
                                                <h4 className="font-bold text-sm">Harcama Kalemleri</h4>
                                                <button onClick={addLine} className="text-xs bg-blue-50 text-primary px-2 py-1 rounded">+ Ekle</button>
                                            </div>
                                            <div className="space-y-2">
                                                {/* TABLO BAŞLIKLARI */}
                                                <div className="grid grid-cols-12 gap-2 text-xs font-bold text-slate-500">
                                                    <div className="col-span-4">Açıklama</div>
                                                    <div className="col-span-3">Kategori</div>
                                                    <div className="col-span-2">KDV</div>
                                                    <div className="col-span-2">Tutar</div>
                                                    <div className="col-span-1"></div>
                                                </div>
                                                {(editItem.ocr_detaylari || []).map((line, i) => (
                                                    <div key={i} className="grid grid-cols-12 gap-2 items-center">
                                                        <div className="col-span-4"><input className="w-full border-b outline-none text-sm" value={line.aciklama||line.UrunTuru||''} onChange={e=>updateLine(i,'aciklama',e.target.value)} placeholder="Ürün" /></div>
                                                        <div className="col-span-3">
                                                            <select className="w-full border-b outline-none text-sm bg-transparent cursor-pointer" value={line.kategori || ''} onChange={e=>updateLine(i,'kategori',e.target.value)}>
                                                                <option value="">Seçiniz</option>
                                                                <option value="Yemek">Yemek</option>
                                                                <option value="Market">Market</option>
                                                                <option value="Yakıt">Yakıt</option>
                                                                <option value="Konaklama">Konaklama</option>
                                                                <option value="Ulaşım">Ulaşım</option>
                                                                <option value="Giyim">Giyim</option>
                                                                <option value="Kırtasiye">Kırtasiye</option>
                                                                <option value="Teknoloji">Teknoloji</option>
                                                                <option value="Temizlik">Temizlik</option>
                                                                <option value="Diğer">Diğer</option>
                                                            </select>
                                                        </div>
                                                        <div className="col-span-2"><input type="number" className="w-full border-b outline-none text-sm" value={line.kdv||line.KDVOrani||0} onChange={e=>updateLine(i,'kdv',e.target.value)} /></div>
                                                        <div className="col-span-2"><input type="number" className="w-full border-b outline-none text-sm" value={line.tutar||line.Tutar_KDVDahil||0} onChange={e=>updateLine(i,'tutar',e.target.value)} /></div>
                                                        <div className="col-span-1 text-right"><button onClick={()=>removeLine(i)} className="text-red-400 hover:text-red-600"><Icon name="trash-2" size={14}/></button></div>
                                                    </div>
                                                ))}
                                            </div>
                                        </div>
                                    </div>
                                    <div className="p-4 border-t flex justify-end gap-2">
                                        <button onClick={()=>setEditItem(null)} className="px-4 py-2 text-slate-500 hover:bg-slate-100 rounded">İptal</button>
                                        <button onClick={handleSave} disabled={isSaving} className="px-6 py-2 bg-green-600 text-white rounded hover:bg-green-700 flex items-center gap-2">
                                            {isSaving ? <><Icon name="loader-2" className="loading-spin"/> Kaydediliyor...</> : 'Kaydet'}
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    )}
                </>
            );
        };

        const ReportCard = ({ user, profile }) => {
            const [dates, setDates] = useState({ start: '', end: '' });
            const [loading, setLoading] = useState(false);
            const sendReport = async () => {
                if(!dates.start || !dates.end) {
                    alert("Lütfen tarih aralığı seçiniz.");
                    return;
                }
                
                setLoading(true);
                
                // Payload hazırlama
                const payload = {
                    company_id: profile?.company_id || null,
                    start: dates.start,
                    end: dates.end,
                    email: user.email || 'kullanici@mail.com',
                    source: 'FisMatik_Panel'
                };
                
                // --- RAPOR WEBHOOK MANTIĞI (DÜZELTİLDİ) ---
                // Localhost ise Test URL, Canlı sunucu ise Prod URL kullan.
                const isTestMode = window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1';
                const targetUrl = isTestMode ? N8N_REPORT_WEBHOOK_TEST : N8N_REPORT_WEBHOOK_PROD;

                try {
                    // no-cors moduyla tek isteği at
                    await fetch(targetUrl, {
                        method: 'POST',
                        mode: 'no-cors',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });
                    
                    alert("Rapor isteğiniz alındı. Raporunuz hazırlandığında mail adresinize gönderilecektir.");
                } catch (error) {
                    console.error("Webhook hatası:", error);
                    alert("Rapor isteğiniz alındı. Raporunuz hazırlandığında mail adresinize gönderilecektir.");
                } finally {
                    setLoading(false);
                }
            };
            return (
                <div className="bg-white p-8 rounded-xl border border-slate-200 shadow-sm text-center">
                    <div className="inline-block p-4 bg-blue-50 rounded-full text-primary mb-4"><Icon name="mail" size={32} /></div>
                    <h2 className="text-xl font-bold text-slate-800 mb-2">Rapor Oluştur</h2>
                    <p className="text-slate-500 mb-6">Seçtiğiniz tarih aralığındaki harcamalar Excel olarak e-postanıza gönderilecektir.</p>
                    <div className="flex gap-4 mb-6">
                        <div className="w-1/2 text-left"><label className="text-xs font-semibold text-slate-500">Başlangıç</label><input type="date" className="w-full border p-2 rounded mt-1" value={dates.start} onChange={e=>setDates({...dates, start:e.target.value})} /></div>
                        <div className="w-1/2 text-left"><label className="text-xs font-semibold text-slate-500">Bitiş</label><input type="date" className="w-full border p-2 rounded mt-1" value={dates.end} onChange={e=>setDates({...dates, end:e.target.value})} /></div>
                    </div>
                    <button onClick={sendReport} disabled={loading} className="w-full bg-primary text-white py-3 rounded-lg font-medium hover:bg-blue-700 transition flex justify-center gap-2">
                        {loading ? <><Icon name="loader-2" className="loading-spin" size={18} /> Gönderiliyor...</> : <><Icon name="send" size={18} /> Raporu E-Postala</>}
                    </button>
                </div>
            );
        };

        const Settings = ({ user }) => {
            const [apiKey, setApiKey] = useState(localStorage.getItem('gemini_key') || '');
            const [saved, setSaved] = useState(false);
            const [newPassword, setNewPassword] = useState('');
            const [confirmPassword, setConfirmPassword] = useState('');
            const [passLoading, setPassLoading] = useState(false);
            const [passMsg, setPassMsg] = useState({ type: '', text: '' });

            const saveSettings = () => { localStorage.setItem('gemini_key', apiKey); setSaved(true); setTimeout(() => setSaved(false), 2000); };
            const handleChangePassword = async (e) => {
                e.preventDefault();
                if (newPassword !== confirmPassword) { setPassMsg({ type: 'error', text: 'Şifreler eşleşmiyor.' }); return; }
                if (newPassword.length < 6) { setPassMsg({ type: 'error', text: 'Şifre en az 6 karakter olmalı.' }); return; }
                setPassLoading(true); setPassMsg({ type: '', text: '' });
                const { error } = await sb.auth.updateUser({ password: newPassword });
                if (error) setPassMsg({ type: 'error', text: 'Hata: ' + error.message });
                else { setPassMsg({ type: 'success', text: 'Şifre güncellendi.' }); setNewPassword(''); setConfirmPassword(''); }
                setPassLoading(false);
            };

            return (
                <div className="max-w-2xl mx-auto mt-10 space-y-8">
                    <div className="bg-white p-8 rounded-xl border border-slate-200 shadow-sm">
                        <div className="flex items-center gap-3 mb-6">
                            <div className="p-3 bg-slate-100 rounded-full text-slate-600"><Icon name="sparkles" size={24} /></div>
                            <div><h2 className="text-xl font-bold text-slate-800">Yapay Zeka</h2><p className="text-sm text-slate-500">Analiz için API anahtarı</p></div>
                        </div>
                        <div className="space-y-4">
                            <div>
                                <label className="block text-sm font-medium text-slate-700 mb-1">Google Gemini API Anahtarı</label>
                                <input type="password" value={apiKey} onChange={e=>setApiKey(e.target.value)} placeholder="AIzaSy..." className="w-full p-3 border rounded-lg focus:ring-2 focus:ring-ai outline-none font-mono text-sm"/>
                            </div>
                            <button onClick={saveSettings} className="px-6 py-2 bg-slate-800 text-white rounded-lg hover:bg-slate-900 transition flex items-center gap-2">{saved ? <Icon name="check" size={18} /> : <Icon name="save" size={18} />} {saved ? 'Kaydedildi' : 'Kaydet'}</button>
                        </div>
                    </div>
                    <div className="bg-white p-8 rounded-xl border border-slate-200 shadow-sm">
                        <div className="flex items-center gap-3 mb-6">
                            <div className="p-3 bg-slate-100 rounded-full text-slate-600"><Icon name="lock" size={24} /></div>
                            <div><h2 className="text-xl font-bold text-slate-800">Güvenlik</h2><p className="text-sm text-slate-500">Şifrenizi güncelleyin</p></div>
                        </div>
                        <form onSubmit={handleChangePassword} className="space-y-4">
                            <div><label className="block text-sm font-medium text-slate-700 mb-1">Yeni Şifre</label><input type="password" value={newPassword} onChange={e=>setNewPassword(e.target.value)} className="w-full p-3 border rounded-lg focus:ring-2 focus:ring-primary outline-none" required /></div>
                            <div><label className="block text-sm font-medium text-slate-700 mb-1">Yeni Şifre (Tekrar)</label><input type="password" value={confirmPassword} onChange={e=>setConfirmPassword(e.target.value)} className="w-full p-3 border rounded-lg focus:ring-2 focus:ring-primary outline-none" required /></div>
                            {passMsg.text && (<div className={`p-3 rounded text-sm ${passMsg.type === 'error' ? 'bg-red-50 text-red-600' : 'bg-green-50 text-green-600'}`}>{passMsg.text}</div>)}
                            <button disabled={passLoading} className="px-6 py-2 bg-primary text-white rounded-lg hover:bg-blue-700 transition flex items-center gap-2">{passLoading ? <Icon name="loader-2" className="loading-spin" /> : 'Şifreyi Güncelle'}</button>
                        </form>
                    </div>
                </div>
            );
        };

        const Login = ({ onLogin }) => {
            const [email, setEmail] = useState('');
            const [password, setPassword] = useState('');
            const [loading, setLoading] = useState(false);
            const [error, setError] = useState('');
            const [info, setInfo] = useState('');
            const [view, setView] = useState('login');

            const handleLogin = async (e) => {
                e.preventDefault(); setLoading(true); setError('');
                const { data, error } = await sb.auth.signInWithPassword({ email, password });
                if (error) setError("Giriş başarısız: " + error.message);
                setLoading(false);
            };

            const handleReset = async (e) => {
                e.preventDefault(); setLoading(true); setError(''); setInfo('');
                
                try {
                    // --- ŞİFRE SIFIRLAMA WEBHOOK MANTIĞI (SADECE TEST) ---
                    // Kullanıcı talebine göre sadece TEST webhook'u kullanılacak.
                    // Prod ortamında bile çalışsa TEST webhook'una gider.
                    await fetch(N8N_RESET_PW_WEBHOOK_TEST, { 
                        method: 'POST', 
                        mode: 'no-cors', 
                        headers: {'Content-Type':'application/json'}, 
                        body: JSON.stringify({ 
                            email: email,
                            source: 'FisMatik_Login_Reset'
                        }) 
                    });
                    
                    setInfo("✅ E-posta adresiniz sistemde kayıtlıysa, şifre sıfırlama talimatları gönderilmiştir."); 
                } catch (e) { 
                    console.error(e);
                    setError("Bağlantı hatası. Lütfen tekrar deneyin."); 
                }
                setLoading(false);
            };

            return (
                <div className="min-h-screen flex items-center justify-center p-4 bg-slate-50">
                    <div className="glass-panel p-8 rounded-2xl shadow-xl w-full max-w-sm">
                        <div className="flex justify-center mb-4 text-primary"><Icon name="receipt" size={48} /></div>
                        <h1 className="text-2xl font-bold text-center text-slate-800 mb-2">FişMatik</h1>
                        {view==='login' ? (
                            <form onSubmit={handleLogin} className="space-y-4">
                                <input type="email" placeholder="E-Posta" value={email} onChange={e=>setEmail(e.target.value)} className="w-full p-3 border rounded-lg outline-none" required />
                                <input type="password" placeholder="Şifre" value={password} onChange={e=>setPassword(e.target.value)} className="w-full p-3 border rounded-lg outline-none" required />
                                {error && <p className="text-red-500 text-xs">{error}</p>}
                                <button disabled={loading} className="w-full bg-primary text-white py-3 rounded-lg font-medium hover:bg-blue-700 transition flex justify-center">{loading ? <Icon name="loader-2" className="loading-spin"/> : 'Giriş Yap'}</button>
                                <div className="text-center mt-2"><button type="button" onClick={()=>setView('forgot')} className="text-xs text-primary hover:underline">Şifremi Unuttum</button></div>
                            </form>
                        ) : (
                            <form onSubmit={handleReset} className="space-y-4">
                                <h3 className="text-center font-bold text-slate-700">Şifre Sıfırlama</h3>
                                <input type="email" placeholder="E-Posta" value={email} onChange={e=>setEmail(e.target.value)} className="w-full p-3 border rounded-lg outline-none" required />
                                {info && <p className="text-green-600 text-xs">{info}</p>}
                                {error && <p className="text-red-500 text-xs">{error}</p>}
                                <button disabled={loading} className="w-full bg-primary text-white py-3 rounded-lg">{loading ? <Icon name="loader-2" className="loading-spin"/> : 'Link Gönder'}</button>
                                <div className="text-center mt-2"><button type="button" onClick={()=>setView('login')} className="text-xs text-slate-500">Geri Dön</button></div>
                            </form>
                        )}
                    </div>
                </div>
            );
        };

        // --- DASHBOARD (ANA BİLEŞEN) ---
        const Dashboard = ({ user, profile, supabase, onLogout }) => {
            const [view, setView] = useState('dashboard');
            const [receipts, setReceipts] = useState([]);
            const [loading, setLoading] = useState(true);
            const [stats, setStats] = useState({ total:0, count:0, pending:0 });
            const [aiAnalysis, setAiAnalysis] = useState(null);
            const [aiLoading, setAiLoading] = useState(false);

            // Veri Çekme - Hata Yönetimi ve Profil/Kullanıcı Kontrolü
            const fetchData = useCallback(async () => {
                if(!user?.id) return;
                
                setLoading(true);
                try {
                    let q = sb.from('fisler').select('*').order('tarih', { ascending: false });
                    
                    if (profile?.company_id) {
                        q = q.eq('company_id', profile.company_id);
                    } else {
                        q = q.eq('user_id', user.id);
                    }

                    const { data, error } = await q;

                    if (!error) {
                        setReceipts(data || []);
                        const total = (data||[]).reduce((a,b)=>a+(b.toplam_tutar||0),0);
                        const pending = (data||[]).filter(r=>r.durum==='beklemede').length;
                        setStats({ total, count: data.length, pending });
                    }
                } catch(e) { console.error(e); }
                setLoading(false);
            }, [user?.id, profile?.company_id]);

            // Yerel (Optimistic) Güncelleme
            const handleLocalUpdate = (updatedItem) => {
                setReceipts(prev => prev.map(r => r.id === updatedItem.id ? updatedItem : r));
            };

            const runAiAnalysis = async () => {
                const apiKey = localStorage.getItem('gemini_key');
                if(!apiKey) return alert("API Anahtarı eksik.");
                setAiLoading(true);
                const data = { total: stats.total, count: stats.count, recent: receipts.slice(0,10) };
                const prompt = `Analiz et: ${JSON.stringify(data)}. Türkçe, Markdown.`;
                try {
                    const res = await callGemini(apiKey, prompt);
                    setAiAnalysis(res);
                } catch(e) { alert(e.message); }
                setAiLoading(false);
            };

            useEffect(() => { fetchData(); }, [fetchData]);
            useEffect(() => { lucide.createIcons(); }, [view, receipts, aiAnalysis]);

            return (
                <div className="min-h-screen flex flex-col md:flex-row">
                    <aside className="w-full md:w-64 bg-white border-r border-slate-200 flex flex-col z-20">
                        <div className="p-6 flex items-center gap-2 border-b border-slate-100">
                            <Icon name="receipt" className="text-primary" />
                            <span className="font-bold text-lg text-slate-800">FişMatik</span>
                        </div>
                        <nav className="flex-1 p-4 space-y-1">
                            {['dashboard','receipts','reports','settings'].map(v => (
                                <button key={v} onClick={()=>setView(v)} className={`w-full flex items-center gap-3 px-4 py-3 rounded-lg text-sm font-medium transition ${view===v?'bg-blue-50 text-primary':'text-slate-600 hover:bg-slate-50'}`}>
                                    <Icon name={v==='dashboard'?'layout-dashboard':v==='receipts'?'file-text':v==='reports'?'bar-chart-3':'settings'} size={18}/> 
                                    {v==='dashboard'?'Genel Bakış':v==='receipts'?'Fişlerim':v==='reports'?'Raporlar':'Ayarlar'}
                                </button>
                            ))}
                        </nav>
                        <div className="p-4 border-t">
                            <div className="mb-4 text-xs text-slate-500">
                                <p className="font-bold text-slate-800 truncate">{profile?.full_name || user.email}</p>
                                <p>Şirket ID: {profile?.company_id || '-'}</p>
                            </div>
                            <button onClick={onLogout} className="w-full flex items-center gap-2 text-red-500 text-sm hover:bg-red-50 p-2 rounded transition"><Icon name="log-out" size={16}/> Çıkış</button>
                        </div>
                    </aside>
                    <main className="flex-1 p-4 md:p-8 overflow-y-auto h-screen bg-slate-50">
                        {view==='dashboard' && (
                            <div className="space-y-6">
                                <div className="flex justify-between items-center"><h2 className="text-2xl font-bold">Hoş Geldiniz</h2><button onClick={runAiAnalysis} disabled={aiLoading} className="px-4 py-2 bg-gradient-to-r from-violet-600 to-indigo-600 text-white rounded shadow flex gap-2 items-center">{aiLoading?<Icon name="loader-2" className="loading-spin"/>:<Icon name="sparkles"/>} Analiz</button></div>
                                {aiAnalysis && <div className="bg-white p-6 rounded border border-violet-100 shadow ai-glow relative"><div className="text-sm markdown-body" dangerouslySetInnerHTML={{__html:marked.parse(aiAnalysis)}}></div><button onClick={()=>setAiAnalysis(null)} className="absolute top-4 right-4"><Icon name="x"/></button></div>}
                                <div className="grid grid-cols-1 md:grid-cols-3 gap-6">
                                    <StatCard title="Toplam Harcama" value={stats.total.toLocaleString('tr-TR',{style:'currency',currency:'TRY'})} icon="wallet" color="text-green-600" bg="bg-green-50"/>
                                    <StatCard title="Toplam Fiş" value={stats.count} icon="file-stack" color="text-blue-600" bg="bg-blue-50"/>
                                    <StatCard title="Bekleyen" value={stats.pending} icon="clock" color="text-orange-600" bg="bg-orange-50"/>
                                </div>
                                <div className="bg-white p-6 rounded border shadow-sm">
                                    <h3 className="font-bold mb-4">Son Hareketler</h3>
                                    <ReceiptsTable receipts={receipts.slice(0,5)} loading={loading} simple={true} />
                                </div>
                            </div>
                        )}
                        {view==='receipts' && (
                            <div className="bg-white rounded border shadow-sm p-4 h-full flex flex-col">
                                <div className="flex justify-between mb-4"><h2 className="text-xl font-bold">Fiş Kayıtları</h2><button onClick={fetchData}><Icon name="refresh-ccw"/></button></div>
                                <ReceiptsTable receipts={receipts} loading={loading} supabase={sb} refresh={fetchData} onLocalUpdate={handleLocalUpdate} />
                            </div>
                        )}
                        {view==='reports' && <div className="max-w-xl mx-auto mt-10"><ReportCard user={user} profile={profile}/></div>}
                        {view==='settings' && <Settings />}
                    </main>
                </div>
            );
        };

        // --- APP ---
        const App = () => {
            const [user, setUser] = useState(null);
            const [profile, setProfile] = useState(null);

            const fetchProfile = async (u) => {
                try {
                    let { data, error } = await sb.from('users').select('*').eq('id', u.id).limit(1);
                    if(error || !data || data.length === 0) { 
                        const res = await sb.from('users').select('*').eq('email', u.email).limit(1); 
                        if(res.data && res.data.length > 0) data = res.data;
                    }
                    if(data && data.length > 0) setProfile(data[0]);
                } catch(e) {
                    console.error("Profil yükleme hatası:", e);
                }
            };

            useEffect(() => {
                let mounted = true;
                let authSubscription = null;
                
                sb.auth.getUser().then(({data})=>{ 
                    if(mounted && data?.user) { 
                        setUser(data.user); 
                        fetchProfile(data.user); 
                    } 
                });
                
                const { data: { subscription } } = sb.auth.onAuthStateChange((_, session) => { 
                    if(!mounted) return;
                    if(session?.user) { 
                        setUser(session.user); 
                        fetchProfile(session.user); 
                    } else { 
                        setUser(null); 
                        setProfile(null); 
                    }
                });
                authSubscription = subscription;
                
                return () => {
                    mounted = false;
                    if(authSubscription) authSubscription.unsubscribe();
                };
            }, []);

            if(!user) return <Login onLogin={()=>{}} />;
            return <Dashboard user={user} profile={profile} onLogout={()=>sb.auth.signOut()} supabase={sb} />;
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>