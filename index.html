<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FiÅŸMatik - AkÄ±llÄ± MÃ¼ÅŸteri Paneli</title>
    
    <!-- GEREKLÄ° KÃœTÃœPHANELER (CDN) -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: { sans: ['Inter', 'sans-serif'] },
                    colors: {
                        primary: '#2563eb', 
                        secondary: '#1e293b',
                        ai: '#8b5cf6',
                    }
                }
            }
        }
    </script>
    <style>
        body { background-color: #f8fafc; }
        .glass-panel { background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(10px); border: 1px solid #e2e8f0; }
        .loading-spin { animation: spin 1s linear infinite; }
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .ai-glow { box-shadow: 0 0 15px rgba(139, 92, 246, 0.3); }
        .markdown-body ul { list-style-type: disc; margin-left: 1.5rem; margin-top: 0.5rem; }
        .markdown-body strong { color: #4b5563; font-weight: 700; }
        .markdown-body p { margin-bottom: 0.75rem; }
        
        /* GÃ¶rsel ManipÃ¼lasyonu Ä°Ã§in */
        .image-container {
            /* JS ile kontrol edeceÄŸiz, default transition */
            transition: transform 0.2s ease-out;
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo, useCallback } = React;
        const { createClient } = supabase;

        // --- SABÄ°T AYARLAR ---
        const DEFAULT_SB_URL = "https://hequoxateionmtfjzkxl.supabase.co";
        const DEFAULT_SB_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImhlcXVveGF0ZWlvbm10Zmp6a3hsIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjUyNTg5MDAsImV4cCI6MjA4MDgzNDkwMH0.aIiIdWw2l7Kcqa4BavNJQ8ARZrdPnmxD8qSMpTlXYhA";
        
        // 1. Rapor Webhook URLleri (Test ve CanlÄ± AyrÄ±mÄ± Var)
        const N8N_REPORT_WEBHOOK_TEST = "https://n8n.ittyazilim.com/webhook-test/fbdbb58e-91f5-4137-891a-339eeb821168";
        const N8N_REPORT_WEBHOOK_PROD = "https://n8n.ittyazilim.com/webhook/fbdbb58e-91f5-4137-891a-339eeb821168";

        // 2. Åifre SÄ±fÄ±rlama Webhook URLleri (Test ve CanlÄ±)
        const N8N_RESET_PW_WEBHOOK_TEST = "https://n8n.ittyazilim.com/webhook-test/3eafd39c-fdee-406f-88ef-1b9ab4bd555e";
        const N8N_RESET_PW_WEBHOOK_PROD = "https://n8n.ittyazilim.com/webhook/3eafd39c-fdee-406f-88ef-1b9ab4bd555e";
        
        // 3. KAYIT OL (Register) Webhook URLleri (YENÄ°)
        const N8N_REGISTER_URLS = {
            TEST: "https://n8n.ittyazilim.com/webhook-test/030dfb1b-49f9-4dc8-82e3-98b884f3065c",
            PROD: "https://n8n.ittyazilim.com/webhook/030dfb1b-49f9-4dc8-82e3-98b884f3065c"
        };
        
        // 4. Alt KullanÄ±cÄ± Ekleme Webhook URLleri
        const N8N_ADD_USER_URLS = {
            TEST: "https://n8n.ittyazilim.com/webhook-test/alt-kullanici-ekle",
            PROD: "https://n8n.ittyazilim.com/webhook/alt-kullanici-ekle"
        };

        // Global Supabase Client
        const sb = createClient(DEFAULT_SB_URL, DEFAULT_SB_KEY);

        const Icon = ({ name, size = 20, className }) => {
            return <i data-lucide={name} width={size} height={size} className={className}></i>;
        };

        const callGemini = async (apiKey, prompt) => {
            const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;
            const response = await fetch(url, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
            });
            const data = await response.json();
            if (data.error) throw new Error(data.error.message);
            return data.candidates?.[0]?.content?.parts?.[0]?.text || "YanÄ±t alÄ±namadÄ±.";
        };

        // --- BÄ°LEÅENLER ---

        const StatCard = ({ title, value, icon, color, bg }) => (
            <div className="bg-white p-6 rounded-xl border border-slate-200 shadow-sm flex items-center gap-4">
                <div className={`p-4 rounded-full ${bg} ${color}`}><Icon name={icon} size={24} /></div>
                <div><p className="text-slate-500 text-sm font-medium">{title}</p><p className="text-2xl font-bold text-slate-800">{value}</p></div>
            </div>
        );

        // --- YENÄ°: Ekip YÃ¶netimi BileÅŸeni ---
        const TeamManagement = ({ user, profile }) => {
            const [users, setUsers] = useState([]);
            const [company, setCompany] = useState(null);
            const [loading, setLoading] = useState(false);
            const [showAddModal, setShowAddModal] = useState(false);
            const [newUser, setNewUser] = useState({ email: '', full_name: '', password: '', role: 'user' });
            const [adding, setAdding] = useState(false);

            const fetchTeam = useCallback(async () => {
                if(!profile?.company_id) return;
                setLoading(true);
                
                try {
                    // Åirket Bilgisi ve Limitleri Ã‡ek
                    const { data: comp, error: compError } = await sb.from('companies').select('*').eq('id', profile.company_id).single();
                    
                    if (compError) {
                        console.warn("Åirket bilgisi Ã§ekilemedi (RLS HatasÄ± Olabilir):", compError);
                    } else {
                        console.log("Åirket Bilgisi:", comp);
                    }
                    setCompany(comp);

                    // KullanÄ±cÄ±larÄ± Ã‡ek
                    const { data: team } = await sb.from('users').select('*').eq('company_id', profile.company_id);
                    setUsers(team || []);
                } catch (err) {
                    console.error("Ekip verisi hatasÄ±:", err);
                }
                
                setLoading(false);
            }, [profile?.company_id]);

            useEffect(() => { fetchTeam(); }, [fetchTeam]);

            const handleAddUser = async () => {
                // Åirket verisi yÃ¼klenememiÅŸse iÅŸlem yapma ve uyar
                if (!company) {
                    alert("Åirket bilgileri yÃ¼klenemediÄŸi iÃ§in iÅŸlem yapÄ±lamÄ±yor. LÃ¼tfen veritabanÄ± izinlerini (RLS) kontrol edin.");
                    return;
                }
                
                // Limit KontrolÃ¼
                const maxUsers = company.max_users || 5; // VarsayÄ±lan 5
                if (users.length >= maxUsers) {
                    alert(`Åirket kullanÄ±cÄ± limitinize (${maxUsers}) ulaÅŸtÄ±nÄ±z. Daha fazla kullanÄ±cÄ± ekleyemezsiniz.`);
                    return;
                }
                
                setAdding(true);
                
                // Ortam KontrolÃ¼ (Test/Prod)
                const isLocalhost = window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1';
                const targetUrl = isLocalhost ? N8N_ADD_USER_URLS.TEST : N8N_ADD_USER_URLS.PROD;
                
                try {
                    // Client tarafÄ±nda baÅŸka bir kullanÄ±cÄ± oluÅŸturmak oturumu kapatacaÄŸÄ± iÃ§in
                    // bu iÅŸlemi n8n webhook Ã¼zerinden (Service Role kullanarak) yapÄ±yoruz.
                    await fetch(targetUrl, {
                        method: 'POST',
                        mode: 'no-cors',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            company_id: profile.company_id,
                            email: newUser.email,
                            full_name: newUser.full_name,
                            password: newUser.password,
                            role: newUser.role,
                            manager_id: user.id
                        })
                    });
                    
                    alert("KullanÄ±cÄ± oluÅŸturma isteÄŸi gÃ¶nderildi. BirkaÃ§ saniye iÃ§inde listede gÃ¶rÃ¼necektir.");
                    setShowAddModal(false);
                    setNewUser({ email: '', full_name: '', password: '', role: 'user' });
                    // KÄ±sa bir bekleme sonrasÄ± listeyi yenile
                    setTimeout(fetchTeam, 3000);

                } catch (error) {
                    alert("Hata: " + error.message);
                } finally {
                    setAdding(false);
                }
            };

            if (loading) return <div className="text-center p-10 text-slate-400">YÃ¼kleniyor...</div>;

            return (
                <div className="space-y-6">
                    <div className="flex justify-between items-center">
                        <div>
                            <h2 className="text-2xl font-bold text-slate-800">Ekip YÃ¶netimi</h2>
                            <p className="text-slate-500 text-sm">
                                {company?.name || 'Åirket YÃ¼kleniyor...'} (KullanÄ±cÄ±lar: {users.length} / {company?.max_users || '-'})
                            </p>
                        </div>
                        <button 
                            onClick={() => setShowAddModal(true)}
                            className="bg-primary text-white px-4 py-2 rounded-lg flex items-center gap-2 hover:bg-blue-700 transition"
                        >
                            <Icon name="user-plus" size={18} /> Yeni KullanÄ±cÄ±
                        </button>
                    </div>

                    <div className="bg-white rounded-xl border border-slate-200 overflow-hidden">
                        <table className="w-full text-left text-sm">
                            <thead className="bg-slate-50 text-slate-500 uppercase text-xs">
                                <tr>
                                    <th className="px-6 py-3">Ad Soyad</th>
                                    <th className="px-6 py-3">E-Posta</th>
                                    <th className="px-6 py-3">Rol</th>
                                    <th className="px-6 py-3">Durum</th>
                                </tr>
                            </thead>
                            <tbody className="divide-y divide-slate-100">
                                {users.map(u => (
                                    <tr key={u.id} className="hover:bg-slate-50">
                                        <td className="px-6 py-4 font-medium text-slate-800">{u.full_name || '-'}</td>
                                        <td className="px-6 py-4 text-slate-600">{u.email}</td>
                                        <td className="px-6 py-4">
                                            <span className={`px-2 py-1 rounded text-xs ${u.role === 'admin' ? 'bg-purple-100 text-purple-700' : 'bg-blue-100 text-blue-700'}`}>
                                                {u.role === 'admin' ? 'YÃ¶netici' : 'Personel'}
                                            </span>
                                        </td>
                                        <td className="px-6 py-4">
                                            {u.status === 'active' || u.status === 'onaylandi' ? 
                                                <span className="text-green-600 flex items-center gap-1"><Icon name="check-circle" size={14}/> Aktif</span> : 
                                                <span className="text-orange-500 flex items-center gap-1"><Icon name="clock" size={14}/> Beklemede</span>
                                            }
                                        </td>
                                    </tr>
                                ))}
                            </tbody>
                        </table>
                    </div>

                    {showAddModal && (
                        <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-50">
                            <div className="bg-white p-6 rounded-xl shadow-xl w-full max-w-md animate-in fade-in zoom-in duration-200">
                                <h3 className="text-lg font-bold mb-4">Yeni KullanÄ±cÄ± Ekle</h3>
                                <div className="space-y-3">
                                    <input type="text" placeholder="Ad Soyad" className="w-full p-2 border rounded" value={newUser.full_name} onChange={e=>setNewUser({...newUser, full_name:e.target.value})} />
                                    <input type="email" placeholder="E-Posta" className="w-full p-2 border rounded" value={newUser.email} onChange={e=>setNewUser({...newUser, email:e.target.value})} />
                                    <input type="password" placeholder="GeÃ§ici Åifre" className="w-full p-2 border rounded" value={newUser.password} onChange={e=>setNewUser({...newUser, password:e.target.value})} />
                                    <select className="w-full p-2 border rounded" value={newUser.role} onChange={e=>setNewUser({...newUser, role:e.target.value})}>
                                        <option value="user">Personel (Sadece FiÅŸ YÃ¼kler)</option>
                                        <option value="admin">YÃ¶netici (Tam Yetki)</option>
                                    </select>
                                </div>
                                <div className="mt-6 flex justify-end gap-2">
                                    <button onClick={()=>setShowAddModal(false)} className="px-4 py-2 text-slate-500 hover:bg-slate-100 rounded">Ä°ptal</button>
                                    <button onClick={handleAddUser} disabled={adding} className="px-4 py-2 bg-primary text-white rounded hover:bg-blue-700 flex items-center gap-2">
                                        {adding ? <Icon name="loader-2" className="loading-spin" size={16}/> : <Icon name="user-plus" size={16}/>} Ekle
                                    </button>
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        // --- HAKKIMIZDA BÄ°LEÅENÄ° ---
        const AboutContent = () => (
            <div className="space-y-8 text-left">
                <div className="flex items-start gap-4">
                    <div className="p-3 bg-blue-100 rounded-lg text-primary mt-1">
                        <Icon name="zap" size={24} />
                    </div>
                    <div>
                        <h3 className="text-lg font-bold text-slate-800 mb-2">FiÅŸMatik Nedir?</h3>
                        <p className="text-slate-600 leading-relaxed">
                            FiÅŸMatik, iÅŸletmelerin ve Ã§alÄ±ÅŸanlarÄ±n harcama fiÅŸlerini yapay zeka destekli OCR teknolojisi ile saniyeler iÃ§inde dijitalleÅŸtiren, raporlayan ve muhasebeleÅŸtiren akÄ±llÄ± bir platformdur. Manuel veri giriÅŸini ortadan kaldÄ±rÄ±r, zamandan tasarruf saÄŸlar.
                        </p>
                    </div>
                </div>

                <div className="flex items-start gap-4">
                    <div className="p-3 bg-green-100 rounded-lg text-green-600 mt-1">
                        <Icon name="scan-line" size={24} />
                    </div>
                    <div>
                        <h3 className="text-lg font-bold text-slate-800 mb-2">NasÄ±l KullanÄ±lÄ±r?</h3>
                        <ul className="list-disc list-inside text-slate-600 space-y-2">
                            <li>Telegram botumuza fiÅŸ fotoÄŸrafÄ±nÄ± gÃ¶nderin.</li>
                            <li>Yapay zeka fiÅŸinizi okur ve sisteme kaydeder.</li>
                            <li>Bu panel Ã¼zerinden harcamalarÄ±nÄ±zÄ± gÃ¶rÃ¼ntÃ¼leyin ve dÃ¼zenleyin.</li>
                            <li>Tek tÄ±kla Excel raporunuzu e-posta adresinize alÄ±n.</li>
                        </ul>
                    </div>
                </div>
                
                 {/* YAPAY ZEKA ANALÄ°ZÄ° */}
                <div className="flex items-start gap-4">
                    <div className="p-3 bg-indigo-100 rounded-lg text-indigo-600 mt-1">
                        <Icon name="sparkles" size={24} />
                    </div>
                    <div>
                        <h3 className="text-lg font-bold text-slate-800 mb-2">Yapay Zeka Analizi</h3>
                        <p className="text-slate-600 leading-relaxed">
                            Google Gemini ile harcamalarÄ±nÄ±zÄ± analiz edin, tasarruf Ã¶nerileri alÄ±n. Ayarlar sayfasÄ±nda "Google Gemini API AnahtarÄ±" bÃ¶lÃ¼mÃ¼ne Gemini API anahtarÄ±nÄ±zÄ± girerek bu Ã¶zelliÄŸi aktif edebilirsiniz. sistemdeki fiÅŸ kayÄ±tlarÄ±nÄ±z arttÄ±kÃ§a tutarlÄ± sonuÃ§lar verme olasÄ±lÄ±ÄŸÄ± artacaktÄ±r.
                        </p>
                    </div>
                </div>

                <div className="flex items-start gap-4">
                    <div className="p-3 bg-purple-100 rounded-lg text-purple-600 mt-1">
                        <Icon name="user-plus" size={24} />
                    </div>
                    <div>
                        <h3 className="text-lg font-bold text-slate-800 mb-2">NasÄ±l KayÄ±t Olunur?</h3>
                        <div className="bg-slate-50 p-4 rounded-lg border border-slate-200">
                            <p className="text-slate-600 mb-3">
                                FiÅŸMatik ÅŸu an davetiye ve baÅŸvuru usulÃ¼ ile Ã§alÄ±ÅŸmaktadÄ±r. Sisteme kayÄ±t olmak ve ÅŸirketiniz iÃ§in aktivasyon saÄŸlamak iÃ§in lÃ¼tfen Telegram botumuz Ã¼zerinden baÅŸvuru yapÄ±nÄ±z.
                            </p>
                            <a href="https://t.me/ITT_Fis_matik_BOT" target="_blank" className="inline-flex items-center gap-2 text-primary font-medium hover:underline">
                                <Icon name="send" size={16} /> FiÅŸMatik Telegram Botuna Git
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        );

        // --- HAKKIMIZDA SAYFASI (Public) ---
        const AboutPage = ({ onBack }) => (
            <div className="min-h-screen bg-slate-50 flex flex-col items-center justify-center p-4">
                <div className="max-w-3xl w-full bg-white rounded-2xl shadow-xl overflow-hidden animate-in fade-in zoom-in duration-300">
                    {/* Header */}
                    <div className="bg-gradient-to-r from-blue-600 to-indigo-700 p-8 text-center text-white relative">
                        <button onClick={onBack} className="absolute left-6 top-6 p-2 bg-white/10 hover:bg-white/20 rounded-full transition text-white">
                            <Icon name="arrow-left" size={24} />
                        </button>
                        <div className="flex justify-center mb-4">
                            <div className="p-3 bg-white/20 rounded-full backdrop-blur-sm">
                                <Icon name="receipt" size={40} />
                            </div>
                        </div>
                        <h1 className="text-3xl font-bold mb-2">FiÅŸMatik</h1>
                        <p className="text-blue-100">AkÄ±llÄ± Harcama YÃ¶netim AsistanÄ±nÄ±z</p>
                    </div>

                    {/* Content */}
                    <div className="p-8 md:p-12">
                        <AboutContent />
                    </div>

                    {/* Footer */}
                    <div className="bg-slate-50 p-6 text-center border-t border-slate-100 text-slate-500 text-sm">
                        &copy; 2025 Ä°TT YazÄ±lÄ±m. TÃ¼m haklarÄ± saklÄ±dÄ±r.
                    </div>
                </div>
            </div>
        );

        const ReceiptsTable = ({ receipts, loading, simple, supabase, refresh, onLocalUpdate, userRole }) => {
            const [editItem, setEditItem] = useState(null);
            const [isSaving, setIsSaving] = useState(false);
            const [filters, setFilters] = useState({ tarih: '', isletme_adi: '', toplam_tutar: '', durum: '', kategori: '', kart_son_4: '' });
            
            // GÃ–RSEL MANÄ°PÃœLASYON STATE'LERÄ°
            const [imgRotation, setImgRotation] = useState(0);
            const [imgZoom, setImgZoom] = useState(1);
            // Pan (KaydÄ±rma) State'leri
            const [pan, setPan] = useState({ x: 0, y: 0 });
            const [isDragging, setIsDragging] = useState(false);
            const [dragStart, setDragStart] = useState({ x: 0, y: 0 });

            // Modal aÃ§Ä±ldÄ±ÄŸÄ±nda state'leri sÄ±fÄ±rla
            useEffect(() => {
                if (editItem) {
                    setImgRotation(0);
                    setImgZoom(1);
                    setPan({ x: 0, y: 0 });
                    lucide.createIcons();
                }
            }, [editItem]);

            // Zoom/Rotate/Pan deÄŸiÅŸtiÄŸinde ikonlarÄ± gÃ¼ncelle
            useEffect(() => {
                lucide.createIcons();
            }, [imgRotation, imgZoom, pan]);

            // --- PAN HANDLERS ---
            const handleMouseDown = (e) => {
                e.preventDefault(); // Resmin native sÃ¼rÃ¼klenmesini engelle
                setIsDragging(true);
                setDragStart({ x: e.clientX - pan.x, y: e.clientY - pan.y });
            };

            const handleMouseMove = (e) => {
                if (!isDragging) return;
                e.preventDefault();
                setPan({
                    x: e.clientX - dragStart.x,
                    y: e.clientY - dragStart.y
                });
            };

            const handleMouseUp = () => {
                setIsDragging(false);
            };

            // Durum GÃ¶stergesi (Badge) Fonksiyonu
            const getStatusBadge = (status) => {
                const s = status?.toLowerCase() || '';
                let classes = 'bg-gray-100 text-gray-800';
                let label = status || '-';

                if (s === 'onaylandi' || s === 'onaylandÄ±') {
                    classes = 'bg-green-100 text-green-800';
                    label = 'OnaylandÄ±';
                } else if (s === 'beklemede') {
                    classes = 'bg-yellow-100 text-yellow-800';
                    label = 'Beklemede';
                } else if (s === 'reddedildi') {
                    classes = 'bg-red-100 text-red-800';
                    label = 'Reddedildi';
                } else if (s === 'mukerrer' || s === 'mÃ¼kerrer') {
                    classes = 'bg-orange-100 text-orange-800';
                    label = 'MÃ¼kerrer';
                }

                return <span className={`px-2 py-1 rounded text-xs font-medium ${classes}`}>{label}</span>;
            };

            const filtered = useMemo(() => {
                if (simple) return receipts;
                return receipts.filter(r => {
                    const matchTarih = !filters.tarih || r.tarih?.includes(filters.tarih);
                    const matchIsletme = !filters.isletme_adi || r.isletme_adi?.toLowerCase().includes(filters.isletme_adi.toLowerCase());
                    const matchTutar = !filters.toplam_tutar || r.toplam_tutar?.toString().includes(filters.toplam_tutar);
                    const matchKategori = !filters.kategori || r.kategori?.toLowerCase().includes(filters.kategori.toLowerCase());
                    const matchKart = !filters.kart_son_4 || r.kart_son_4?.toString().includes(filters.kart_son_4);
                    
                    // Durum Filtresi (GÃ¼ncellenmiÅŸ)
                    let matchDurum = true;
                    if (filters.durum) {
                        const s = r.durum?.toLowerCase() || '';
                        const f = filters.durum.toLowerCase();
                        
                        if (f === 'onaylandi') {
                            matchDurum = s === 'onaylandi' || s === 'onaylandÄ±';
                        } else if (f === 'mukerrer') {
                            matchDurum = s === 'mukerrer' || s === 'mÃ¼kerrer';
                        } else {
                            matchDurum = s.includes(f);
                        }
                    }

                    return matchTarih && matchIsletme && matchTutar && matchDurum && matchKategori && matchKart;
                });
            }, [receipts, filters, simple]);

            const handleSave = async () => {
                setIsSaving(true);
                
                // Ä°yimser GÃ¼ncelleme
                const updatedItem = { ...editItem };
                
                // --- OTOMATÄ°K KATEGORÄ° BELÄ°RLEME ---
                const categories = updatedItem.ocr_detaylari?.map(l => l.kategori).filter(Boolean) || [];
                const uniqueCategories = [...new Set(categories)];
                const mainCategory = uniqueCategories.length > 1 ? 'Ã‡oklu' : (uniqueCategories[0] || 'Genel');
                updatedItem.kategori = mainCategory;

                if(onLocalUpdate) onLocalUpdate(updatedItem);
                
                setEditItem(null); 

                try {
                    const { error } = await supabase.from('fisler').update({
                        isletme_adi: updatedItem.isletme_adi,
                        toplam_tutar: parseFloat(updatedItem.toplam_tutar),
                        tarih: updatedItem.tarih,
                        durum: updatedItem.durum,
                        kategori: mainCategory,
                        ocr_detaylari: updatedItem.ocr_detaylari
                    }).eq('id', updatedItem.id);

                    if (error) {
                        alert("Hata: " + error.message);
                        if (refresh) refresh(); 
                    }
                } catch (e) {
                    alert("KayÄ±t hatasÄ±: " + e.message);
                    if (refresh) refresh();
                } finally {
                    setIsSaving(false);
                }
            };

            const addLine = () => setEditItem({ ...editItem, ocr_detaylari: [...(editItem.ocr_detaylari||[]), {aciklama:'', kategori:'', kdv:18, tutar:0}] });
            const removeLine = (idx) => {
                const lines = [...editItem.ocr_detaylari];
                lines.splice(idx, 1);
                setEditItem({ ...editItem, ocr_detaylari: lines });
            };
            const updateLine = (idx, key, val) => {
                const lines = [...editItem.ocr_detaylari];
                lines[idx][key] = val;
                setEditItem({ ...editItem, ocr_detaylari: lines });
            };

            if (loading) return <div className="p-8 text-center text-slate-400">YÃ¼kleniyor...</div>;
            if (receipts.length === 0) return <div className="p-8 text-center text-slate-400">Veri yok.</div>;

            return (
                <>
                    <div className="overflow-x-auto">
                        <table className="w-full text-left text-sm">
                            <thead className="bg-slate-50 text-slate-500 uppercase text-xs sticky top-0">
                                <tr>
                                    <th className="px-6 py-3">Tarih</th>
                                    <th className="px-6 py-3">Ä°ÅŸletme</th>
                                    <th className="px-6 py-3">Kategori</th>
                                    <th className="px-6 py-3">Kart Son 4</th>
                                    <th className="px-6 py-3">Tutar</th>
                                    <th className="px-6 py-3">Durum</th>
                                    {!simple && <th className="px-6 py-3 text-right">Ä°ÅŸlem</th>}
                                </tr>
                                {!simple && (
                                    <tr className="bg-slate-100">
                                        <th className="px-2"><input placeholder="YÄ±l-Ay-GÃ¼n" className="w-full p-1 border rounded" onChange={e=>setFilters({...filters, tarih:e.target.value})}/></th>
                                        <th className="px-2"><input placeholder="Ara..." className="w-full p-1 border rounded" onChange={e=>setFilters({...filters, isletme_adi:e.target.value})}/></th>
                                        <th className="px-2">
                                            <select className="w-full p-1 border rounded" onChange={e=>setFilters({...filters, kategori:e.target.value})}>
                                                <option value="">Hepsi</option>
                                                <option value="Yemek">Yemek</option>
                                                <option value="Market">Market</option>
                                                <option value="YakÄ±t">YakÄ±t</option>
                                                <option value="Konaklama">Konaklama</option>
                                                <option value="UlaÅŸÄ±m">UlaÅŸÄ±m</option>
                                                <option value="DiÄŸer">DiÄŸer</option>
                                            </select>
                                        </th>
                                        <th className="px-2"><input placeholder="Son 4..." className="w-full p-1 border rounded" onChange={e=>setFilters({...filters, kart_son_4:e.target.value})}/></th>
                                        <th className="px-2"><input placeholder="Tutar..." className="w-full p-1 border rounded" onChange={e=>setFilters({...filters, toplam_tutar:e.target.value})}/></th>
                                        <th className="px-2">
                                            <select className="w-full p-1 border rounded" onChange={e=>setFilters({...filters, durum:e.target.value})}>
                                                <option value="">Hepsi</option>
                                                <option value="beklemede">Beklemede</option>
                                                <option value="onaylandi">OnaylandÄ±</option>
                                                <option value="reddedildi">Reddedildi</option>
                                                <option value="mukerrer">MÃ¼kerrer</option>
                                            </select>
                                        </th>
                                        <th></th>
                                    </tr>
                                )}
                            </thead>
                            <tbody className="divide-y divide-slate-100">
                                {filtered.map(r => (
                                    <tr key={r.id} className="hover:bg-slate-50 transition group">
                                        <td className="px-6 py-4">{new Date(r.tarih).toLocaleDateString('tr-TR')}</td>
                                        <td className="px-6 py-4 font-medium">{r.isletme_adi}</td>
                                        <td className="px-6 py-4 text-slate-500">{r.kategori || '-'}</td>
                                        <td className="px-6 py-4 text-slate-500">{r.kart_son_4 || '-'}</td>
                                        <td className="px-6 py-4 font-bold">{r.toplam_tutar?.toLocaleString('tr-TR', {style:'currency', currency:'TRY'})}</td>
                                        <td className="px-6 py-4">{getStatusBadge(r.durum)}</td>
                                        {!simple && <td className="px-6 py-4 text-right"><button onClick={()=>setEditItem(JSON.parse(JSON.stringify(r)))} className="text-primary hover:bg-blue-50 p-2 rounded"><Icon name="pencil" size={16}/></button></td>}
                                    </tr>
                                ))}
                            </tbody>
                        </table>
                    </div>

                    {editItem && (
                        <div className="fixed inset-0 bg-black/80 flex items-center justify-center z-50 p-4">
                            <div className="bg-white w-full max-w-6xl h-[90vh] rounded-xl flex overflow-hidden shadow-2xl">
                                
                                {/* SOL TARAF: GÃ–RSEL (DÃœZENLENMÄ°Å) */}
                                <div 
                                    className="w-1/2 bg-slate-900 flex items-center justify-center relative p-4 overflow-hidden group cursor-move"
                                    onMouseDown={handleMouseDown}
                                    onMouseMove={handleMouseMove}
                                    onMouseUp={handleMouseUp}
                                    onMouseLeave={handleMouseUp}
                                >
                                    {editItem.gorsel_url ? (
                                        <>
                                            <div 
                                                className="image-container"
                                                style={{ 
                                                    transform: `translate(${pan.x}px, ${pan.y}px) rotate(${imgRotation}deg) scale(${imgZoom})`,
                                                    maxWidth: '100%',
                                                    maxHeight: '100%',
                                                    display: 'flex',
                                                    alignItems: 'center',
                                                    justifyContent: 'center',
                                                    cursor: isDragging ? 'grabbing' : 'grab',
                                                    transition: isDragging ? 'none' : 'transform 0.2s ease-out'
                                                }}
                                            >
                                                <img src={editItem.gorsel_url} className="max-w-full max-h-full object-contain shadow-lg pointer-events-none" />
                                            </div>
                                            
                                            {/* GÃ–RSEL KONTROL TOOLBAR */}
                                            <div className="absolute bottom-6 flex items-center gap-2 bg-slate-800/90 p-2 rounded-full backdrop-blur-sm border border-white/10 shadow-xl z-20 opacity-0 group-hover:opacity-100 transition-opacity duration-300" onMouseDown={(e) => e.stopPropagation()}>
                                                <button onClick={() => setImgZoom(z => Math.max(0.5, z - 0.25))} className="p-2 text-white hover:bg-white/20 rounded-full transition" title="UzaklaÅŸtÄ±r"><Icon name="zoom-out" size={18}/></button>
                                                <span className="text-xs text-slate-400 font-mono w-12 text-center">{Math.round(imgZoom * 100)}%</span>
                                                <button onClick={() => setImgZoom(z => Math.min(3, z + 0.25))} className="p-2 text-white hover:bg-white/20 rounded-full transition" title="YakÄ±nlaÅŸtÄ±r"><Icon name="zoom-in" size={18}/></button>
                                                
                                                <div className="w-px h-6 bg-white/20 mx-1"></div>
                                                
                                                <button onClick={() => { setImgZoom(1); setImgRotation(0); setPan({x:0, y:0}); }} className="p-2 text-white hover:bg-white/20 rounded-full transition" title="SÄ±fÄ±rla"><Icon name="refresh-ccw" size={18}/></button>
                                                <button onClick={() => setImgRotation(r => r + 90)} className="p-2 text-white hover:bg-white/20 rounded-full transition" title="SaÄŸa DÃ¶ndÃ¼r"><Icon name="rotate-cw" size={18}/></button>
                                            </div>
                                        </>
                                    ) : ( 
                                        <p className="text-white">GÃ¶rsel Yok</p>
                                    )}
                                    {editItem.gorsel_url && <a href={editItem.gorsel_url} target="_blank" className="absolute top-4 right-4 bg-white/10 p-2 rounded text-white hover:bg-white/20 transition z-10" onMouseDown={(e) => e.stopPropagation()}><Icon name="external-link" size={20}/></a>}
                                </div>

                                {/* SAÄ TARAF: DÃœZENLEME FORMU */}
                                <div className="w-1/2 flex flex-col bg-white">
                                    <div className="p-4 border-b flex justify-between items-center">
                                        <h3 className="font-bold text-lg">FiÅŸ DetaylarÄ±</h3>
                                        <button onClick={()=>setEditItem(null)}><Icon name="x"/></button>
                                    </div>
                                    <div className="flex-1 overflow-y-auto p-6 space-y-6">
                                        <div className="grid grid-cols-2 gap-4">
                                            <div><label className="text-xs text-slate-500">Ä°ÅŸletme</label><input className="w-full border p-2 rounded" value={editItem.isletme_adi} onChange={e=>setEditItem({...editItem, isletme_adi:e.target.value})} /></div>
                                            <div><label className="text-xs text-slate-500">Tarih</label><input type="datetime-local" className="w-full border p-2 rounded" value={editItem.tarih ? editItem.tarih.slice(0,16) : ''} onChange={e=>setEditItem({...editItem, tarih:e.target.value})} /></div>
                                            <div><label className="text-xs text-slate-500">Tutar</label><input type="number" step="0.01" className="w-full border p-2 rounded font-bold" value={editItem.toplam_tutar} onChange={e=>setEditItem({...editItem, toplam_tutar:e.target.value})} /></div>
                                            <div><label className="text-xs text-slate-500">Durum</label>
                                                <select className="w-full border p-2 rounded" value={editItem.durum} onChange={e=>setEditItem({...editItem, durum:e.target.value})}>
                                                    <option value="beklemede">Beklemede</option>
                                                    <option value="onaylandi">OnaylandÄ±</option>
                                                    <option value="reddedildi">Reddedildi</option>
                                                    <option value="mukerrer">MÃ¼kerrer</option>
                                                </select>
                                            </div>
                                            
                                            {/* KATEGORÄ° ALANI */}
                                            <div className="col-span-2">
                                                <label className="text-xs text-slate-500">Genel Kategori (Otomatik)</label>
                                                <div className="flex gap-2">
                                                    <input className="w-full border p-2 rounded bg-slate-50 text-slate-500" value={editItem.kategori || 'Otomatik'} disabled />
                                                </div>
                                            </div>

                                        </div>
                                        <hr/>
                                        <div>
                                            <div className="flex justify-between mb-2">
                                                <h4 className="font-bold text-sm">Harcama Kalemleri</h4>
                                                <button onClick={addLine} className="text-xs bg-blue-50 text-primary px-2 py-1 rounded">+ Ekle</button>
                                            </div>
                                            <div className="space-y-2">
                                                {/* TABLO BAÅLIKLARI */}
                                                <div className="grid grid-cols-12 gap-2 text-xs font-bold text-slate-500">
                                                    <div className="col-span-4">AÃ§Ä±klama</div>
                                                    <div className="col-span-3">Kategori</div>
                                                    <div className="col-span-2">KDV</div>
                                                    <div className="col-span-2">Tutar</div>
                                                    <div className="col-span-1"></div>
                                                </div>
                                                {(editItem.ocr_detaylari || []).map((line, i) => (
                                                    <div key={i} className="grid grid-cols-12 gap-2 items-center">
                                                        <div className="col-span-4"><input className="w-full border-b outline-none text-sm" value={line.aciklama||line.UrunTuru||''} onChange={e=>updateLine(i,'aciklama',e.target.value)} placeholder="ÃœrÃ¼n" /></div>
                                                        <div className="col-span-3">
                                                            <select className="w-full border-b outline-none text-sm bg-transparent cursor-pointer" value={line.kategori || ''} onChange={e=>updateLine(i,'kategori',e.target.value)}>
                                                                <option value="">SeÃ§iniz</option>
                                                                <option value="Yemek">Yemek</option>
                                                                <option value="Market">Market</option>
                                                                <option value="YakÄ±t">YakÄ±t</option>
                                                                <option value="Konaklama">Konaklama</option>
                                                                <option value="UlaÅŸÄ±m">UlaÅŸÄ±m</option>
                                                                <option value="Giyim">Giyim</option>
                                                                <option value="KÄ±rtasiye">KÄ±rtasiye</option>
                                                                <option value="Teknoloji">Teknoloji</option>
                                                                <option value="Temizlik">Temizlik</option>
                                                                <option value="DiÄŸer">DiÄŸer</option>
                                                            </select>
                                                        </div>
                                                        <div className="col-span-2"><input type="number" className="w-full border-b outline-none text-sm" value={line.kdv||line.KDVOrani||0} onChange={e=>updateLine(i,'kdv',e.target.value)} /></div>
                                                        <div className="col-span-2"><input type="number" className="w-full border-b outline-none text-sm" value={line.tutar||line.Tutar_KDVDahil||0} onChange={e=>updateLine(i,'tutar',e.target.value)} /></div>
                                                        <div className="col-span-1 text-right"><button onClick={()=>removeLine(i)} className="text-red-400 hover:text-red-600"><Icon name="trash-2" size={14}/></button></div>
                                                    </div>
                                                ))}
                                            </div>
                                        </div>
                                    </div>
                                    <div className="p-4 border-t flex justify-end gap-2">
                                        <button onClick={()=>setEditItem(null)} className="px-4 py-2 text-slate-500 hover:bg-slate-100 rounded">Ä°ptal</button>
                                        <button onClick={handleSave} disabled={isSaving} className="px-6 py-2 bg-green-600 text-white rounded hover:bg-green-700 flex items-center gap-2">
                                            {isSaving ? <><Icon name="loader-2" className="loading-spin"/> Kaydediliyor...</> : 'Kaydet'}
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    )}
                </>
            );
        };

        const ReportCard = ({ user, profile }) => {
            const [dates, setDates] = useState({ start: '', end: '' });
            const [loading, setLoading] = useState(false);
            
            // Modified to accept the event object 'e'
            const sendReport = async (e) => {
                if(!dates.start || !dates.end) {
                    alert("LÃ¼tfen tarih aralÄ±ÄŸÄ± seÃ§iniz.");
                    return;
                }
                
                setLoading(true);
                
                // Payload hazÄ±rlama
                const payload = {
                    company_id: profile?.company_id || null,
                    start: dates.start,
                    end: dates.end,
                    email: user.email || 'kullanici@mail.com',
                    source: 'FisMatik_Panel'
                };
                
                // --- RAPOR WEBHOOK MANTIÄI ---
                // VarsayÄ±lan: Localhost ise Test, Sunucu ise Prod
                const isLocalhost = window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1';
                
                // SHIFT TUÅU KONTROLÃœ: EÄŸer butona Shift ile basÄ±ldÄ±ysa ZORLA TEST URL'sini kullan
                const forceTest = e && e.shiftKey;
                
                let targetUrl;
                if (forceTest) {
                    targetUrl = N8N_REPORT_WEBHOOK_TEST;
                    console.log("ğŸ› ï¸ Shift tuÅŸuna basÄ±ldÄ±: TEST Webhook zorlandÄ±.");
                } else {
                    targetUrl = isLocalhost ? N8N_REPORT_WEBHOOK_TEST : N8N_REPORT_WEBHOOK_PROD;
                }
                
                // Konsola detaylÄ± bilgi yaz
                console.log(`ğŸš€ GÃ¶nderilen Hedef: ${forceTest || isLocalhost ? 'TEST' : 'CANLI'}`);
                console.log("ğŸ”— URL:", targetUrl);
                console.log("ğŸ“¦ Veri:", payload);

                try {
                    // no-cors moduyla isteÄŸi at
                    await fetch(targetUrl, {
                        method: 'POST',
                        mode: 'no-cors',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });
                    
                    const envMsg = forceTest ? "(TEST ORTAMI)" : "";
                    alert(`Rapor isteÄŸiniz alÄ±ndÄ± ${envMsg}. Raporunuz hazÄ±rlandÄ±ÄŸÄ±nda mail adresinize gÃ¶nderilecektir.`);
                } catch (error) {
                    console.error("Webhook hatasÄ±:", error);
                    alert("Rapor isteÄŸiniz alÄ±ndÄ±. Raporunuz hazÄ±rlandÄ±ÄŸÄ±nda mail adresinize gÃ¶nderilecektir.");
                } finally {
                    setLoading(false);
                }
            };
            
            return (
                <div className="bg-white p-8 rounded-xl border border-slate-200 shadow-sm text-center">
                    <div className="inline-block p-4 bg-blue-50 rounded-full text-primary mb-4"><Icon name="mail" size={32} /></div>
                    <h2 className="text-xl font-bold text-slate-800 mb-2">Rapor OluÅŸtur</h2>
                    <p className="text-slate-500 mb-6">SeÃ§tiÄŸiniz tarih aralÄ±ÄŸÄ±ndaki harcamalar Excel olarak e-postanÄ±za gÃ¶nderilecektir.</p>
                    <div className="flex gap-4 mb-6">
                        <div className="w-1/2 text-left"><label className="text-xs font-semibold text-slate-500">BaÅŸlangÄ±Ã§</label><input type="date" className="w-full border p-2 rounded mt-1" value={dates.start} onChange={e=>setDates({...dates, start:e.target.value})} /></div>
                        <div className="w-1/2 text-left"><label className="text-xs font-semibold text-slate-500">BitiÅŸ</label><input type="date" className="w-full border p-2 rounded mt-1" value={dates.end} onChange={e=>setDates({...dates, end:e.target.value})} /></div>
                    </div>
                    {/* Pass the event object automatically */}
                    <button onClick={sendReport} disabled={loading} className="w-full bg-primary text-white py-3 rounded-lg font-medium hover:bg-blue-700 transition flex justify-center gap-2">
                        {loading ? <><Icon name="loader-2" className="loading-spin" size={18} /> GÃ¶nderiliyor...</> : <><Icon name="send" size={18} /> Raporu E-Postala</>}
                    </button>
                </div>
            );
        };

        const Settings = ({ user }) => {
            const [apiKey, setApiKey] = useState(localStorage.getItem('gemini_key') || '');
            const [saved, setSaved] = useState(false);
            const [newPassword, setNewPassword] = useState('');
            const [confirmPassword, setConfirmPassword] = useState('');
            const [passLoading, setPassLoading] = useState(false);
            const [passMsg, setPassMsg] = useState({ type: '', text: '' });

            const saveSettings = () => { localStorage.setItem('gemini_key', apiKey); setSaved(true); setTimeout(() => setSaved(false), 2000); };
            const handleChangePassword = async (e) => {
                e.preventDefault();
                if (newPassword !== confirmPassword) { setPassMsg({ type: 'error', text: 'Åifreler eÅŸleÅŸmiyor.' }); return; }
                if (newPassword.length < 6) { setPassMsg({ type: 'error', text: 'Åifre en az 6 karakter olmalÄ±.' }); return; }
                setPassLoading(true); setPassMsg({ type: '', text: '' });
                const { error } = await sb.auth.updateUser({ password: newPassword });
                if (error) setPassMsg({ type: 'error', text: 'Hata: ' + error.message });
                else { setPassMsg({ type: 'success', text: 'Åifre gÃ¼ncellendi.' }); setNewPassword(''); setConfirmPassword(''); }
                setPassLoading(false);
            };

            return (
                <div className="max-w-2xl mx-auto mt-10 space-y-8">
                    <div className="bg-white p-8 rounded-xl border border-slate-200 shadow-sm">
                        <div className="flex items-center gap-3 mb-6">
                            <div className="p-3 bg-slate-100 rounded-full text-slate-600"><Icon name="sparkles" size={24} /></div>
                            <div><h2 className="text-xl font-bold text-slate-800">Yapay Zeka</h2><p className="text-sm text-slate-500">Analiz iÃ§in API anahtarÄ±</p></div>
                        </div>
                        <div className="space-y-4">
                            <div>
                                <label className="block text-sm font-medium text-slate-700 mb-1">Google Gemini API AnahtarÄ±</label>
                                <input type="password" value={apiKey} onChange={e=>setApiKey(e.target.value)} placeholder="AIzaSy..." className="w-full p-3 border rounded-lg focus:ring-2 focus:ring-ai outline-none font-mono text-sm"/>
                            </div>
                            <button onClick={saveSettings} className="px-6 py-2 bg-slate-800 text-white rounded-lg hover:bg-slate-900 transition flex items-center gap-2">{saved ? <Icon name="check" size={18} /> : <Icon name="save" size={18} />} {saved ? 'Kaydedildi' : 'Kaydet'}</button>
                        </div>
                    </div>
                    <div className="bg-white p-8 rounded-xl border border-slate-200 shadow-sm">
                        <div className="flex items-center gap-3 mb-6">
                            <div className="p-3 bg-slate-100 rounded-full text-slate-600"><Icon name="lock" size={24} /></div>
                            <div><h2 className="text-xl font-bold text-slate-800">GÃ¼venlik</h2><p className="text-sm text-slate-500">Åifrenizi gÃ¼ncelleyin</p></div>
                        </div>
                        <form onSubmit={handleChangePassword} className="space-y-4">
                            <div><label className="block text-sm font-medium text-slate-700 mb-1">Yeni Åifre</label><input type="password" value={newPassword} onChange={e=>setNewPassword(e.target.value)} className="w-full p-3 border rounded-lg focus:ring-2 focus:ring-primary outline-none" required /></div>
                            <div><label className="block text-sm font-medium text-slate-700 mb-1">Yeni Åifre (Tekrar)</label><input type="password" value={confirmPassword} onChange={e=>setConfirmPassword(e.target.value)} className="w-full p-3 border rounded-lg focus:ring-2 focus:ring-primary outline-none" required /></div>
                            {passMsg.text && (<div className={`p-3 rounded text-sm ${passMsg.type === 'error' ? 'bg-red-50 text-red-600' : 'bg-green-50 text-green-600'}`}>{passMsg.text}</div>)}
                            <button disabled={passLoading} className="px-6 py-2 bg-primary text-white rounded-lg hover:bg-blue-700 transition flex items-center gap-2">{passLoading ? <Icon name="loader-2" className="loading-spin" /> : 'Åifreyi GÃ¼ncelle'}</button>
                        </form>
                    </div>
                </div>
            );
        };

        const Login = ({ onLogin }) => {
            const [email, setEmail] = useState('');
            const [password, setPassword] = useState('');
            const [loading, setLoading] = useState(false);
            const [error, setError] = useState('');
            const [info, setInfo] = useState('');
            const [view, setView] = useState('login'); // login, register, forgot, about
            
            // KayÄ±t Formu State'leri
            const [regData, setRegData] = useState({ company_name: '', tax_no: '', full_name: '', email: '', password: '', first_name: '', last_name: '', phone: '', tax_office: '' });

            const handleLogin = async (e) => {
                e.preventDefault(); setLoading(true); setError('');
                const { data, error } = await sb.auth.signInWithPassword({ email, password });
                if (error) setError("GiriÅŸ baÅŸarÄ±sÄ±z: " + error.message);
                setLoading(false);
            };

            const handleRegister = async (e) => {
                e.preventDefault(); setLoading(true); setError('');
                
                // Shift Key Logic
                const isLocalhost = window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1';
                const forceTest = e && e.shiftKey;
                const targetUrl = forceTest ? N8N_REGISTER_WEBHOOK : (isLocalhost ? N8N_REGISTER_WEBHOOK : N8N_REGISTER_WEBHOOK); // Currently only one webhook defined, but logic ready for split

                const payload = {
                    "telegram_id": "",
                    "AdÄ±nÄ±z": regData.first_name,
                    "SoyadÄ±nÄ±z": regData.last_name,
                    "Mail Adresiniz": regData.email,
                    "Telefon NumaranÄ±z": regData.phone,
                    "Åirketiniz": regData.company_name,
                    "Vergi Dairesi": regData.tax_office,
                    "Vergi NumarasÄ±": regData.tax_no,
                    "password": regData.password 
                };

                // 1. Supabase'e KullanÄ±cÄ± OluÅŸturma Ä°steÄŸi (Webhook ile)
                try {
                    await fetch(targetUrl, {
                        method: 'POST',
                        mode: 'no-cors',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });
                    
                    setInfo("âœ… KayÄ±t talebiniz alÄ±ndÄ±! YÃ¶netici onayÄ±ndan sonra giriÅŸ yapabileceksiniz.");
                    setView('login'); // GiriÅŸ ekranÄ±na dÃ¶n
                } catch (e) {
                    setError("KayÄ±t hatasÄ±: " + e.message);
                }
                setLoading(false);
            };

            const handleReset = async (e) => {
                e.preventDefault(); setLoading(true); setError(''); setInfo('');
                
                // --- ÅÄ°FRE SIFIRLAMA WEBHOOK MANTIÄI ---
                // VarsayÄ±lan: Localhost ise Test, Sunucu ise Prod
                const isLocalhost = window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1';
                
                // SHIFT TUÅU KONTROLÃœ
                const forceTest = e && e.shiftKey;
                
                let targetUrl;
                if (forceTest) {
                    targetUrl = N8N_RESET_PW_WEBHOOK_TEST;
                    console.log("ğŸ› ï¸ Shift tuÅŸuna basÄ±ldÄ±: TEST Webhook zorlandÄ± (Åifre SÄ±fÄ±rlama).");
                } else {
                    targetUrl = isLocalhost ? N8N_RESET_PW_WEBHOOK_TEST : N8N_RESET_PW_WEBHOOK_PROD;
                }

                // Konsola detaylÄ± bilgi yaz
                console.log(`ğŸš€ Åifre SÄ±fÄ±rlama Hedef: ${forceTest || isLocalhost ? 'TEST' : 'CANLI'}`);
                console.log("ğŸ”— URL:", targetUrl);

                try {
                    await fetch(targetUrl, { 
                        method: 'POST', 
                        mode: 'no-cors', 
                        headers: {'Content-Type':'application/json'}, 
                        body: JSON.stringify({ 
                            email: email,
                            source: 'FisMatik_Login_Reset'
                        }) 
                    });
                    
                    const envMsg = forceTest ? "(TEST ORTAMI)" : "";
                    setInfo(`âœ… E-posta adresiniz sistemde kayÄ±tlÄ±ysa, ÅŸifre sÄ±fÄ±rlama talimatlarÄ± gÃ¶nderilmiÅŸtir. ${envMsg}`); 
                } catch (e) { 
                    console.error(e);
                    setError("BaÄŸlantÄ± hatasÄ±. LÃ¼tfen tekrar deneyin."); 
                }
                setLoading(false);
            };

            return (
                <div className="min-h-screen flex items-center justify-center p-4 bg-slate-50">
                    <div className="glass-panel p-8 rounded-2xl shadow-xl w-full max-w-sm animate-in fade-in zoom-in duration-300">
                        {view === 'login' && (
                            <>
                                <div className="flex justify-center mb-4 text-primary"><Icon name="receipt" size={48} /></div>
                                <h1 className="text-2xl font-bold text-center text-slate-800 mb-2">FiÅŸMatik</h1>
                                <p className="text-center text-slate-500 text-sm mb-6">AkÄ±llÄ± MÃ¼ÅŸteri Paneline GiriÅŸ</p>
                                <form onSubmit={handleLogin} className="space-y-4">
                                    <input type="email" placeholder="E-Posta" value={email} onChange={e=>setEmail(e.target.value)} className="w-full p-3 border rounded-lg" required />
                                    <input type="password" placeholder="Åifre" value={password} onChange={e=>setPassword(e.target.value)} className="w-full p-3 border rounded-lg" required />
                                    {info && <div className="p-3 bg-green-50 text-green-700 text-xs rounded border border-green-100">{info}</div>}
                                    {error && <p className="text-red-500 text-xs">{error}</p>}
                                    <button disabled={loading} className="w-full bg-primary text-white py-3 rounded-lg">{loading ? <Icon name="loader-2" className="loading-spin"/> : 'GiriÅŸ Yap'}</button>
                                    <div className="flex flex-col gap-2 mt-4 text-center">
                                        <button type="button" onClick={()=>setView('forgot')} className="text-xs text-slate-500 hover:text-primary">Åifremi Unuttum</button>
                                        <div className="flex justify-between mt-2">
                                            <button type="button" onClick={()=>setView('register')} className="text-sm text-primary font-bold hover:underline">KayÄ±t Ol</button>
                                            <button type="button" onClick={()=>setView('about')} className="text-sm text-slate-600 hover:underline">FiÅŸMatik Nedir?</button>
                                        </div>
                                    </div>
                                </form>
                            </>
                        )}
                        
                        {view === 'register' && (
                            <>
                                <div className="flex justify-center mb-4 text-purple-600"><Icon name="user-plus" size={48} /></div>
                                <h2 className="text-xl font-bold text-center mb-4">Yeni Hesap OluÅŸtur</h2>
                                <form onSubmit={handleRegister} className="space-y-3">
                                    <div className="flex gap-2">
                                        <input type="text" placeholder="AdÄ±nÄ±z" className="w-1/2 p-3 border rounded-lg text-sm" value={regData.first_name} onChange={e=>setRegData({...regData, first_name:e.target.value})} required />
                                        <input type="text" placeholder="SoyadÄ±nÄ±z" className="w-1/2 p-3 border rounded-lg text-sm" value={regData.last_name} onChange={e=>setRegData({...regData, last_name:e.target.value})} required />
                                    </div>
                                    <input type="email" placeholder="E-Posta" className="w-full p-3 border rounded-lg text-sm" value={regData.email} onChange={e=>setRegData({...regData, email:e.target.value})} required />
                                    <input type="text" placeholder="Telefon (5XX...)" className="w-full p-3 border rounded-lg text-sm" value={regData.phone} onChange={e=>setRegData({...regData, phone:e.target.value})} required />
                                    
                                    <input type="text" placeholder="Åirket AdÄ±" className="w-full p-3 border rounded-lg text-sm mt-4" value={regData.company_name} onChange={e=>setRegData({...regData, company_name:e.target.value})} required />
                                    <div className="flex gap-2">
                                        <input type="text" placeholder="Vergi Dairesi" className="w-1/2 p-3 border rounded-lg text-sm" value={regData.tax_office} onChange={e=>setRegData({...regData, tax_office:e.target.value})} required />
                                        <input type="text" placeholder="Vergi No / T.C." className="w-1/2 p-3 border rounded-lg text-sm" value={regData.tax_no} onChange={e=>setRegData({...regData, tax_no:e.target.value})} required />
                                    </div>
                                    
                                    <input type="password" placeholder="Åifre Belirleyin" className="w-full p-3 border rounded-lg text-sm mt-2" value={regData.password} onChange={e=>setRegData({...regData, password:e.target.value})} required />
                                    
                                    {error && <p className="text-red-500 text-xs">{error}</p>}
                                    <button disabled={loading} className="w-full bg-purple-600 text-white py-3 rounded-lg hover:bg-purple-700 transition">{loading ? <Icon name="loader-2" className="loading-spin"/> : 'KayÄ±t Ol ve Onaya GÃ¶nder'}</button>
                                    <button type="button" onClick={()=>setView('login')} className="w-full text-slate-500 text-sm mt-2">GiriÅŸe DÃ¶n</button>
                                </form>
                            </>
                        )}

                        {view === 'forgot' && (
                            <form onSubmit={handleReset} className="space-y-4">
                                <h3 className="text-center font-bold">Åifre SÄ±fÄ±rlama</h3>
                                <input type="email" placeholder="E-Posta" value={email} onChange={e=>setEmail(e.target.value)} className="w-full p-3 border rounded-lg" required />
                                <button disabled={loading} className="w-full bg-primary text-white py-3 rounded-lg">Link GÃ¶nder</button>
                                <button type="button" onClick={()=>setView('login')} className="w-full text-slate-500 text-sm">Ä°ptal</button>
                            </form>
                        )}
                        
                        {view === 'about' && (
                            <div className="text-left">
                                <div className="flex items-center gap-2 mb-4 text-primary">
                                    <button onClick={()=>setView('login')} className="p-1 hover:bg-blue-50 rounded-full"><Icon name="arrow-left" size={20} /></button>
                                    <span className="font-bold text-lg">HakkÄ±mÄ±zda</span>
                                </div>
                                <div className="max-h-[60vh] overflow-y-auto pr-2 space-y-6 custom-scrollbar"><AboutContent /></div>
                            </div>
                        )}
                    </div>
                </div>
            );
        };

        // --- DASHBOARD (ANA BÄ°LEÅEN) ---
        const Dashboard = ({ user, profile, supabase, onLogout }) => {
            const [view, setView] = useState('dashboard');
            const [receipts, setReceipts] = useState([]);
            const [loading, setLoading] = useState(true);
            const [stats, setStats] = useState({ total:0, count:0, pending:0 });
            const [aiAnalysis, setAiAnalysis] = useState(null);
            const [aiLoading, setAiLoading] = useState(false);

            // Veri Ã‡ekme - Hata YÃ¶netimi ve Profil/KullanÄ±cÄ± KontrolÃ¼
            const fetchData = useCallback(async () => {
                if(!user?.id) {
                    console.log("KullanÄ±cÄ± ID yok, veri Ã§ekilmiyor");
                    setLoading(false);
                    return;
                }
                
                setLoading(true);
                try {
                    console.log("Veri Ã§ekiliyor...", { userId: user.id, companyId: profile?.company_id });
                    let q = sb.from('fisler').select('*').order('tarih', { ascending: false });
                    
                    if (profile?.company_id) {
                        q = q.eq('company_id', profile.company_id);
                        console.log("Åirket bazlÄ± sorgu:", profile.company_id);
                    } else {
                        q = q.eq('user_id', user.id);
                        console.log("KullanÄ±cÄ± bazlÄ± sorgu:", user.id);
                    }

                    const { data, error } = await q;

                    if (error) {
                        console.error("Veri Ã§ekme hatasÄ±:", error);
                        setReceipts([]);
                        setStats({ total: 0, count: 0, pending: 0 });
                    } else {
                        console.log("Gelen FiÅŸler:", data?.length || 0, "adet");
                        setReceipts(data || []);
                        const total = (data||[]).reduce((a,b)=>a+(b.toplam_tutar||0),0);
                        const pending = (data||[]).filter(r=>r.durum==='beklemede').length;
                        setStats({ total, count: (data||[]).length, pending });
                    }
                } catch(e) { 
                    console.error("Beklenmeyen hata:", e);
                    setReceipts([]);
                    setStats({ total: 0, count: 0, pending: 0 });
                } finally {
                    setLoading(false);
                }
            }, [user?.id, profile?.company_id]);

            // Yerel (Optimistic) GÃ¼ncelleme
            const handleLocalUpdate = (updatedItem) => {
                setReceipts(prev => prev.map(r => r.id === updatedItem.id ? updatedItem : r));
            };

            const runAiAnalysis = async () => {
                const apiKey = localStorage.getItem('gemini_key');
                if(!apiKey) return alert("API AnahtarÄ± eksik.");
                setAiLoading(true);
                const data = { total: stats.total, count: stats.count, recent: receipts.slice(0,10) };
                const prompt = `Analiz et: ${JSON.stringify(data)}. TÃ¼rkÃ§e, Markdown.`;
                try {
                    const res = await callGemini(apiKey, prompt);
                    setAiAnalysis(res);
                } catch(e) { alert(e.message); }
                setAiLoading(false);
            };

            useEffect(() => { fetchData(); }, [fetchData]);
            useEffect(() => { lucide.createIcons(); }, [view, receipts, aiAnalysis]);

            return (
                <div className="min-h-screen flex flex-col md:flex-row">
                    <aside className="w-full md:w-64 bg-white border-r border-slate-200 flex flex-col z-20">
                        <div className="p-6 flex items-center gap-2 border-b border-slate-100"><Icon name="receipt" className="text-primary" /><span className="font-bold text-lg text-slate-800">FiÅŸMatik</span></div>
                        <nav className="flex-1 p-4 space-y-1">
                            {['dashboard','receipts','reports','team','settings','about'].map(v => {
                                // Ekip yÃ¶netimi sadece admin iÃ§in
                                if (v === 'team' && profile?.role !== 'admin') return null;
                                return (
                                    <button key={v} onClick={()=>setView(v)} className={`w-full flex items-center gap-3 px-4 py-3 rounded-lg text-sm font-medium transition ${view===v?'bg-blue-50 text-primary':'text-slate-600 hover:bg-slate-50'}`}>
                                        <Icon name={v==='dashboard'?'layout-dashboard':v==='receipts'?'file-text':v==='reports'?'bar-chart-3':v==='team'?'users':v==='settings'?'settings':'info'} size={18}/> 
                                        {v==='dashboard'?'Genel BakÄ±ÅŸ':v==='receipts'?'FiÅŸlerim':v==='reports'?'Raporlar':v==='team'?'Ekip YÃ¶netimi':v==='settings'?'Ayarlar':'HakkÄ±nda'}
                                    </button>
                                )
                            })}
                        </nav>
                        <div className="p-4 border-t"><div className="mb-4 text-xs text-slate-500"><p className="font-bold text-slate-800 truncate">{profile?.full_name || user.email}</p><p>Rol: {profile?.role || 'User'}</p></div><button onClick={onLogout} className="w-full flex items-center gap-2 text-red-500 text-sm hover:bg-red-50 p-2 rounded transition"><Icon name="log-out" size={16}/> Ã‡Ä±kÄ±ÅŸ</button></div>
                    </aside>
                    <main className="flex-1 p-4 md:p-8 overflow-y-auto h-screen bg-slate-50">
                        {view==='dashboard' && (
                            <div className="space-y-6">
                                <div className="flex justify-between items-center"><h2 className="text-2xl font-bold">HoÅŸ Geldiniz</h2><button onClick={runAiAnalysis} disabled={aiLoading} className="px-4 py-2 bg-gradient-to-r from-violet-600 to-indigo-600 text-white rounded shadow flex gap-2 items-center">{aiLoading?<Icon name="loader-2" className="loading-spin"/>:<Icon name="sparkles"/>} Analiz</button></div>
                                {aiAnalysis && <div className="bg-white p-6 rounded border border-violet-100 shadow ai-glow relative"><div className="text-sm markdown-body" dangerouslySetInnerHTML={{__html:marked.parse(aiAnalysis)}}></div><button onClick={()=>setAiAnalysis(null)} className="absolute top-4 right-4"><Icon name="x"/></button></div>}
                                <div className="grid grid-cols-1 md:grid-cols-3 gap-6">
                                    <StatCard title="Toplam Harcama" value={stats.total.toLocaleString('tr-TR',{style:'currency',currency:'TRY'})} icon="wallet" color="text-green-600" bg="bg-green-50"/>
                                    <StatCard title="Toplam FiÅŸ" value={stats.count} icon="file-stack" color="text-blue-600" bg="bg-blue-50"/>
                                    <StatCard title="Bekleyen" value={stats.pending} icon="clock" color="text-orange-600" bg="bg-orange-50"/>
                                </div>
                                <div className="bg-white p-6 rounded border shadow-sm"><h3 className="font-bold mb-4">Son Hareketler</h3><ReceiptsTable receipts={receipts.slice(0,5)} loading={loading} simple={true} /></div>
                            </div>
                        )}
                        {view==='receipts' && <div className="bg-white rounded border shadow-sm p-4 h-full flex flex-col"><div className="flex justify-between mb-4"><h2 className="text-xl font-bold">FiÅŸ KayÄ±tlarÄ±</h2><button onClick={fetchData}><Icon name="refresh-ccw"/></button></div><ReceiptsTable receipts={receipts} loading={loading} supabase={sb} refresh={fetchData} onLocalUpdate={handleLocalUpdate} userRole={profile?.role} /></div>}
                        {view==='reports' && <div className="max-w-xl mx-auto mt-10"><ReportCard user={user} profile={profile}/></div>}
                        {view==='team' && <div className="max-w-4xl mx-auto mt-5"><TeamManagement user={user} profile={profile} /></div>}
                        {view==='settings' && <Settings />}
                        {view==='about' && <div className="max-w-3xl mx-auto bg-white p-8 rounded-xl border border-slate-200 shadow-sm animate-in fade-in zoom-in duration-300"><div className="text-center mb-8 border-b border-slate-100 pb-6"><h2 className="text-2xl font-bold text-slate-800">HakkÄ±mÄ±zda</h2></div><AboutContent /></div>}
                    </main>
                </div>
            );
        };

        // --- APP ---
        const App = () => {
            const [user, setUser] = useState(null);
            const [profile, setProfile] = useState(null);
            const [pendingApproval, setPendingApproval] = useState(false);

            const fetchProfile = useCallback(async (u) => {
                if(!u?.id) return;
                
                try {
                    console.log("Profil YÃ¼kleniyor...", u.id);
                    let { data, error } = await sb.from('users').select('*').eq('id', u.id).limit(1);
                    
                    if(error || !data || data.length === 0) {
                        // ID ile bulunamazsa email ile dene
                        console.log("Profil ID ile bulunamadÄ±, email ile deneniyor...", u.email);
                        const res = await sb.from('users').select('*').eq('email', u.email).limit(1);
                        if(res.data && res.data.length > 0) {
                            data = res.data;
                            error = res.error;
                        }
                    }

                    if(data && data.length > 0) {
                        const userProfile = data[0];
                        console.log("Profil Bulundu:", userProfile);
                        
                        // ONAY KONTROLÃœ
                        if (userProfile.status === 'pending' || userProfile.status === 'beklemede') {
                            setPendingApproval(true);
                            setProfile(userProfile); 
                        } else {
                            setPendingApproval(false);
                            setProfile(userProfile);
                        }
                    } else {
                        console.warn("Profil bulunamadÄ± (public.users tablosunda kayÄ±t yok)");
                        setProfile(null);
                    }
                } catch(e) { 
                    console.error("Profil Fetch Exception:", e);
                    setProfile(null);
                }
            }, []);

            useEffect(() => {
                let mounted = true;
                
                // Ä°lk yÃ¼klemede mevcut oturumu kontrol et
                sb.auth.getUser().then(({data}) => {
                    if(mounted && data?.user) {
                        setUser(data.user);
                        fetchProfile(data.user);
                    }
                });
                
                // Oturum deÄŸiÅŸikliklerini dinle
                const { data: { subscription } } = sb.auth.onAuthStateChange((_, session) => { 
                    if(!mounted) return;
                    if(session?.user) { 
                        setUser(session.user); 
                        fetchProfile(session.user); 
                    } else { 
                        setUser(null); 
                        setProfile(null); 
                        setPendingApproval(false); 
                    }
                });
                
                return () => { 
                    mounted = false; 
                    if(subscription) subscription.unsubscribe(); 
                };
            }, [fetchProfile]);

            if(!user) return <Login onLogin={()=>{}} />;

            // ONAY BEKLEME EKRANI
            if (pendingApproval) {
                return (
                    <div className="min-h-screen flex items-center justify-center bg-slate-50 p-4">
                        <div className="bg-white p-8 rounded-xl shadow-xl max-w-md text-center border-t-4 border-yellow-400">
                            <div className="inline-block p-4 bg-yellow-50 rounded-full text-yellow-600 mb-4"><Icon name="clock" size={40} /></div>
                            <h2 className="text-2xl font-bold text-slate-800 mb-2">Onay Bekleniyor</h2>
                            <p className="text-slate-600 mb-6">HesabÄ±nÄ±z oluÅŸturuldu ancak yÃ¶netici onayÄ± bekleniyor. OnaylandÄ±ÄŸÄ±nda size e-posta ile bilgi verilecektir.</p>
                            <button onClick={()=>sb.auth.signOut()} className="text-slate-500 hover:text-slate-800 underline">Ã‡Ä±kÄ±ÅŸ Yap</button>
                        </div>
                    </div>
                );
            }

            return <Dashboard user={user} profile={profile} onLogout={()=>sb.auth.signOut()} supabase={sb} />;
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>